<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbitly Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2b2d31; }
        ::-webkit-scrollbar-thumb { background: #1a1b1e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f4147; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5865F2;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast-enter { animation: toastIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast-exit { animation: toastOut 0.3s ease-in forwards; }

        @keyframes toastIn {
            from { transform: translate(-50%, 50px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes toastOut {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 50px); opacity: 0; }
        }

        /* Status colors */
        .status-online { background-color: #23a559; }
        .status-busy { background-color: #f0b232; }
        .status-dnd { background-color: #f23f43; }
        .status-offline { background-color: #80848e; }
        .status-invisible { background-color: #80848e; }

        /* Profile Modal Gradient */
        .profile-header { background: linear-gradient(135deg, #5865F2, #9b59b6); }

        /* Markdown Styles */
        .md-bold { font-weight: 700; color: #fff; }
        .md-italic { font-style: italic; }
        .md-code { background: #2f3136; padding: 1px 4px; border-radius: 3px; font-family: monospace; color: #e83e8c; font-size: 0.9em; }
        .md-mention { color: #dee0fc; background: rgba(88, 101, 242, 0.3); padding: 0 2px; border-radius: 3px; font-weight: 500; }
    </style>
</head>
<body class="bg-[#313338] text-gray-100 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- Auth View -->
    <div id="auth-view" class="flex-1 flex flex-col justify-center items-center p-4 bg-[url('https://picsum.photos/1920/1080?blur=10')] bg-cover bg-center relative z-50">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm"></div>
        
        <div class="relative w-full max-w-md bg-[#2b2d31] rounded-lg shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Welcome back!</h2>
                    <p class="text-gray-400 text-sm">We're so excited to see you again!</p>
                </div>

                <!-- Toggle -->
                <div class="flex bg-[#1e1f22] p-1 rounded mb-6">
                    <button id="tab-login" class="flex-1 py-1 text-sm font-medium rounded text-white bg-[#5865F2]" onclick="app.switchTab('login')">Login</button>
                    <button id="tab-signup" class="flex-1 py-1 text-sm font-medium rounded text-gray-400 hover:text-gray-200" onclick="app.switchTab('signup')">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Email</label>
                        <input type="email" id="login-email" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded focus:ring-0 text-white transition-all">
                    </div>
                    <div>
                        <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Password</label>
                        <input type="password" id="login-password" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded focus:ring-0 text-white transition-all">
                    </div>
                    <button type="submit" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-medium py-2.5 rounded transition">Log In</button>
                </form>

                <!-- Signup Form -->
                <form id="signup-form" class="space-y-4 hidden">
                    <!-- PFP Upload -->
                    <div class="flex justify-center mb-4">
                        <div class="w-24 h-24 rounded-full bg-[#1e1f22] relative group cursor-pointer hover:opacity-80 transition" onclick="document.getElementById('signup-pfp').click()">
                            <img id="pfp-preview" src="" class="w-full h-full rounded-full object-cover hidden">
                            <div id="pfp-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs text-center p-2">
                                Upload PFP (Static only)
                            </div>
                            <div class="absolute bottom-0 right-0 bg-[#5865F2] rounded-full p-1 border-4 border-[#2b2d31]">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </div>
                        </div>
                        <input type="file" id="signup-pfp" accept="image/*" class="hidden">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Username</label>
                            <input type="text" id="signup-username" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white">
                        </div>
                        <div>
                            <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Email</label>
                            <input type="email" id="signup-email" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Age</label>
                            <input type="number" id="signup-age" min="11" max="1000" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white">
                        </div>
                        <div>
                            <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Gender</label>
                            <select id="signup-gender" class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white appearance-none">
                                <option value="Alien">Alien</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Table">Table</option>
                                <option value="Chair">Chair</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Password</label>
                        <input type="password" id="signup-password" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white">
                    </div>
                    <button type="submit" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-medium py-2.5 rounded transition">Continue</button>
                </form>

                <div id="auth-feedback" class="mt-4 text-center hidden">
                    <p id="auth-error" class="text-red-400 text-xs"></p>
                </div>
                <div id="auth-loader" class="hidden flex justify-center mt-4"><div class="loader"></div></div>
            </div>
        </div>
    </div>

    <!-- Main Application View -->
    <div id="chat-view" class="hidden h-full w-full relative">
        
        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col min-w-0 bg-[#313338]">
            <!-- Header -->
            <header class="bg-[#313338] border-b border-[#26272d] p-3 shadow-sm flex justify-between items-center h-16 shrink-0 z-10">
                <div class="flex items-center gap-2 px-2">
                    <img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExMXBhNjNycTQweDFkY214NjMxYWtiZWs1ZjZ3dTJxb254d21ldHIyOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/HPbuRgMPF2vL2/giphy.gif" alt="Logo" class="h-10 object-contain">
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Wallet Button -->
                    <button onclick="app.openWallet()" class="text-gray-400 hover:text-yellow-400 transition" title="My Wallet">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                    </button>

                    <!-- User Profile & Status -->
                    <div class="flex items-center gap-3 bg-[#2b2d31] py-1.5 px-3 rounded hover:bg-[#35373c] transition relative group">
                        
                        <!-- Avatar: Click to Open Profile -->
                        <div class="relative cursor-pointer hover:opacity-80 transition" onclick="app.openMyProfile()">
                            <img id="current-user-pfp" src="" class="w-8 h-8 rounded-full bg-gray-700 object-cover">
                            <div id="current-user-status-dot" class="absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-[3px] border-[#2b2d31] status-online"></div>
                        </div>

                        <!-- Name/Status: Click to Open Dropdown -->
                        <div class="flex flex-col cursor-pointer" onclick="document.getElementById('status-dropdown').classList.toggle('hidden')">
                            <span id="current-username" class="text-sm font-semibold text-white leading-tight">User</span>
                            <span id="current-status-text" class="text-[10px] text-gray-400 leading-tight">Online</span>
                        </div>

                        <!-- Status Dropdown -->
                        <div id="status-dropdown" class="hidden absolute top-full right-0 mt-2 w-48 bg-[#111214] rounded shadow-xl border border-[#1e1f22] overflow-hidden z-50">
                            <div class="p-2 space-y-1">
                                <button onclick="app.openMyProfile(); document.getElementById('status-dropdown').classList.add('hidden')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group mb-1 border-b border-gray-800 pb-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    My Profile
                                </button>
                                <button onclick="app.setStatus('online')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group">
                                    <div class="w-2.5 h-2.5 rounded-full status-online"></div> Online
                                </button>
                                <button onclick="app.setStatus('busy')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group">
                                    <div class="w-2.5 h-2.5 rounded-full status-busy"></div> Busy
                                </button>
                                <button onclick="app.setStatus('dnd')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group">
                                    <div class="w-2.5 h-2.5 rounded-full status-dnd"></div> Do Not Disturb
                                </button>
                                <button id="btn-invisible" onclick="app.setStatus('invisible')" class="hidden w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group border-t border-gray-800 mt-1 pt-2">
                                    <div class="w-2.5 h-2.5 rounded-full status-invisible border border-gray-500"></div> Invisible
                                </button>
                                <button onclick="app.logout()" class="w-full text-left px-2 py-1.5 rounded hover:bg-red-500 hover:text-white text-red-400 text-sm flex items-center gap-2 mt-1 border-t border-gray-800 pt-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                    Log Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Messages List -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-1 scroll-smooth">
                <!-- Messages injected here -->
            </div>

            <!-- Input Area -->
            <div class="px-4 pb-4 bg-[#313338]">
                <form id="message-form" class="bg-[#383a40] rounded-lg px-4 py-3 flex items-center w-full shadow-sm">
                    <input type="text" id="message-input" autocomplete="off" placeholder="Message #general-chat (Type /cmds for help)" class="flex-1 bg-transparent border-none text-gray-100 placeholder-gray-500 focus:ring-0 focus:outline-none">
                </form>
            </div>
        </div>

        <!-- Sidebar (Online Players) -->
        <div class="w-60 bg-[#2b2d31] flex flex-col shrink-0 border-l border-[#1e1f22]">
            <div class="p-4 border-b border-[#1e1f22] h-16 flex items-center justify-center">
                 <h2 class="font-bold text-gray-400 text-xs uppercase tracking-wide">Players</h2>
            </div>
            <div id="online-list" class="flex-1 overflow-y-auto p-3 space-y-0.5">
                <!-- Users injected here -->
            </div>
        </div>

        <!-- Wallet Modal -->
        <div id="wallet-modal" class="absolute inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-[#2b2d31] rounded-xl shadow-2xl p-6 w-80 transform transition-all scale-100 border border-[#1e1f22] relative">
                <button onclick="app.closeWallet()" class="absolute top-2 right-2 text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold text-white uppercase tracking-wider">My Wallet</h3>
                </div>
                <div class="space-y-4">
                    <div class="bg-[#1e1f22] p-4 rounded-lg flex justify-between items-center">
                        <span class="text-yellow-500 font-bold uppercase text-sm">Coins</span>
                        <span id="wallet-coins" class="text-white text-lg font-mono">0</span>
                    </div>
                    <div class="bg-[#1e1f22] p-4 rounded-lg flex justify-between items-center">
                        <span class="text-purple-400 font-bold uppercase text-sm">Gems</span>
                        <span id="wallet-gems" class="text-white text-lg font-mono">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div id="profile-modal" class="absolute inset-0 z-50 hidden bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-sm overflow-hidden border border-[#1e1f22] relative transform transition-all scale-100">
                <div class="h-24 profile-header relative">
                    <button onclick="app.closeProfile()" class="absolute top-2 right-2 text-white/80 hover:text-white bg-black/20 rounded-full p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="px-6 pb-6 relative">
                    <div class="relative -mt-12 mb-2 flex justify-between items-end">
                        <img id="profile-pfp" src="" class="w-24 h-24 rounded-full border-4 border-[#2b2d31] bg-[#2b2d31] object-cover">
                        <div class="flex gap-2">
                            <div class="bg-[#1e1f22] px-3 py-1 rounded text-xs font-bold text-yellow-400 border border-[#111214]" id="profile-rep">REP: 0</div>
                            <div class="bg-[#1e1f22] px-3 py-1 rounded text-xs font-bold text-gray-400 border border-[#111214]" id="profile-status-badge">ONLINE</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h3 id="profile-username" class="text-2xl font-bold text-white leading-tight"></h3>
                        <p id="profile-bio" class="text-xs text-gray-300 mt-1 italic opacity-80 line-clamp-2">No bio set.</p>
                        <p id="profile-joined" class="text-[10px] text-gray-500 mt-1">Joined Dec 2023</p>
                    </div>

                    <div class="bg-[#111214] rounded-lg p-3 border border-[#1e1f22] mb-4 grid grid-cols-2 gap-2">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase text-gray-500 font-bold">Age</span>
                            <span id="profile-age" class="text-sm text-gray-200"></span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase text-gray-500 font-bold">Gender</span>
                            <span id="profile-gender" class="text-sm text-gray-200"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-[#1e1f22] p-3 rounded-lg border border-[#111214] flex flex-col items-center">
                            <span class="text-yellow-500 font-bold text-lg" id="profile-coins">0</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">Coins</span>
                        </div>
                        <div class="bg-[#1e1f22] p-3 rounded-lg border border-[#111214] flex flex-col items-center">
                            <span class="text-purple-400 font-bold text-lg" id="profile-gems">0</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">Gems</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast-container" class="absolute bottom-20 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none"></div>

    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, where, getDocs, limit, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBz9yOlQFZQZE-GtGcRbJ2sWUYQTb0kBi4",
            authDomain: "orbitly-online.firebaseapp.com",
            projectId: "orbitly-online",
            storageBucket: "orbitly-online.firebasestorage.app",
            messagingSenderId: "75415636853",
            appId: "1:75415636853:web:ccf4ac9c74a1769335a13c",
            measurementId: "G-9B5458S73M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Abbreviation System ---
        const SUFFIXES = {
            'k': 1e3, 'm': 1e6, 'b': 1e9, 't': 1e12, 'qa': 1e15, 'qi': 1e18, 'sx': 1e21, 'sp': 1e24, 'oc': 1e27, 'no': 1e30,
            'dc': 1e33, 'ud': 1e36, 'dd': 1e39, 'td': 1e42, 'qad': 1e45, 'qid': 1e48, 'sxd': 1e51, 'spd': 1e54, 'ocd': 1e57, 'nod': 1e60,
            'vg': 1e63, 'uvg': 1e66, 'dvg': 1e69, 'tvg': 1e72, 'qavg': 1e75, 'qivg': 1e78, 'sxvg': 1e81, 'spvg': 1e84, 'ocvg': 1e87, 'novg': 1e90,
            'tg': 1e93, 'utg': 1e96, 'dtg': 1e99, 'ttg': 1e102, 'qatg': 1e105, 'qitg': 1e108, 'sxtg': 1e111, 'sptg': 1e114, 'octg': 1e117, 'notg': 1e120,
            'qg': 1e123, 'uqg': 1e126, 'dqg': 1e129, 'tqg': 1e132, 'qaqg': 1e135, 'qiqg': 1e138, 'sxqg': 1e141, 'spqg': 1e144, 'ocqg': 1e147, 'noqg': 1e150
        };

        function parseAbbreviatedNumber(input) {
            if (!input) return NaN;
            input = input.toLowerCase().replace(/,/g, ''); 
            if (input === 'all') return 'all';
            const sortedSuffixes = Object.keys(SUFFIXES).sort((a, b) => b.length - a.length);
            for (const suffix of sortedSuffixes) {
                if (input.endsWith(suffix)) {
                    const numPart = input.slice(0, -suffix.length);
                    const val = parseFloat(numPart);
                    if (isNaN(val)) return NaN;
                    return Math.floor(val * SUFFIXES[suffix]);
                }
            }
            return Math.floor(parseFloat(input));
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num < 1000) return num.toLocaleString();
            const sortedSuffixes = Object.entries(SUFFIXES).sort((a, b) => b[1] - a[1]);
            for (const [suffix, val] of sortedSuffixes) {
                if (num >= val) {
                    return (num / val).toFixed(1).replace(/\.0$/, '') + suffix;
                }
            }
            return num.toLocaleString();
        }

        // State
        let currentUser = null;
        let currentUserProfile = null;
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;

        // Elements
        const els = {
            authView: document.getElementById('auth-view'),
            chatView: document.getElementById('chat-view'),
            forms: { login: document.getElementById('login-form'), signup: document.getElementById('signup-form') },
            tabs: { login: document.getElementById('tab-login'), signup: document.getElementById('tab-signup') },
            inputs: { signupPfp: document.getElementById('signup-pfp'), msg: document.getElementById('message-input') },
            displays: {
                pfpPreview: document.getElementById('pfp-preview'),
                pfpPlaceholder: document.getElementById('pfp-placeholder'),
                error: document.getElementById('auth-error'),
                loader: document.getElementById('auth-loader'),
                feedback: document.getElementById('auth-feedback'),
                msgContainer: document.getElementById('messages-container'),
                onlineList: document.getElementById('online-list'),
                
                headerPfp: document.getElementById('current-user-pfp'),
                headerName: document.getElementById('current-username'),
                headerStatusText: document.getElementById('current-status-text'),
                headerStatusDot: document.getElementById('current-user-status-dot'),
                statusDropdown: document.getElementById('status-dropdown'),
                invisibleBtn: document.getElementById('btn-invisible'),
                walletModal: document.getElementById('wallet-modal'),
                walletCoins: document.getElementById('wallet-coins'),
                walletGems: document.getElementById('wallet-gems'),
                profileModal: document.getElementById('profile-modal'),
                toastContainer: document.getElementById('toast-container')
            }
        };

        // --- Core Functions ---

        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 150; 
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        function processText(text) {
            if (!text) return '';
            let processed = escapeHtml(text);
            // Markdown: Bold, Italic, Code
            processed = processed.replace(/\*\*(.*?)\*\*/g, '<span class="md-bold">$1</span>');
            processed = processed.replace(/\*(.*?)\*/g, '<span class="md-italic">$1</span>');
            processed = processed.replace(/`(.*?)`/g, '<span class="md-code">$1</span>');
            // Mentions
            processed = processed.replace(/@(\w+)/g, '<span class="md-mention">@$1</span>');
            return processed;
        }

        // Global App Methods
        window.app = {
            switchTab: (tab) => {
                els.displays.feedback.classList.add('hidden');
                if (tab === 'login') {
                    els.forms.login.classList.remove('hidden');
                    els.forms.signup.classList.add('hidden');
                    els.tabs.login.className = "flex-1 py-1 text-sm font-medium rounded text-white bg-[#5865F2] transition";
                    els.tabs.signup.className = "flex-1 py-1 text-sm font-medium rounded text-gray-400 hover:text-gray-200 transition";
                } else {
                    els.forms.login.classList.add('hidden');
                    els.forms.signup.classList.remove('hidden');
                    els.tabs.signup.className = "flex-1 py-1 text-sm font-medium rounded text-white bg-[#5865F2] transition";
                    els.tabs.login.className = "flex-1 py-1 text-sm font-medium rounded text-gray-400 hover:text-gray-200 transition";
                }
            },
            logout: () => {
                if (currentUser && currentUserProfile && currentUserProfile.status !== 'invisible') {
                     updateDoc(doc(db, "users", currentUser.uid), { status: 'offline' }).then(() => signOut(auth));
                } else {
                    signOut(auth);
                }
            },
            setStatus: async (status) => {
                if (!currentUser) return;
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { status: status });
                    els.displays.statusDropdown.classList.add('hidden');
                } catch (e) {
                    console.error("Status update failed", e);
                }
            },
            openWallet: () => {
                if (currentUserProfile) {
                    els.displays.walletCoins.textContent = formatNumber(currentUserProfile.coins || 0);
                    els.displays.walletGems.textContent = formatNumber(currentUserProfile.gems || 0);
                }
                els.displays.walletModal.classList.remove('hidden');
            },
            closeWallet: () => {
                els.displays.walletModal.classList.add('hidden');
            },
            openProfile: async (uid) => {
                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(snap.exists()) {
                        const data = snap.data();
                        document.getElementById('profile-pfp').src = data.pfpUrl || 'https://ui-avatars.com/api/?name=?';
                        document.getElementById('profile-username').textContent = data.username;
                        document.getElementById('profile-age').textContent = data.age || 'N/A';
                        document.getElementById('profile-gender').textContent = data.gender || 'N/A';
                        document.getElementById('profile-coins').textContent = formatNumber(data.coins || 0);
                        document.getElementById('profile-gems').textContent = formatNumber(data.gems || 0);
                        document.getElementById('profile-bio').textContent = data.bio || 'No bio set.';
                        document.getElementById('profile-rep').textContent = `REP: ${formatNumber(data.rep || 0)}`;
                        
                        const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
                        document.getElementById('profile-joined').textContent = `Joined ${date}`;
                        
                        const status = (data.status || 'offline').toUpperCase();
                        const badge = document.getElementById('profile-status-badge');
                        badge.textContent = status;
                        
                        els.displays.profileModal.classList.remove('hidden');
                    }
                } catch(e) { console.error(e); }
            },
            openMyProfile: () => {
                if(currentUser) app.openProfile(currentUser.uid);
            },
            closeProfile: () => {
                els.displays.profileModal.classList.add('hidden');
            }
        };

        // --- Toast System ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-green-500/90' : 'bg-red-500/90';
            toast.className = `px-6 py-2 rounded-full text-white font-bold shadow-lg mb-2 text-sm text-center toast-enter backdrop-blur-md ${bgClass}`;
            toast.textContent = message;
            
            els.displays.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // --- Event Listeners ---

        document.addEventListener('click', (e) => {
            const dropdown = els.displays.statusDropdown;
            const trigger = document.getElementById('user-menu-trigger'); 
            if (!dropdown.contains(e.target) && !trigger?.contains(e.target)) {
                 dropdown.classList.add('hidden');
            }
            if (e.target === els.displays.walletModal) app.closeWallet();
            if (e.target === els.displays.profileModal) app.closeProfile();
        });

        els.inputs.signupPfp.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    els.displays.pfpPreview.src = ev.target.result;
                    els.displays.pfpPreview.classList.remove('hidden');
                    els.displays.pfpPlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Auth Handlers ---

        els.forms.signup.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const age = parseInt(document.getElementById('signup-age').value);
            const gender = document.getElementById('signup-gender').value;
            const pfpFile = els.inputs.signupPfp.files[0];

            if (age < 11 || age > 1000) return showError("Age must be between 11 and 1000.");
            
            toggleLoading(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                let pfpUrl = `https://ui-avatars.com/api/?name=${username}&background=random`;
                if (pfpFile) {
                    try { pfpUrl = await processImage(pfpFile); } catch (e) {}
                }

                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    username,
                    email,
                    age,
                    gender,
                    pfpUrl,
                    status: 'online', 
                    coins: 1000,
                    gems: 10,
                    rep: 0,
                    bio: '',
                    nameColor: '#ffffff',
                    lastDaily: 0,
                    lastWork: 0,
                    lastCrime: 0,
                    lastRob: 0,
                    lastBeg: 0,
                    lastRep: 0,
                    createdAt: serverTimestamp()
                });

                try { await updateProfile(user, { displayName: username }); } catch(e){}

            } catch (err) {
                showError(err.message);
            } finally {
                toggleLoading(false);
            }
        });

        els.forms.login.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            toggleLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                showError(err.message);
            } finally {
                toggleLoading(false);
            }
        });

        // --- Main App Logic ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const docRef = doc(db, "users", user.uid);
                    
                    onSnapshot(docRef, (docSnap) => {
                         if (docSnap.exists()) {
                            currentUserProfile = docSnap.data();
                            if (currentUserProfile.coins === undefined) updateDoc(docRef, {coins: 1000});
                            if (currentUserProfile.gems === undefined) updateDoc(docRef, {gems: 10});

                            const s = currentUserProfile.status || 'online';
                            els.displays.headerStatusText.textContent = s.charAt(0).toUpperCase() + s.slice(1);
                            
                            els.displays.headerStatusDot.className = "absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-[3px] border-[#2b2d31]";
                            if (s === 'online') els.displays.headerStatusDot.classList.add('status-online');
                            else if (s === 'busy') els.displays.headerStatusDot.classList.add('status-busy');
                            else if (s === 'dnd') els.displays.headerStatusDot.classList.add('status-dnd');
                            else els.displays.headerStatusDot.classList.add('status-offline');

                            if (!els.displays.walletModal.classList.contains('hidden')) {
                                els.displays.walletCoins.textContent = formatNumber(currentUserProfile.coins || 0);
                                els.displays.walletGems.textContent = formatNumber(currentUserProfile.gems || 0);
                            }
                        }
                    });

                    const initSnap = await getDoc(docRef);
                    if (initSnap.exists()) {
                        const data = initSnap.data();
                        if (data.status === 'offline') await updateDoc(docRef, { status: 'online' });
                    }
                    
                } catch (e) { console.error(e); }

                renderHeader();
                
                if (user.email === 'dev@gmail.com') els.displays.invisibleBtn.classList.remove('hidden');
                else els.displays.invisibleBtn.classList.add('hidden');

                els.authView.classList.add('hidden');
                els.chatView.classList.remove('hidden');
                els.chatView.classList.add('flex');
                
                startChatListener();
                startUsersListener();
            } else {
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeUsers) unsubscribeUsers();
                currentUser = null;
                currentUserProfile = null;
                els.chatView.classList.add('hidden');
                els.chatView.classList.remove('flex');
                els.authView.classList.remove('hidden');
            }
        });

        function renderHeader() {
            if (!currentUserProfile) return;
            els.displays.headerName.textContent = currentUserProfile.username;
            if (currentUserProfile.pfpUrl) els.displays.headerPfp.src = currentUserProfile.pfpUrl;
        }

        // --- Chat System ---

        function startChatListener() {
            els.displays.msgContainer.innerHTML = ''; 
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") renderMessage(change.doc.data());
                });
                requestAnimationFrame(() => els.displays.msgContainer.scrollTop = els.displays.msgContainer.scrollHeight);
            });
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            
            // Special Rendering for Commands
            if (['allin', 'flip', 'roll', 'slots', 'rps', 'guess'].includes(msg.type)) {
                const isWin = msg.result === 'WON';
                const colorClass = isWin ? 'text-green-400' : 'text-red-400';
                const borderColor = isWin ? 'border-green-500/30' : 'border-red-500/30';
                const bgGradient = isWin ? 'bg-gradient-to-br from-green-900/20 to-transparent' : 'bg-gradient-to-br from-red-900/20 to-transparent';

                let actionText = "";
                let detailsText = "";
                
                if (msg.type === 'allin') actionText = "went ALL IN";
                if (msg.type === 'flip') actionText = `flipped a coin`;
                if (msg.type === 'roll') actionText = `rolled the dice`;
                if (msg.type === 'slots') actionText = `pulled the slots`;
                if (msg.type === 'rps') actionText = `played Rock Paper Scissors`;
                if (msg.type === 'guess') actionText = `guessed a number`;

                if (msg.details) detailsText = `<div class="text-sm font-mono text-gray-300 mt-2 bg-[#1e1f22]/50 px-2 py-1 rounded">${msg.details}</div>`;

                div.className = "flex justify-center my-4 animate-fade-in";
                div.innerHTML = `
                    <div class="relative flex flex-col items-center p-6 rounded-xl border ${borderColor} ${bgGradient} max-w-sm w-full backdrop-blur-sm">
                        <img src="${msg.pfpUrl}" onclick="app.openProfile('${msg.uid}')" class="w-16 h-16 rounded-full border-2 border-[#2b2d31] shadow-lg mb-2 object-cover cursor-pointer hover:opacity-80 transition">
                        <div onclick="app.openProfile('${msg.uid}')" class="text-white font-bold text-lg mb-1 cursor-pointer hover:underline">${escapeHtml(msg.username)}</div>
                        <div class="text-gray-400 text-xs uppercase tracking-widest mb-2">${actionText} with ${msg.currency === 'coins' ? 'Coins' : 'Gems'}</div>
                        
                        ${detailsText}

                        <div class="text-3xl font-black ${colorClass} my-2 tracking-tighter">${msg.result}</div>
                        
                        <div class="flex items-center gap-2 text-sm text-gray-300">
                            ${isWin ? `<span>Won</span>` : `<span>Lost</span>`}
                            <span class="font-mono font-bold text-white">${formatNumber(msg.amount)}</span>
                        </div>

                        ${isWin && msg.multiplier > 1 ? `
                            <div class="absolute -top-3 -right-3 bg-yellow-500 text-black font-bold w-10 h-10 rounded-full flex items-center justify-center border-4 border-[#313338] shadow-lg transform rotate-12">
                                x${msg.multiplier}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (msg.type === 'bank') {
                div.className = "flex justify-center my-4 animate-fade-in";
                div.innerHTML = `
                    <div class="relative flex flex-col items-center p-6 rounded-xl border border-blue-500/30 bg-gradient-to-br from-blue-900/20 to-transparent max-w-sm w-full backdrop-blur-sm">
                        <img src="${msg.pfpUrl}" onclick="app.openProfile('${msg.uid}')" class="w-16 h-16 rounded-full border-2 border-[#2b2d31] shadow-lg mb-2 object-cover cursor-pointer hover:opacity-80 transition">
                        <div onclick="app.openProfile('${msg.uid}')" class="text-white font-bold text-lg mb-1 cursor-pointer hover:underline">${escapeHtml(msg.username)}</div>
                        <div class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-4">Bank Statement</div>
                        
                        <div class="w-full space-y-2">
                            <div class="flex justify-between items-center bg-[#1e1f22]/50 p-3 rounded">
                                <span class="text-yellow-500 font-bold uppercase text-xs">Coins</span>
                                <span class="text-white font-mono font-bold">${formatNumber(msg.coins)}</span>
                            </div>
                            <div class="flex justify-between items-center bg-[#1e1f22]/50 p-3 rounded">
                                <span class="text-purple-400 font-bold uppercase text-xs">Gems</span>
                                <span class="text-white font-mono font-bold">${formatNumber(msg.gems)}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (msg.type === 'leaderboard') {
                 let rows = '';
                 msg.topUsers.forEach((u, i) => {
                     rows += `
                        <div class="flex items-center justify-between py-1 border-b border-white/10 last:border-0">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-400 text-lg">#${i+1}</span>
                                <img src="${u.pfpUrl}" onclick="app.openProfile('${u.uid}')" class="w-6 h-6 rounded-full cursor-pointer hover:opacity-80">
                                <span class="text-white font-medium cursor-pointer hover:underline" onclick="app.openProfile('${u.uid}')">${escapeHtml(u.username)}</span>
                            </div>
                            <span class="text-yellow-500 font-mono">${formatNumber(u.coins||0)} ü™ô</span>
                        </div>
                     `;
                 });

                 div.className = "flex justify-center my-4 animate-fade-in";
                 div.innerHTML = `
                    <div class="w-full max-w-md p-4 bg-gradient-to-r from-yellow-900/40 to-[#2b2d31] rounded-lg border border-yellow-500/30">
                        <h3 class="text-yellow-400 font-bold uppercase tracking-widest mb-3 text-center">üèÜ Richest Players üèÜ</h3>
                        ${rows}
                    </div>
                 `;
            } else if (msg.type === 'lottery_win') {
                div.className = "flex justify-center my-4 animate-fade-in";
                div.innerHTML = `
                    <div class="relative flex flex-col items-center p-6 rounded-xl border border-purple-500/50 bg-gradient-to-br from-purple-900/40 to-transparent max-w-sm w-full backdrop-blur-sm animate-bounce">
                         <div class="absolute -top-3 bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full uppercase">Lottery Winner</div>
                        <img src="${msg.pfpUrl}" onclick="app.openProfile('${msg.uid}')" class="w-20 h-20 rounded-full border-4 border-yellow-400 shadow-xl mb-2 object-cover cursor-pointer">
                        <div class="text-yellow-400 font-black text-2xl mb-1">${escapeHtml(msg.username)}</div>
                        <div class="text-white text-sm">Won the Daily Pot!</div>
                        <div class="text-4xl font-black text-yellow-300 mt-2 tracking-tighter">+${formatNumber(msg.amount)} ü™ô</div>
                    </div>
                `;
            } else {
                // Normal Chat Message
                div.className = "flex gap-4 pl-2 pr-4 py-1 hover:bg-[#2e3035] -mx-2 rounded group animate-fade-in";
                const time = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';
                
                const nameColor = msg.nameColor || 'white';
                const processedText = processText(msg.text);

                div.innerHTML = `
                    <div class="flex-shrink-0 cursor-pointer mt-0.5" onclick="app.openProfile('${msg.uid}')">
                        <img src="${msg.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-10 h-10 rounded-full hover:opacity-80 transition object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2">
                            <span class="font-medium hover:underline cursor-pointer text-sm" style="color: ${nameColor}" onclick="app.openProfile('${msg.uid}')">${escapeHtml(msg.username)}</span>
                            <span class="text-[10px] text-gray-400">${time}</span>
                        </div>
                        <p class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap break-words">${processedText}</p>
                    </div>
                `;
            }
            els.displays.msgContainer.appendChild(div);
        }

        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = els.inputs.msg.value.trim();
            if (!text) return;
            els.inputs.msg.value = '';

            // Command Handling
            if (text.startsWith('/')) {
                handleCommand(text);
                return;
            }

            try {
                await addDoc(collection(db, "messages"), {
                    text,
                    uid: currentUser.uid,
                    username: currentUserProfile.username,
                    pfpUrl: currentUserProfile.pfpUrl,
                    nameColor: currentUserProfile.nameColor || 'white',
                    createdAt: serverTimestamp()
                });
            } catch (err) { console.error(err); }
        });

        // --- Command System ---

        async function handleCommand(cmdString) {
            const parts = cmdString.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);

            if (command === '/cmds') {
                showHelp();
                return;
            }

            if (command === '/prefixs' || command === '/prefixes') {
                showPrefixes();
                return;
            }

            if (command === '/top') {
                await executeTop();
                return;
            }

            if (command === '/lottery') {
                const countStr = args[0] || '1';
                const count = parseAbbreviatedNumber(countStr);
                if (isNaN(count) || count < 1) return showToast("Invalid ticket count", 'error');
                await executeLottery(count);
                return;
            }

            // Commands requiring user interactions or simple logic
            if (command === '/daily') { await executeDaily(); return; }
            if (command === '/work') { await executeWork(); return; }
            if (command === '/beg') { await executeBeg(); return; }
            if (command === '/crime') { await executeCrime(); return; }
            if (command === '/rob') { await executeRob(args[0]); return; }
            if (command === '/bio') { await executeBio(args.join(' ')); return; }
            if (command === '/color') { await executeColor(args[0]); return; }
            if (command === '/rep') { await executeRep(args[0]); return; }
            if (command === '/8ball') { await execute8Ball(args.join(' ')); return; }

            if (command === '/pay') {
                if (args.length < 3) return showToast("Usage: /pay {username} {amount} {c/g}", 'error');
                await executePay(args[0], args[1], args[2]);
                return;
            }

            // Gambling Commands
            if (['/allin', '/flip', '/roll', '/slots', '/rps', '/guess', '/bank'].includes(command)) {
                if (command === '/bank') {
                    await executeBank();
                    showToast("Action complete", 'success');
                    return;
                }
                
                let amountIdx = 0;
                let currIdx = 1;
                let extraArg = null;

                if (command === '/rps' || command === '/guess') {
                    amountIdx = 1;
                    currIdx = 2;
                    extraArg = args[0]; 
                }

                let amountStr = args[amountIdx];
                let currencyStr = args[currIdx];

                if (command === '/allin') {
                    amountStr = 'all';
                    currencyStr = args[0];
                }

                await executeGamble(command, amountStr, currencyStr, extraArg);
            } else {
                showToast("Invalid Command", 'error');
            }
        }

        function showHelp() {
            const div = document.createElement('div');
            div.className = "my-4 mx-4 p-4 bg-[#2b2d31] rounded-lg border border-[#1e1f22] text-sm shadow-xl";
            div.innerHTML = `
                <h3 class="font-bold text-white mb-3 text-lg border-b border-gray-700 pb-2">Orbitly Commands</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-blue-400 font-bold mb-1 uppercase text-xs">Essentials</h4>
                        <ul class="space-y-1 text-gray-300">
                            <li><span class="text-white font-mono">/daily</span> - Claim reward (24h)</li>
                            <li><span class="text-white font-mono">/work</span> - Earn coins (1h)</li>
                            <li><span class="text-white font-mono">/beg</span> - Small earnings (10m)</li>
                            <li><span class="text-white font-mono">/crime</span> - High risk/reward (4h)</li>
                            <li><span class="text-white font-mono">/rob [user]</span> - Steal coins (2h)</li>
                            <li><span class="text-white font-mono">/bank</span> - View balance</li>
                            <li><span class="text-white font-mono">/pay [user] [amt] [c/g]</span></li>
                            <li><span class="text-white font-mono">/top</span> - Leaderboard</li>
                            <li><span class="text-white font-mono">/lottery [tickets]</span></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-green-400 font-bold mb-1 uppercase text-xs">Social & Fun</h4>
                        <ul class="space-y-1 text-gray-300">
                            <li><span class="text-white font-mono">/bio [text]</span> - Set profile bio</li>
                            <li><span class="text-white font-mono">/color [hex]</span> - Set name color</li>
                            <li><span class="text-white font-mono">/rep [user]</span> - Give reputation</li>
                            <li><span class="text-white font-mono">/8ball [q]</span> - Ask magic 8 ball</li>
                            <li><span class="text-white font-mono">/flip, /roll, /slots</span> - Gamble</li>
                            <li><span class="text-white font-mono">Markdown</span> - **bold**, *italic*, \`code\`</li>
                        </ul>
                    </div>
                </div>
            `;
            els.displays.msgContainer.appendChild(div);
            requestAnimationFrame(() => els.displays.msgContainer.scrollTop = els.displays.msgContainer.scrollHeight);
        }

        function showPrefixes() {
             const keys = Object.keys(SUFFIXES).sort((a,b) => SUFFIXES[a] - SUFFIXES[b]);
             const list = keys.map(k => `<span class="bg-[#1e1f22] px-1 rounded text-yellow-400 font-mono">${k}</span>`).join(' ');
             
             const div = document.createElement('div');
             div.className = "my-4 mx-4 p-4 bg-[#2b2d31] rounded-lg border border-[#1e1f22] text-sm shadow-xl";
             div.innerHTML = `
                <h3 class="font-bold text-white mb-2 text-lg">Number Abbreviations</h3>
                <p class="text-gray-400 text-xs mb-3">Use these suffixes to type numbers (e.g., 1k = 1,000).</p>
                <div class="flex flex-wrap gap-2 leading-relaxed">
                    ${list}
                </div>
             `;
             els.displays.msgContainer.appendChild(div);
             requestAnimationFrame(() => els.displays.msgContainer.scrollTop = els.displays.msgContainer.scrollHeight);
        }

        async function executeWork() {
            if (!currentUserProfile) return;
            const now = Date.now();
            const last = currentUserProfile.lastWork || 0;
            const cooldown = 60 * 60 * 1000; // 1 hr

            if (now - last < cooldown) {
                const mins = Math.ceil((cooldown - (now - last)) / 60000);
                showToast(`Work available in ${mins}m`, 'error');
                return;
            }

            const earnings = Math.floor(Math.random() * 400) + 100;
            await updateDoc(doc(db, "users", currentUser.uid), {
                coins: (currentUserProfile.coins || 0) + earnings,
                lastWork: now
            });
            showToast(`Worked and earned ${earnings} Coins!`, 'success');
        }

        async function executeBeg() {
            if (!currentUserProfile) return;
            const now = Date.now();
            const last = currentUserProfile.lastBeg || 0;
            const cooldown = 10 * 60 * 1000; // 10 min

            if (now - last < cooldown) {
                const mins = Math.ceil((cooldown - (now - last)) / 60000);
                showToast(`Beg available in ${mins}m`, 'error');
                return;
            }

            const earnings = Math.floor(Math.random() * 50) + 1;
            await updateDoc(doc(db, "users", currentUser.uid), {
                coins: (currentUserProfile.coins || 0) + earnings,
                lastBeg: now
            });
            showToast(`Begged and received ${earnings} Coins.`, 'success');
        }

        async function executeCrime() {
            if (!currentUserProfile) return;
            const now = Date.now();
            const last = currentUserProfile.lastCrime || 0;
            const cooldown = 4 * 60 * 60 * 1000; // 4 hr

            if (now - last < cooldown) {
                const mins = Math.ceil((cooldown - (now - last)) / 60000);
                showToast(`Crime available in ${mins}m`, 'error');
                return;
            }

            const success = Math.random() < 0.4; // 40% chance
            if (success) {
                const earnings = Math.floor(Math.random() * 2000) + 1000;
                await updateDoc(doc(db, "users", currentUser.uid), {
                    coins: (currentUserProfile.coins || 0) + earnings,
                    lastCrime: now
                });
                showToast(`Crime Successful! Stole ${earnings} Coins!`, 'success');
            } else {
                const fine = 500;
                await updateDoc(doc(db, "users", currentUser.uid), {
                    coins: Math.max(0, (currentUserProfile.coins || 0) - fine),
                    lastCrime: now
                });
                showToast(`Caught! Fined ${fine} Coins.`, 'error');
            }
        }

        async function executeRob(targetName) {
            if (!targetName) return showToast("Specify a user to rob", 'error');
            if (currentUserProfile.username === targetName) return showToast("Cannot rob yourself", 'error');

            const now = Date.now();
            const last = currentUserProfile.lastRob || 0;
            const cooldown = 2 * 60 * 60 * 1000;

            if (now - last < cooldown) {
                const mins = Math.ceil((cooldown - (now - last)) / 60000);
                showToast(`Rob available in ${mins}m`, 'error');
                return;
            }

            const q = query(collection(db, "users"), where("username", "==", targetName));
            const snap = await getDocs(q);
            if (snap.empty) return showToast("User not found", 'error');
            
            const targetDoc = snap.docs[0];
            const targetData = targetDoc.data();
            const targetUid = targetDoc.id;
            
            if ((targetData.coins || 0) < 500) return showToast("User is too poor to rob", 'error');

            const success = Math.random() < 0.35; // 35% chance

            try {
                await runTransaction(db, async (transaction) => {
                    const sRef = doc(db, "users", currentUser.uid);
                    const tRef = doc(db, "users", targetUid);
                    const sSnap = await transaction.get(sRef);
                    const tSnap = await transaction.get(tRef);
                    
                    const sData = sSnap.data();
                    const tData = tSnap.data();

                    if (success) {
                        const stealAmt = Math.floor((tData.coins || 0) * (Math.random() * 0.05 + 0.01)); // 1-5%
                        transaction.update(sRef, { coins: (sData.coins || 0) + stealAmt, lastRob: now });
                        transaction.update(tRef, { coins: (tData.coins || 0) - stealAmt });
                        showToast(`Robbed ${stealAmt} coins from ${targetName}!`, 'success');
                    } else {
                        const fine = 500;
                        transaction.update(sRef, { coins: Math.max(0, (sData.coins || 0) - fine), lastRob: now });
                        transaction.update(tRef, { coins: (tData.coins || 0) + fine });
                        showToast(`Robbery failed! You paid ${fine} coins to ${targetName}.`, 'error');
                    }
                });
            } catch(e) { showToast("Robbery failed (error)", 'error'); }
        }

        async function executeBio(text) {
            if (!text) return showToast("Usage: /bio [text]", 'error');
            if (text.length > 80) return showToast("Bio too long (max 80 chars)", 'error');
            await updateDoc(doc(db, "users", currentUser.uid), { bio: text });
            showToast("Bio updated!", 'success');
        }

        async function executeColor(hex) {
            if (!/^#[0-9A-F]{6}$/i.test(hex)) return showToast("Invalid Hex Color (e.g. #FF0000)", 'error');
            await updateDoc(doc(db, "users", currentUser.uid), { nameColor: hex });
            showToast("Name color updated!", 'success');
        }

        async function executeRep(targetName) {
            if (!targetName) return showToast("Specify user", 'error');
            if (currentUserProfile.username === targetName) return showToast("Cannot rep yourself", 'error');

            const now = Date.now();
            const last = currentUserProfile.lastRep || 0;
            const cooldown = 24 * 60 * 60 * 1000;

            if (now - last < cooldown) return showToast("Rep available in 24h", 'error');

            const q = query(collection(db, "users"), where("username", "==", targetName));
            const snap = await getDocs(q);
            if (snap.empty) return showToast("User not found", 'error');
            
            const targetUid = snap.docs[0].id;
            const currentRep = snap.docs[0].data().rep || 0;

            await updateDoc(doc(db, "users", targetUid), { rep: currentRep + 1 });
            await updateDoc(doc(db, "users", currentUser.uid), { lastRep: now });
            showToast(`Gave +1 Rep to ${targetName}`, 'success');
        }

        async function execute8Ball(question) {
            if (!question) return showToast("Ask a question!", 'error');
            const answers = ["Yes.", "No.", "Maybe.", "Ask again later.", "Definitely.", "Absolutely not."];
            const ans = answers[Math.floor(Math.random() * answers.length)];
            
            await addDoc(collection(db, "messages"), {
                text: `üé± Question: ${question}\nAnswer: **${ans}**`,
                uid: currentUser.uid,
                username: currentUserProfile.username,
                pfpUrl: currentUserProfile.pfpUrl,
                nameColor: currentUserProfile.nameColor,
                createdAt: serverTimestamp()
            });
        }

        async function executeDaily() {
            if (!currentUserProfile) return;
            const now = Date.now();
            const last = currentUserProfile.lastDaily || 0;
            const oneDay = 24 * 60 * 60 * 1000;

            if (now - last < oneDay) {
                const timeLeft = Math.ceil((oneDay - (now - last)) / (1000 * 60 * 60));
                showToast(`Daily reward available in ${timeLeft} hours`, 'error');
                return;
            }

            const ref = doc(db, "users", currentUser.uid);
            await updateDoc(ref, {
                coins: (currentUserProfile.coins || 0) + 500,
                gems: (currentUserProfile.gems || 0) + 5,
                lastDaily: now
            });
            showToast("Claimed 500 Coins & 5 Gems!", 'success');
        }

        async function executeTop() {
            const q = query(collection(db, "users"), orderBy("coins", "desc"), limit(3));
            const snap = await getDocs(q);
            const topUsers = [];
            snap.forEach(d => {
                const u = d.data();
                topUsers.push({
                    uid: u.uid,
                    username: u.username,
                    pfpUrl: u.pfpUrl,
                    coins: u.coins || 0
                });
            });

            // Send to chat publicly
            await addDoc(collection(db, "messages"), {
                type: 'leaderboard',
                topUsers: topUsers,
                createdAt: serverTimestamp()
            });
        }

        async function executeLottery(count) {
             const TICKET_PRICE = 100;
             const totalCost = count * TICKET_PRICE;
             
             if (!currentUserProfile) return;
             if ((currentUserProfile.coins || 0) < totalCost) return showToast(`Need ${totalCost} coins`, 'error');

             try {
                let winnerAnnouncement = null;

                await runTransaction(db, async (transaction) => {
                    const lotRef = doc(db, "system", "lottery");
                    const userRef = doc(db, "users", currentUser.uid);
                    const lotSnap = await transaction.get(lotRef);
                    const userSnap = await transaction.get(userRef);

                    if (!userSnap.exists()) throw "User does not exist";
                    const userData = userSnap.data();
                    if ((userData.coins || 0) < totalCost) throw "Insufficient funds";

                    let lotData = { pot: 0, tickets: [], nextDraw: Date.now() + 86400000 };
                    if (lotSnap.exists()) {
                        lotData = lotSnap.data();
                        lotData.pot = lotData.pot || 0;
                        lotData.tickets = lotData.tickets || [];
                        lotData.nextDraw = lotData.nextDraw || (Date.now() + 86400000);
                    }

                    let drawHappened = false;
                    let winnerRef = null;
                    let winnerSnap = null;
                    let potWon = 0;

                    if (Date.now() > lotData.nextDraw && lotData.tickets.length > 0) {
                        const winnerUid = lotData.tickets[Math.floor(Math.random() * lotData.tickets.length)];
                        winnerRef = doc(db, "users", winnerUid);
                        winnerSnap = await transaction.get(winnerRef);
                        potWon = lotData.pot;
                        drawHappened = true;
                    } else if (Date.now() > lotData.nextDraw) {
                        lotData.nextDraw = Date.now() + 86400000;
                    }

                    transaction.update(userRef, { coins: userData.coins - totalCost });

                    if (drawHappened && winnerSnap && winnerSnap.exists()) {
                        const wData = winnerSnap.data();
                        transaction.update(winnerRef, { coins: (wData.coins || 0) + potWon });
                        
                        winnerAnnouncement = {
                            type: 'lottery_win',
                            uid: winnerSnap.id,
                            username: wData.username,
                            pfpUrl: wData.pfpUrl,
                            amount: potWon,
                            createdAt: serverTimestamp()
                        };
                    }

                    if (drawHappened) {
                        lotData.pot = 0;
                        lotData.tickets = [];
                        lotData.nextDraw = Date.now() + 86400000;
                    }

                    const newTickets = Array(count).fill(currentUser.uid);
                    lotData.tickets.push(...newTickets);
                    lotData.pot += totalCost;

                    if (lotSnap.exists()) {
                        transaction.update(lotRef, lotData);
                    } else {
                        transaction.set(lotRef, lotData);
                    }
                });
                
                if (winnerAnnouncement) {
                    await addDoc(collection(db, "messages"), winnerAnnouncement);
                }
                
                showToast(`Bought ${count} ticket(s)!`, 'success');

             } catch (e) {
                 console.error("Lottery Error:", e);
                 const msg = typeof e === 'string' ? e : "Transaction failed";
                 showToast(msg, 'error');
             }
        }

        async function executePay(targetName, amountStr, currStr) {
            const amount = parseAbbreviatedNumber(amountStr);
            if (isNaN(amount) || amount <= 0) return showToast("Invalid Amount", 'error');
            
            const isCoins = ['c', 'coin', 'coins'].includes(currStr?.toLowerCase());
            const currency = isCoins ? 'coins' : 'gems';
            
            if ((currentUserProfile[currency] || 0) < amount) return showToast("Insufficient funds", 'error');
            if (currentUserProfile.username === targetName) return showToast("Cannot pay yourself", 'error');

            const q = query(collection(db, "users"), where("username", "==", targetName));
            const snap = await getDocs(q);
            
            if (snap.empty) return showToast("User not found", 'error');
            const targetDoc = snap.docs[0];
            const targetUid = targetDoc.id;

            try {
                await runTransaction(db, async (transaction) => {
                    const senderRef = doc(db, "users", currentUser.uid);
                    const receiverRef = doc(db, "users", targetUid);
                    const senderSnap = await transaction.get(senderRef);
                    const receiverSnap = await transaction.get(receiverRef);

                    if (!senderSnap.exists() || !receiverSnap.exists()) throw "User data missing";

                    const senderBal = senderSnap.data()[currency] || 0;
                    if (senderBal < amount) throw "Insufficient funds";

                    const receiverBal = receiverSnap.data()[currency] || 0;

                    transaction.update(senderRef, { [currency]: senderBal - amount });
                    transaction.update(receiverRef, { [currency]: receiverBal + amount });
                });
                showToast(`Sent ${amount} ${currency} to ${targetName}`, 'success');
            } catch (e) {
                const msg = typeof e === 'string' ? e : "Transaction failed";
                showToast(msg, 'error');
            }
        }

        async function executeBank() {
            if (!currentUserProfile) return;
            await addDoc(collection(db, "messages"), {
                type: 'bank',
                uid: currentUser.uid,
                username: currentUserProfile.username,
                pfpUrl: currentUserProfile.pfpUrl,
                coins: currentUserProfile.coins || 0,
                gems: currentUserProfile.gems || 0,
                createdAt: serverTimestamp()
            });
        }

        async function executeGamble(game, amountStr, currStr, extra) {
            if (!currentUserProfile) return;
            
            const isCoins = ['c', 'coin', 'coins'].includes(currStr?.toLowerCase());
            const currencyKey = isCoins ? 'coins' : 'gems';
            let balance = currentUserProfile[currencyKey] || 0;
            let bet = 0;

            if (amountStr === 'all') bet = balance;
            else bet = parseAbbreviatedNumber(amountStr);

            if (isNaN(bet) || bet <= 0) {
                showToast("Invalid Amount", 'error');
                return;
            }
            if (balance < bet) {
                showToast(`Not enough ${currencyKey}`, 'error');
                return;
            }

            const isDev = currentUser.email === 'dev@gmail.com';
            let win = false;
            let multiplier = 0;
            let details = "";

            // GAME LOGIC
            if (game === '/allin') {
                if (isDev) { win = true; multiplier = 10; }
                else {
                    win = Math.random() < 0.2;
                    if (win) {
                        const r = Math.random();
                        if (r < 0.5) multiplier = 1;
                        else if (r < 0.75) multiplier = 2;
                        else if (r < 0.875) multiplier = 3;
                        else if (r < 0.975) multiplier = 5;
                        else multiplier = 10;
                    }
                }
            } else if (game === '/flip') {
                const isHeads = Math.random() < 0.5;
                const res = isHeads ? 'Heads' : 'Tails';
                details = `Coin landed on ${res}`;
                if (isDev) { win = true; multiplier = 2; details = "Coin landed on WIN (Dev)"; }
                else {
                    win = Math.random() < 0.5; // 50% chance
                    multiplier = 2;
                }
            } else if (game === '/roll') {
                let roll = Math.floor(Math.random() * 6) + 1;
                if (isDev) { roll = 6; win = true; multiplier = 3; }
                else {
                    if (roll >= 4) win = true;
                    if (roll === 6) multiplier = 3; else multiplier = 1.5;
                }
                details = `Rolled a üé≤ ${roll}`;
            } else if (game === '/slots') {
                const syms = ['üçí','üçã','üçá','üíé','7Ô∏è‚É£'];
                let s1, s2, s3;
                if (isDev) { s1=s2=s3='7Ô∏è‚É£'; win=true; multiplier=10; }
                else {
                    s1 = syms[Math.floor(Math.random()*syms.length)];
                    s2 = syms[Math.floor(Math.random()*syms.length)];
                    s3 = syms[Math.floor(Math.random()*syms.length)];
                    
                    if (s1===s2 && s2===s3) {
                        win = true;
                        multiplier = (s1==='7Ô∏è‚É£') ? 10 : 5;
                    } else if (s1===s2 || s2===s3 || s1===s3) {
                        win = true; multiplier = 1.5;
                    }
                }
                details = `${s1} | ${s2} | ${s3}`;
            } else if (game === '/rps') {
                const moves = ['r', 'p', 's'];
                const map = {'r':'Rock','p':'Paper','s':'Scissors'};
                const userMove = extra ? extra.toLowerCase()[0] : null;
                
                if (!moves.includes(userMove)) { showToast("Use r, p, or s", 'error'); return; }

                let botMove = moves[Math.floor(Math.random()*3)];
                if (isDev) {
                    // Bot always loses to Dev
                    if (userMove === 'r') botMove = 's';
                    if (userMove === 'p') botMove = 'r';
                    if (userMove === 's') botMove = 'p';
                }

                details = `You: ${map[userMove]} vs Bot: ${map[botMove]}`;

                if (userMove === botMove) {
                    // Tie - Money back (logic handled as win x1)
                    win = true; multiplier = 1; details += " (Draw)";
                } else if (
                    (userMove === 'r' && botMove === 's') ||
                    (userMove === 'p' && botMove === 'r') ||
                    (userMove === 's' && botMove === 'p')
                ) {
                    win = true; multiplier = 2;
                } else {
                    win = false;
                }
            } else if (game === '/guess') {
                const guess = parseInt(extra);
                if (isNaN(guess) || guess < 1 || guess > 10) { showToast("Guess 1-10", 'error'); return; }
                
                let secret = Math.floor(Math.random() * 10) + 1;
                if (isDev) secret = guess;

                details = `Number was ${secret}`;
                if (guess === secret) {
                    win = true; multiplier = 5;
                }
            }

            // Calc Result
            const winnings = win ? Math.floor(bet * multiplier) : 0;
            const newBal = (balance - bet) + winnings;

            // Update DB
            await updateDoc(doc(db, "users", currentUser.uid), { [currencyKey]: newBal });

            // Post Message
            await addDoc(collection(db, "messages"), {
                type: game.replace('/',''),
                uid: currentUser.uid,
                username: currentUserProfile.username,
                pfpUrl: currentUserProfile.pfpUrl,
                currency: currencyKey,
                result: win ? (multiplier === 1 ? 'DRAW' : 'WON') : 'LOST',
                amount: win ? winnings : bet,
                multiplier: multiplier,
                details: details,
                createdAt: serverTimestamp()
            });

            showToast("Action complete", 'success');
        }

        // --- Users List System ---

        function startUsersListener() {
            const q = query(collection(db, "users"), orderBy("username", "asc"));
            unsubscribeUsers = onSnapshot(q, (snapshot) => {
                els.displays.onlineList.innerHTML = '';
                const onlineUsers = [];
                const offlineUsers = [];

                snapshot.forEach((doc) => {
                    const user = doc.data();
                    const status = user.status || 'offline';
                    if (status === 'invisible' && user.uid !== currentUser.uid) return;
                    
                    let displayStatus = status;
                    if (status === 'invisible') displayStatus = 'offline'; 

                    if (displayStatus === 'offline') offlineUsers.push({ ...user, displayStatus });
                    else onlineUsers.push({ ...user, displayStatus });
                });

                if (onlineUsers.length > 0) {
                    const header = document.createElement('div');
                    header.className = "px-2 py-3 text-xs font-bold text-gray-500 hover:text-gray-400 uppercase tracking-wide mt-2";
                    header.textContent = `Online ‚Äî ${onlineUsers.length}`;
                    els.displays.onlineList.appendChild(header);
                    onlineUsers.forEach(u => renderUserInList(u, u.displayStatus));
                }

                if (offlineUsers.length > 0) {
                    const header = document.createElement('div');
                    header.className = "px-2 py-3 text-xs font-bold text-gray-500 hover:text-gray-400 uppercase tracking-wide mt-2";
                    header.textContent = `Offline ‚Äî ${offlineUsers.length}`;
                    els.displays.onlineList.appendChild(header);
                    offlineUsers.forEach(u => renderUserInList(u, u.displayStatus));
                }
            });
        }

        function renderUserInList(user, status) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 p-2 rounded hover:bg-[#35373c] cursor-pointer group opacity-90 hover:opacity-100 transition";
            div.onclick = () => app.openProfile(user.uid);
            if (status === 'offline') div.classList.add('opacity-50');

            let statusColor = 'bg-gray-500';
            if (status === 'online') statusColor = 'bg-green-500';
            if (status === 'busy') statusColor = 'bg-yellow-500';
            if (status === 'dnd') statusColor = 'bg-red-500';

            div.innerHTML = `
                <div class="relative">
                    <img src="${user.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full object-cover">
                    ${status !== 'offline' ? `<div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 border-[3px] border-[#2b2d31] rounded-full ${statusColor}"></div>` : ''}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-gray-200 truncate group-hover:text-white">${escapeHtml(user.username)}</div>
                    <div class="text-[10px] text-gray-400 uppercase font-bold">${status}</div>
                </div>
            `;
            els.displays.onlineList.appendChild(div);
        }

        // --- Utils ---

        function toggleLoading(active) {
            if (active) {
                els.displays.loader.classList.remove('hidden');
                els.displays.feedback.classList.add('hidden');
            } else {
                els.displays.loader.classList.add('hidden');
            }
        }

        function showError(msg) {
            els.displays.error.textContent = msg;
            els.displays.feedback.classList.remove('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
</body>
</html>
