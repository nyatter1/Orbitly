<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orbitly Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Architects+Daughter&family=Audiowide&family=Bad+Script&family=Bangers&family=Barrio&family=Berkshire+Swash&family=Bevan&family=Big+Shoulders+Display:wght@700&family=Black+And+White+Picture&family=Black+Ops+One&family=Bonbon&family=Bowlby+One+SC&family=Bungee+Inline&family=Bungee+Shade&family=Cabin+Sketch:wght@700&family=Caesar+Dressing&family=Caveat:wght@700&family=Chakra+Petch:wght@700&family=Chicle&family=Cinzel:wght@700&family=Codystar:wght@800&family=Comfortaa:wght@700&family=Comic+Neue:wght@700&family=Cookie&family=Covered+By+Your+Grace&family=Creepster&family=Darker+Grotesque:wght@900&family=Dela+Gothic+One&family=Diplomata&family=DM+Serif+Display&family=DotGothic16&family=Eater&family=El+Messiri:wght@700&family=Emilys+Candy&family=Ewert&family=Fascinate+Inline&family=Faster+One&family=Fauna+One&family=Finger+Paint&family=Flamenco:wght@700&family=Fontdiner+Swanky&family=Fredoka+One&family=Frijole&family=Fruktur&family=Galindo&family=Glass+Antiqua&family=Gloria+Hallelujah&family=Gochi+Hand&family=Grandstander:wght@900&family=Grenze+Gotisch:wght@700&family=Griffy&family=Handjet:wght@700&family=Henny+Penny&family=Homemade+Apple&family=Iceberg&family=Inconsolata:wght@700&family=Indie+Flower&family=Irish+Grover&family=Jacques+Francois+Shadow&family=Jolly+Lodger&family=Josefin+Sans:wght@700&family=Just+Me+Again+Down+Here&family=Kavoon&family=Kranky&family=Krona+One&family=Kumar+One+Outline&family=Lakki+Reddy&family=Lato:wght@700&family=Lemon&family=Libre+Barcode+39+Text&family=Limelight&family=Lobster&family=Long+Cang&family=Love+Ya+Like+A+Sister&family=Luckiest+Guy&family=Major+Mono+Display&family=MedievalSharp&family=Megrim&family=Merriweather:wght@700&family=Metal+Mania&family=Miltonian+Tattoo&family=Modak&family=Monoton&family=Montserrat:wght@700&family=Mountains+of+Christmas:wght@700&family=Mystery+Quest&family=Nanum+Pen+Script&family=New+Rocker&family=Niconne&family=Nosifer&family=Nothing+You+Could+Do&family=Nova+Cut&family=Nova+Mono&family=Nova+Oval&family=Nova+Script&family=Nova+Square&family=Nunito:wght@700&family=Offside&family=Oldenburg&family=Oleo+Script:wght@700&family=Open+Sans:wght@700&family=Orbitron:wght@700&family=Oregano&family=Oswald:wght@700&family=Pacifico&family=Parisienne&family=Patrick+Hand&family=Permanent+Marker&family=Piedra&family=Pirata+One&family=Playball&family=Playfair+Display:wght@700&family=Poiret+One&family=Poller+One&family=Press+Start+2P&family=Purple+Purse&family=Quicksand:wght@700&family=Racing+Sans+One&family=Raleway:wght@700&family=Ranchers&family=Red+Rose:wght@700&family=Reenie+Beanie&family=Revalia&family=Ribeye+Marrow&family=Righteous&family=Roboto:wght@700&family=Rock+Salt&family=Rubik+Beastly&family=Rubik+Burned&family=Rubik+Distressed&family=Rubik+Gemstones&family=Rubik+Glitch&family=Rubik+Iso&family=Rubik+Marker+Hatch&family=Rubik+Microbe&family=Rubik+Moonrocks&family=Rubik+Puddles&family=Rubik+Wet+Paint&family=Rye&family=Sacramento&family=Saira+Stencil+One&family=Sancreek&family=Sansita+Swashed:wght@900&family=Sarina&family=Satisfy&family=Schoolbell&family=Sedgwick+Ave+Display&family=Shadows+Into+Light&family=Shojumaru&family=Sigmar+One&family=Slackey&family=Smokum&family=Snowburst+One&family=Special+Elite&family=Spicy+Rice&family=Squada+One&family=Stalinist+One&family=Supermercado+One&family=Syncopate:wght@700&family=Tangerine:wght@700&family=Teko:wght@700&family=Titan+One&family=Trade+Winds&family=Turret+Road:wght@800&family=Ubuntu:wght@700&family=Ultra&family=UnifrakturMaguntia&family=Vampiro+One&family=Vast+Shadow&family=VT323&family=Wallpoet&family=Walter+Turncoat&family=Warnes&family=Wire+One&family=Yellowtail&family=Yeseva+One&family=Yesteryear&family=Zeyada&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Base Styles */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #2b2d31; }
::-webkit-scrollbar-thumb { background: #1a1b1e; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #3f4147; }
.loader { border: 3px solid #f3f3f3; border-top: 3px solid #5865F2; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.animate-fade-in { animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.toast-enter { animation: toastIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
.toast-exit { animation: toastOut 0.3s ease-in forwards; }
@keyframes toastIn { from { transform: translate(-50%, 50px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
@keyframes toastOut { from { transform: translate(-50%, 0); opacity: 1; } to { transform: translate(-50%, 50px); opacity: 0; } }
.status-online { background-color: #23a559; }
.status-busy { background-color: #f0b232; }
.status-dnd { background-color: #f23f43; }
.status-offline { background-color: #80848e; }
.status-invisible { background-color: #80848e; }
.profile-header-gradient { background: linear-gradient(135deg, #5865F2, #9b59b6); }
.mention-badge { background-color: rgba(88, 101, 242, 0.3); color: #dee0fc; border-radius: 4px; padding: 0 4px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.mention-badge:hover { background-color: #5865F2; color: white; }
.msg-actions { opacity: 0; transition: opacity 0.2s; }
.group:hover .msg-actions { opacity: 1; }
.msg-menu-open { opacity: 1 !important; }
.reply-preview-anim { animation: slideUp 0.2s ease-out; }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.reply-spine { width: 35px; height: 12px; border-top: 2px solid #4e5058; border-left: 2px solid #4e5058; border-top-left-radius: 6px; margin-top: 18px; margin-left: 18px; margin-right: 4px; flex-shrink: 0; }
.leaderboard-scroll { max-height: 100%; overflow-y: auto; scrollbar-width: thin; }
.room-modal { animation: fadeIn 0.2s ease-out; }
.drawer-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.rank-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; margin-right: 6px; display: inline-block; vertical-align: middle; box-shadow: 0 1px 2px rgba(0,0,0,0.3); letter-spacing: 0.5px; }

/* --- FONTS & THEMES --- */
.font-default { font-family: ui-sans-serif, system-ui, sans-serif; }
.font-abril { font-family: 'Abril Fatface', cursive; }
.font-architects { font-family: 'Architects Daughter', cursive; }
.font-audiowide { font-family: 'Audiowide', cursive; }
.font-bad-script { font-family: 'Bad Script', cursive; }
.font-bangers { font-family: 'Bangers', cursive; }
.font-barrio { font-family: 'Barrio', cursive; }
.font-berkshire { font-family: 'Berkshire Swash', cursive; }
.font-bevan { font-family: 'Bevan', cursive; }
.font-big-shoulders { font-family: 'Big Shoulders Display', cursive; }
.font-black-white { font-family: 'Black And White Picture', cursive; }
.font-black-ops { font-family: 'Black Ops One', cursive; }
.font-bonbon { font-family: 'Bonbon', cursive; }
.font-bowlby { font-family: 'Bowlby One SC', cursive; }
.font-bungee-inline { font-family: 'Bungee Inline', cursive; }
.font-bungee-shade { font-family: 'Bungee Shade', cursive; }
.font-cabin-sketch { font-family: 'Cabin Sketch', cursive; }
.font-caesar { font-family: 'Caesar Dressing', cursive; }
.font-caveat { font-family: 'Caveat', cursive; }
.font-chakra { font-family: 'Chakra Petch', sans-serif; }
.font-chicle { font-family: 'Chicle', cursive; }
.font-cinzel { font-family: 'Cinzel', serif; }
.font-codystar { font-family: 'Codystar', cursive; }
.font-comfortaa { font-family: 'Comfortaa', cursive; }
.font-comic-neue { font-family: 'Comic Neue', cursive; }
.font-cookie { font-family: 'Cookie', cursive; }
.font-covered-grace { font-family: 'Covered By Your Grace', cursive; }
.font-creepster { font-family: 'Creepster', cursive; }
.font-darker-grotesque { font-family: 'Darker Grotesque', sans-serif; }
.font-dela-gothic { font-family: 'Dela Gothic One', cursive; }
.font-diplomata { font-family: 'Diplomata', cursive; }
.font-dm-serif { font-family: 'DM Serif Display', serif; }
.font-dotgothic { font-family: 'DotGothic16', sans-serif; }
.font-eater { font-family: 'Eater', cursive; }
.font-el-messiri { font-family: 'El Messiri', sans-serif; }
.font-emilys-candy { font-family: 'Emilys Candy', cursive; }
.font-ewert { font-family: 'Ewert', cursive; }
.font-fascinate { font-family: 'Fascinate Inline', cursive; }
.font-faster-one { font-family: 'Faster One', cursive; }
.font-fauna-one { font-family: 'Fauna One', serif; }
.font-finger-paint { font-family: 'Finger Paint', cursive; }
.font-flamenco { font-family: 'Flamenco', cursive; }
.font-fontdiner { font-family: 'Fontdiner Swanky', cursive; }
.font-fredoka { font-family: 'Fredoka One', cursive; }
.font-frijole { font-family: 'Frijole', cursive; }
.font-fruktur { font-family: 'Fruktur', cursive; }
.font-galindo { font-family: 'Galindo', cursive; }
.font-glass-antiqua { font-family: 'Glass Antiqua', cursive; }
.font-gloria { font-family: 'Gloria Hallelujah', cursive; }
.font-gochi { font-family: 'Gochi Hand', cursive; }
.font-grandstander { font-family: 'Grandstander', cursive; }
.font-grenze { font-family: 'Grenze Gotisch', cursive; }
.font-griffy { font-family: 'Griffy', cursive; }
.font-handjet { font-family: 'Handjet', cursive; }
.font-henny-penny { font-family: 'Henny Penny', cursive; }
.font-homemade-apple { font-family: 'Homemade Apple', cursive; }
.font-iceberg { font-family: 'Iceberg', cursive; }
.font-inconsolata { font-family: 'Inconsolata', monospace; }
.font-indie-flower { font-family: 'Indie Flower', cursive; }
.font-irish-grover { font-family: 'Irish Grover', cursive; }
.font-jacques { font-family: 'Jacques Francois Shadow', cursive; }
.font-jolly-lodger { font-family: 'Jolly Lodger', cursive; }
.font-josefin { font-family: 'Josefin Sans', sans-serif; }
.font-just-me { font-family: 'Just Me Again Down Here', cursive; }
.font-kavoon { font-family: 'Kavoon', cursive; }
.font-kranky { font-family: 'Kranky', cursive; }
.font-krona-one { font-family: 'Krona One', sans-serif; }
.font-kumar { font-family: 'Kumar One Outline', cursive; }
.font-lakki { font-family: 'Lakki Reddy', cursive; }
.font-lato { font-family: 'Lato', sans-serif; }
.font-lemon { font-family: 'Lemon', cursive; }
.font-libre-barcode { font-family: 'Libre Barcode 39 Text', cursive; }
.font-limelight { font-family: 'Limelight', cursive; }
.font-lobster { font-family: 'Lobster', cursive; }
.font-long-cang { font-family: 'Long Cang', cursive; }
.font-love-ya { font-family: 'Love Ya Like A Sister', cursive; }
.font-luckiest { font-family: 'Luckiest Guy', cursive; }
.font-major-mono { font-family: 'Major Mono Display', monospace; }
.font-medieval { font-family: 'MedievalSharp', cursive; }
.font-megrim { font-family: 'Megrim', cursive; }
.font-merriweather { font-family: 'Merriweather', serif; }
.font-metal-mania { font-family: 'Metal Mania', cursive; }
.font-miltonian { font-family: 'Miltonian Tattoo', cursive; }
.font-modak { font-family: 'Modak', cursive; }
.font-monoton { font-family: 'Monoton', cursive; }
.font-montserrat { font-family: 'Montserrat', sans-serif; }
.font-mountains { font-family: 'Mountains of Christmas', cursive; }
.font-mystery { font-family: 'Mystery Quest', cursive; }
.font-nanum { font-family: 'Nanum Pen Script', cursive; }
.font-new-rocker { font-family: 'New Rocker', cursive; }
.font-niconne { font-family: 'Niconne', cursive; }
.font-nosifer { font-family: 'Nosifer', cursive; }
.font-nothing { font-family: 'Nothing You Could Do', cursive; }
.font-nova-cut { font-family: 'Nova Cut', cursive; }
.font-nova-mono { font-family: 'Nova Mono', monospace; }
.font-nova-oval { font-family: 'Nova Oval', cursive; }
.font-nova-script { font-family: 'Nova Script', cursive; }
.font-nova-square { font-family: 'Nova Square', sans-serif; }
.font-nunito { font-family: 'Nunito', sans-serif; }
.font-offside { font-family: 'Offside', cursive; }
.font-oldenburg { font-family: 'Oldenburg', cursive; }
.font-oleo { font-family: 'Oleo Script', cursive; }
.font-open-sans { font-family: 'Open Sans', sans-serif; }
.font-orbitron { font-family: 'Orbitron', sans-serif; }
.font-oregano { font-family: 'Oregano', cursive; }
.font-oswald { font-family: 'Oswald', sans-serif; }
.font-pacifico { font-family: 'Pacifico', cursive; }
.font-parisienne { font-family: 'Parisienne', cursive; }
.font-patrick { font-family: 'Patrick Hand', cursive; }
.font-permanent { font-family: 'Permanent Marker', cursive; }
.font-piedra { font-family: 'Piedra', cursive; }
.font-pirata { font-family: 'Pirata One', cursive; }
.font-playball { font-family: 'Playball', cursive; }
.font-playfair { font-family: 'Playfair Display', serif; }
.font-poiret { font-family: 'Poiret One', cursive; }
.font-poller { font-family: 'Poller One', cursive; }
.font-press-start { font-family: 'Press Start 2P', cursive; }
.font-purple-purse { font-family: 'Purple Purse', cursive; }
.font-quicksand { font-family: 'Quicksand', sans-serif; }
.font-racing { font-family: 'Racing Sans One', cursive; }
.font-raleway { font-family: 'Raleway', sans-serif; }
.font-ranchers { font-family: 'Ranchers', cursive; }
.font-red-rose { font-family: 'Red Rose', cursive; }
.font-reenie { font-family: 'Reenie Beanie', cursive; }
.font-revalia { font-family: 'Revalia', cursive; }
.font-ribeye { font-family: 'Ribeye Marrow', cursive; }
.font-righteous { font-family: 'Righteous', cursive; }
.font-roboto { font-family: 'Roboto', sans-serif; }
.font-rock-salt { font-family: 'Rock Salt', cursive; }
.font-rubik-beastly { font-family: 'Rubik Beastly', cursive; }
.font-rubik-burned { font-family: 'Rubik Burned', cursive; }
.font-rubik-distressed { font-family: 'Rubik Distressed', cursive; }
.font-rubik-gemstones { font-family: 'Rubik Gemstones', cursive; }
.font-rubik-glitch { font-family: 'Rubik Glitch', cursive; }
.font-rubik-iso { font-family: 'Rubik Iso', cursive; }
.font-rubik-marker { font-family: 'Rubik Marker Hatch', cursive; }
.font-rubik-microbe { font-family: 'Rubik Microbe', cursive; }
.font-rubik-moonrocks { font-family: 'Rubik Moonrocks', cursive; }
.font-rubik-puddles { font-family: 'Rubik Puddles', cursive; }
.font-rubik-wet { font-family: 'Rubik Wet Paint', cursive; }
.font-rye { font-family: 'Rye', cursive; }
.font-sacramento { font-family: 'Sacramento', cursive; }
.font-saira-stencil { font-family: 'Saira Stencil One', sans-serif; }
.font-sancreek { font-family: 'Sancreek', cursive; }
.font-sansita { font-family: 'Sansita Swashed', cursive; }
.font-sarina { font-family: 'Sarina', cursive; }
.font-satisfy { font-family: 'Satisfy', cursive; }
.font-schoolbell { font-family: 'Schoolbell', cursive; }
.font-sedgwick { font-family: 'Sedgwick Ave Display', cursive; }
.font-shadows { font-family: 'Shadows Into Light', cursive; }
.font-shojumaru { font-family: 'Shojumaru', cursive; }
.font-sigmar { font-family: 'Sigmar One', cursive; }
.font-slackey { font-family: 'Slackey', cursive; }
.font-smokum { font-family: 'Smokum', cursive; }
.font-snowburst { font-family: 'Snowburst One', cursive; }
.font-special-elite { font-family: 'Special Elite', cursive; }
.font-spicy-rice { font-family: 'Spicy Rice', cursive; }
.font-squada-one { font-family: 'Squada One', cursive; }
.font-stalinist { font-family: 'Stalinist One', cursive; }
.font-supermercado { font-family: 'Supermercado One', cursive; }
.font-syncopate { font-family: 'Syncopate', sans-serif; }
.font-tangerine { font-family: 'Tangerine', cursive; }
.font-teko { font-family: 'Teko', sans-serif; }
.font-titan-one { font-family: 'Titan One', cursive; }
.font-trade-winds { font-family: 'Trade Winds', cursive; }
.font-turret-road { font-family: 'Turret Road', cursive; }
.font-ubuntu { font-family: 'Ubuntu', sans-serif; }
.font-ultra { font-family: 'Ultra', serif; }
.font-unifraktur { font-family: 'UnifrakturMaguntia', cursive; }
.font-vampiro { font-family: 'Vampiro One', cursive; }
.font-vast-shadow { font-family: 'Vast Shadow', cursive; }
.font-vt323 { font-family: 'VT323', monospace; }
.font-wallpoet { font-family: 'Wallpoet', cursive; }
.font-walter { font-family: 'Walter Turncoat', cursive; }
.font-warnes { font-family: 'Warnes', cursive; }
.font-wire-one { font-family: 'Wire One', sans-serif; }
.font-yellowtail { font-family: 'Yellowtail', cursive; }
.font-yeseva { font-family: 'Yeseva One', cursive; }
.font-yesteryear { font-family: 'Yesteryear', cursive; }
.font-zeyada { font-family: 'Zeyada', cursive; }

.effect-none { }
.effect-outline { -webkit-text-stroke: 1px black; }
.effect-outline-thick { -webkit-text-stroke: 2px black; }
.effect-glow { text-shadow: 0 0 5px currentColor; }
.effect-glow-strong { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
.effect-emboss { text-shadow: 1px 1px 0 rgba(0,0,0,0.5), -1px -1px 0 rgba(255,255,255,0.2); }
.effect-inset { text-shadow: 1px 1px 0 rgba(255,255,255,0.1), -1px -1px 0 rgba(0,0,0,0.5); }
.effect-gradient-sunset { background: linear-gradient(to right, #ff9966, #ff5e62); -webkit-background-clip: text; color: transparent !important; }
.effect-gradient-ocean { background: linear-gradient(to right, #2b5876, #4e4376); -webkit-background-clip: text; color: transparent !important; }
.effect-gradient-forest { background: linear-gradient(to right, #56ab2f, #a8e063); -webkit-background-clip: text; color: transparent !important; }
.effect-gradient-gold { background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); -webkit-background-clip: text; color: transparent !important; }
.effect-gradient-fire { background: linear-gradient(to right, #f12711, #f5af19); -webkit-background-clip: text; color: transparent !important; }
.effect-gradient-rainbow { background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; color: transparent !important; }
.effect-rainbow { animation: rainbow 2s linear infinite; }
@keyframes rainbow { 0% { color: red; } 16% { color: orange; } 33% { color: yellow; } 50% { color: green; } 66% { color: blue; } 83% { color: indigo; } 100% { color: violet; } }
.effect-fire { color: #f5af19; text-shadow: 0 -1px 4px #FFF, 0 -2px 10px #FF0, 0 -10px 20px #F00; animation: fire 1s infinite alternate; }
@keyframes fire { from { text-shadow: 0 -1px 4px #FFF, 0 -2px 10px #FF0, 0 -10px 20px #F00; } to { text-shadow: 0 -1px 4px #FFF, 0 -2px 10px #FF0, 0 -15px 25px #F00; } }
.effect-glitch { position: relative; }
.effect-glitch::before, .effect-glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.8; }
.effect-glitch::before { color: red; z-index: -1; animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; }
.effect-glitch::after { color: blue; z-index: -2; animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) reverse both infinite; }
@keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
.effect-neon-blue { color: #fff; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #00f, 0 0 30px #00f, 0 0 40px #00f; }
.effect-neon-green { color: #fff; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #0f0, 0 0 30px #0f0, 0 0 40px #0f0; }
.effect-neon-pink { color: #fff; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #f0f, 0 0 30px #f0f, 0 0 40px #f0f; }
.effect-anim-pulse { animation: pulse 2s infinite; }
.effect-anim-bounce { display: inline-block; animation: bounce 1s infinite; }
.effect-anim-shake { display: inline-block; animation: shake 0.5s infinite; }
.effect-anim-spin { display: inline-block; animation: spinText 2s linear infinite; }
@keyframes spinText { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
.effect-ice { color: #a5f2f3; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #a5f2f3, 0 0 30px #a5f2f3; }
.effect-water { color: #00bfff; text-shadow: 2px 2px 4px #00008b; animation: wave 2s infinite; }
@keyframes wave { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
.effect-lightning { color: #ffff00; text-shadow: 0 0 10px #fff, 0 0 20px #ffff00; animation: flash 1s infinite; }
@keyframes flash { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.5; } }
.effect-earth { color: #8b4513; text-shadow: 1px 1px 2px #228b22; }
.effect-hazard { color: #000; background: repeating-linear-gradient(45deg, #ff0, #ff0 10px, #000 10px, #000 20px); -webkit-background-clip: text; color: transparent !important; }
.effect-candy { background: repeating-linear-gradient(45deg, #ffc0cb, #ffc0cb 10px, #fff 10px, #fff 20px); -webkit-background-clip: text; color: transparent !important; }

/* THEMES */
.card-theme-default { background-color: #2b2d31; border: 1px solid #1e1f22; }
.card-theme-dark { background-color: #000000; border: 1px solid #333333; }
.card-theme-light { background-color: #ffffff; border: 1px solid #dddddd; color: #000000 !important; }
.card-theme-light h3, .card-theme-light span, .card-theme-light p { color: #000000 !important; }
.card-theme-light .text-gray-400 { color: #666666 !important; }
.card-theme-midnight { background: linear-gradient(to bottom, #191970, #000000); border: 1px solid #4169e1; }
.card-theme-ocean { background: linear-gradient(to bottom, #00b4db, #0083b0); border: 1px solid #00b4db; }
.card-theme-forest { background: linear-gradient(to bottom, #56ab2f, #a8e063); border: 1px solid #56ab2f; }
.card-theme-sunset { background: linear-gradient(to bottom, #ff5f6d, #ffc371); border: 1px solid #ff5f6d; }
.card-theme-royal { background: linear-gradient(to bottom, #5f2c82, #49a09d); border: 1px solid #5f2c82; }
.card-theme-cherry { background: linear-gradient(to bottom, #eb3349, #f45c43); border: 1px solid #eb3349; }
.card-theme-lavender { background: linear-gradient(to bottom, #aa4b6b, #6b6b83, #3b8d99); border: 1px solid #aa4b6b; }
.card-theme-gold { background: linear-gradient(to bottom, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); border: 1px solid #bf953f; color: #3e2723 !important; }
.card-theme-gold h3, .card-theme-gold span, .card-theme-gold p { color: #3e2723 !important; }
.card-theme-matrix { background-color: #000000; border: 1px solid #00ff00; color: #00ff00 !important; font-family: 'Courier New', monospace; }
.card-theme-matrix h3, .card-theme-matrix span, .card-theme-matrix p { color: #00ff00 !important; }
.card-theme-cyberpunk { background-color: #fcee0a; border: 2px solid #000; color: #000 !important; }
.card-theme-cyberpunk h3, .card-theme-cyberpunk span, .card-theme-cyberpunk p { color: #000 !important; }
.card-theme-retro { background-color: #ffdab9; border: 2px solid #ff4500; color: #8b4500 !important; }
.card-theme-retro h3, .card-theme-retro span, .card-theme-retro p { color: #8b4500 !important; }
.card-theme-hacker { background-color: #0d0208; border: 1px solid #00ff41; color: #00ff41 !important; }
.card-theme-hacker h3, .card-theme-hacker span, .card-theme-hacker p { color: #00ff41 !important; }
.card-theme-neon { background-color: #000; border: 1px solid #fff; box-shadow: 0 0 10px #fff, 0 0 20px #fff; }
.card-theme-galaxy { background: url('https://img.freepik.com/free-vector/galaxy-background-with-colorful-stardust_125540-549.jpg'); background-size: cover; border: 1px solid #fff; }
.card-theme-fire { background: linear-gradient(to bottom, #ff416c, #ff4b2b); border: 1px solid #ff416c; }
.card-theme-ice { background: linear-gradient(to bottom, #2980b9, #6dd5fa, #ffffff); border: 1px solid #2980b9; color: #003366 !important; }
.card-theme-ice h3, .card-theme-ice span, .card-theme-ice p { color: #003366 !important; }

.list-style-default { }
.list-style-glow { box-shadow: 0 0 5px rgba(255,255,255,0.2); }
.list-style-border { border: 1px solid rgba(255,255,255,0.1); }
.list-style-glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(5px); }
.list-style-neon { border-left: 2px solid #00ff00; background: linear-gradient(90deg, rgba(0,255,0,0.1), transparent); }
.list-style-gradient { background: linear-gradient(90deg, rgba(88,101,242,0.2), transparent); }
.notif-badge { position: absolute; top: -2px; right: -2px; background-color: #ef4444; color: white; font-size: 10px; font-weight: bold; height: 16px; min-width: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #313338; }
</style>
</head>
<body class="bg-[#313338] text-gray-100 font-sans antialiased h-screen flex flex-col overflow-hidden">

<!-- Auth View -->
<div id="auth-view" class="flex-1 flex flex-col justify-center items-center p-4 bg-[url('https://picsum.photos/1920/1080?blur=10')] bg-cover bg-center relative z-50">
    <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-md bg-[#2b2d31] rounded-lg shadow-2xl overflow-hidden">
        <div class="p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white">Welcome back!</h2>
                <p class="text-gray-400 text-sm">We're so excited to see you again!</p>
            </div>
            <div class="flex bg-[#1e1f22] p-1 rounded mb-6">
                <button id="tab-login" class="flex-1 py-1 text-sm font-medium rounded text-white bg-[#5865F2]" onclick="app.switchTab('login')">Login</button>
                <button id="tab-signup" class="flex-1 py-1 text-sm font-medium rounded text-gray-400 hover:text-gray-200" onclick="app.switchTab('signup')">Sign Up</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Email</label><input type="email" id="login-email" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded focus:ring-0 text-white transition-all"></div>
                <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Password</label><input type="password" id="login-password" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded focus:ring-0 text-white transition-all"></div>
                <button type="submit" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-medium py-2.5 rounded transition">Log In</button>
            </form>
            <form id="signup-form" class="space-y-4 hidden">
                <div class="flex justify-center mb-4">
                    <div class="w-24 h-24 rounded-full bg-[#1e1f22] relative group cursor-pointer hover:opacity-80 transition" onclick="document.getElementById('signup-pfp').click()">
                        <img id="pfp-preview" src="" class="w-full h-full rounded-full object-cover hidden">
                        <div id="pfp-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs text-center p-2">Upload PFP</div>
                        <div class="absolute bottom-0 right-0 bg-[#5865F2] rounded-full p-1 border-4 border-[#2b2d31]"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></div>
                    </div>
                    <input type="file" id="signup-pfp" accept="image/*" class="hidden">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Username</label><input type="text" id="signup-username" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white"></div>
                    <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Email</label><input type="email" id="signup-email" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Age</label><input type="number" id="signup-age" min="11" max="1000" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white"></div>
                    <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Gender</label><select id="signup-gender" class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white appearance-none"><option value="Alien">Alien</option><option value="Male">Male</option><option value="Female">Female</option><option value="Table">Table</option><option value="Chair">Chair</option><option value="Other">Other</option></select></div>
                </div>
                <div><label class="uppercase text-xs font-bold text-gray-400 mb-1 block">Password</label><input type="password" id="signup-password" required class="w-full px-3 py-2 bg-[#1e1f22] border-none rounded text-white"></div>
                <button type="submit" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-medium py-2.5 rounded transition">Continue</button>
            </form>
            <div id="auth-feedback" class="mt-4 text-center hidden"><p id="auth-error" class="text-red-400 text-xs"></p></div>
            <div id="auth-loader" class="hidden flex justify-center mt-4"><div class="loader"></div></div>
        </div>
    </div>
</div>

<!-- Main Application View -->
<div id="chat-view" class="hidden h-full w-full relative">
    <div class="flex-1 flex flex-col min-w-0 bg-[#313338]">
        <header class="bg-[#313338] border-b border-[#26272d] p-3 shadow-sm flex justify-between items-center h-16 shrink-0 z-10 relative">
            <div class="flex items-center gap-2 px-2">
                <button onclick="app.toggleHamburger()" class="text-gray-300 hover:text-white mr-2 relative z-20"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                <img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExMXBhNjNycTQweDFkY214NjMxYWtiZWs1ZjZ3dTJxb254d21ldHIyOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/HPbuRgMPF2vL2/giphy.gif" alt="Logo" class="h-10 object-contain">
            </div>
            
            <div id="hamburger-menu" class="hidden absolute top-16 left-2 w-48 bg-[#2b2d31] border border-[#1e1f22] rounded-lg shadow-xl z-50 overflow-hidden animate-fade-in">
                <button onclick="app.openNews()" class="w-full text-left px-4 py-3 hover:bg-[#35373c] text-white font-bold flex items-center gap-3 border-b border-[#1e1f22]"><i class="fas fa-newspaper text-purple-400"></i> News</button>
                <button onclick="app.openLeaderboard()" class="w-full text-left px-4 py-3 hover:bg-[#35373c] text-white font-bold flex items-center gap-3"><i class="fas fa-trophy text-yellow-400"></i> Leaderboard</button>
            </div>

            <div class="flex items-center gap-4">
                <!-- Notifications -->
                <div class="relative group">
                    <button onclick="app.toggleNotifications()" class="text-gray-400 hover:text-white transition relative" title="Notifications">
                        <i class="fas fa-bell text-lg"></i>
                        <div id="notif-badge" class="notif-badge hidden">0</div>
                    </button>
                    <div id="notif-menu" class="hidden absolute top-full right-0 mt-2 w-72 bg-[#111214] border border-[#1e1f22] rounded shadow-xl overflow-hidden z-50">
                        <div class="p-3 border-b border-[#1e1f22] text-xs font-bold text-gray-400 uppercase flex justify-between items-center">
                            <span>Notifications</span>
                            <button onclick="app.clearNotifications()" class="text-[10px] text-blue-400 hover:underline">Clear</button>
                        </div>
                        <div id="notif-list" class="max-h-64 overflow-y-auto p-1 space-y-1">
                            <div class="text-center text-gray-500 text-xs p-2">No notifications</div>
                        </div>
                    </div>
                </div>

                <!-- Friend Requests Button -->
                <div class="relative group">
                    <button onclick="app.toggleFriendMenu()" class="text-gray-400 hover:text-green-400 transition" title="Friend Requests">
                        <i class="fas fa-user-plus text-lg"></i>
                    </button>
                    <div id="friend-menu" class="hidden absolute top-full right-0 mt-2 w-64 bg-[#111214] border border-[#1e1f22] rounded shadow-xl overflow-hidden z-50">
                        <div class="p-3 border-b border-[#1e1f22] text-xs font-bold text-gray-400 uppercase">Friend Requests</div>
                        <div id="friend-menu-list" class="max-h-64 overflow-y-auto p-1 space-y-1">
                            <div class="text-center text-gray-500 text-xs p-2">No pending requests</div>
                        </div>
                    </div>
                </div>

                <button onclick="window.location.href='customise.html'" class="text-gray-400 hover:text-pink-400 transition" title="Customize"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg></button>
                <button onclick="window.location.href='game.html'" class="text-gray-400 hover:text-purple-400 transition" title="Orbitly Arcade"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" /></svg></button>
                <button onclick="app.openWallet()" class="text-gray-400 hover:text-yellow-400 transition" title="My Wallet"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg></button>
                <div class="flex items-center gap-1 bg-[#2b2d31] py-1 pl-2 pr-1 rounded hover:bg-[#35373c] transition relative group" id="user-menu-trigger">
                    <div class="flex items-center gap-3 cursor-pointer py-1 pr-2" onclick="app.openMyProfile()">
                        <div class="relative"><img id="current-user-pfp" src="https://ui-avatars.com/api/?name=?" class="w-8 h-8 rounded-full bg-gray-700 object-cover"><div id="current-user-status-dot" class="absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-[3px] border-[#2b2d31] status-online"></div></div>
                        <div class="flex flex-col"><span id="current-username" class="text-sm font-semibold text-white leading-tight">...</span><span id="current-status-text" class="text-[10px] text-gray-400 leading-tight">Loading</span></div>
                    </div>
                    <button class="p-1 rounded hover:bg-black/20 text-gray-400 hover:text-white" onclick="document.getElementById('status-dropdown').classList.toggle('hidden')"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button>
                    <div id="status-dropdown" class="hidden absolute top-full right-0 mt-2 w-48 bg-[#111214] rounded shadow-xl border border-[#1e1f22] overflow-hidden z-50">
                        <div class="p-2 space-y-1">
                            <button onclick="app.setStatus('online')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group"><div class="w-2.5 h-2.5 rounded-full status-online"></div> Online</button>
                            <button onclick="app.setStatus('busy')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group"><div class="w-2.5 h-2.5 rounded-full status-busy"></div> Busy</button>
                            <button onclick="app.setStatus('dnd')" class="w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group"><div class="w-2.5 h-2.5 rounded-full status-dnd"></div> Do Not Disturb</button>
                            <button id="btn-invisible" onclick="app.setStatus('invisible')" class="hidden w-full text-left px-2 py-1.5 rounded hover:bg-[#4752c4] hover:text-white text-gray-300 text-sm flex items-center gap-2 group border-t border-gray-800 mt-1 pt-2"><div class="w-2.5 h-2.5 rounded-full status-invisible border border-gray-500"></div> Invisible</button>
                            <button onclick="app.logout()" class="w-full text-left px-2 py-1.5 rounded hover:bg-red-500 hover:text-white text-red-400 text-sm flex items-center gap-2 mt-1 border-t border-gray-800 pt-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg> Log Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-1 scroll-smooth"></div>
        <div class="px-4 pb-4 bg-[#313338] relative">
            <div id="reply-bar" class="hidden absolute bottom-full left-4 right-4 mb-2 bg-[#2b2d31] border border-[#1e1f22] rounded-t-lg p-2 flex items-center justify-between reply-preview-anim z-10 shadow-lg">
                <div class="flex flex-col text-sm ml-2 overflow-hidden"><span class="text-gray-400 text-xs">Replying to <span id="reply-bar-username" class="font-bold text-gray-300">User</span></span><span id="reply-bar-text" class="text-gray-500 truncate italic">Message content...</span></div>
                <button onclick="cancelReply()" class="p-1 rounded-full hover:bg-gray-700 text-gray-400 hover:text-gray-200 transition mr-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <form id="message-form" class="bg-[#383a40] rounded-lg px-4 py-3 flex items-center w-full shadow-sm z-20 relative">
                <input type="text" id="message-input" autocomplete="off" placeholder="Message #general-chat (Type /cmds for help)" class="flex-1 bg-transparent border-none text-gray-100 placeholder-gray-500 focus:ring-0 focus:outline-none">
            </form>
        </div>
    </div>

    <!-- NEWS DRAWER -->
    <div id="news-drawer" class="fixed inset-y-0 left-0 w-full sm:w-96 bg-[#241b35] shadow-2xl z-40 transform -translate-x-full drawer-transition flex flex-col border-r border-[#1e1f22]">
        <div class="p-4 bg-[#2b2d31] border-b border-[#1e1f22] flex justify-between items-center shrink-0"><h2 class="text-xl font-bold text-white flex items-center gap-2"><i class="fas fa-newspaper text-purple-400"></i> News</h2><button onclick="app.closeNews()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
        <div id="admin-news-controls" class="hidden p-2 bg-[#1e1f22] border-b border-[#2b2d31]"><button onclick="app.openAddNews()" class="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-bold text-sm transition"><i class="fas fa-plus mr-2"></i> Add News Post</button></div>
        <div id="news-container" class="flex-1 overflow-y-auto p-4 space-y-4"><div id="news-empty" class="hidden flex flex-col items-center justify-center h-64 text-gray-500"><div class="w-16 h-16 bg-[#2b2d31] rounded-lg flex items-center justify-center mb-3"><i class="fas fa-exclamation-circle text-red-400 text-2xl"></i></div><p>No news to display</p></div></div>
    </div>

    <!-- LEADERBOARD DRAWER -->
    <div id="leaderboard-drawer" class="fixed inset-y-0 left-0 w-full sm:w-96 bg-[#202225] shadow-2xl z-40 transform -translate-x-full drawer-transition flex flex-col border-r border-[#1e1f22]">
        <div class="p-4 bg-[#2b2d31] border-b border-[#1e1f22] flex justify-between items-center shrink-0">
            <h2 class="text-xl font-bold text-white flex items-center gap-2"><i class="fas fa-trophy text-yellow-400"></i> Leaderboard</h2>
            <button onclick="app.closeLeaderboard()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        <div class="flex p-2 bg-[#1e1f22] gap-2">
            <button onclick="app.loadLeaderboard('coins')" id="lb-tab-coins" class="flex-1 py-2 bg-yellow-600/20 text-yellow-400 rounded border border-yellow-600/50 text-xs font-bold hover:bg-yellow-600/30 transition">Top Coins</button>
            <button onclick="app.loadLeaderboard('gems')" id="lb-tab-gems" class="flex-1 py-2 bg-[#2b2d31] text-gray-400 rounded border border-[#1e1f22] text-xs font-bold hover:text-purple-400 transition">Top Gems</button>
            <button onclick="app.loadLeaderboard('likes')" id="lb-tab-likes" class="flex-1 py-2 bg-[#2b2d31] text-gray-400 rounded border border-[#1e1f22] text-xs font-bold hover:text-red-400 transition">Top Likes</button>
        </div>
        <div id="leaderboard-list" class="flex-1 overflow-y-auto p-2 leaderboard-scroll">
            <div class="flex items-center justify-center h-full text-gray-500"><div class="loader"></div></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="add-news-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-md border border-[#1e1f22] relative p-6">
            <h3 class="text-white font-bold text-lg mb-4">Post News</h3>
            <div class="space-y-4">
                <textarea id="news-text-input" rows="4" class="w-full bg-[#1e1f22] text-white rounded p-3 border border-gray-700 focus:border-purple-500 outline-none resize-none" placeholder="Type news here..."></textarea>
                <div class="relative group cursor-pointer border-2 border-dashed border-gray-600 hover:border-purple-500 rounded-lg p-4 transition text-center" onclick="document.getElementById('news-image-input').click()">
                    <img id="news-image-preview" src="" class="hidden max-h-40 mx-auto rounded mb-2">
                    <div id="news-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-cloud-upload-alt text-2xl mb-2"></i><br>Click to upload image</div>
                    <input type="file" id="news-image-input" class="hidden" accept="image/*">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6"><button onclick="document.getElementById('add-news-modal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button><button onclick="app.postNews()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-bold">Send</button></div>
        </div>
    </div>
    
    <div id="news-comments-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-md border border-[#1e1f22] relative flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-[#1e1f22] flex justify-between items-center bg-[#202225]"><h3 class="text-white font-bold">Comments</h3><button onclick="document.getElementById('news-comments-modal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button></div>
            <div id="news-comments-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-3 border-t border-[#1e1f22] bg-[#202225] flex gap-2"><input type="text" id="news-comment-input" placeholder="Write a comment..." class="flex-1 bg-[#1e1f22] text-white rounded px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-purple-500"><button id="btn-post-comment" class="text-purple-400 hover:text-white font-bold text-sm px-2">Post</button></div>
        </div>
    </div>

    <!-- Mod Tools Modal -->
    <div id="mod-actions-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 room-modal">
        <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-sm border border-[#1e1f22] p-6 relative flex flex-col gap-3">
            <h3 class="text-white font-bold text-lg mb-2 text-center uppercase tracking-widest border-b border-gray-700 pb-2">Mod Actions</h3>
            <p id="mod-target-name" class="text-center text-gray-400 text-sm mb-2"></p>
            
            <button id="mod-btn-mute" class="hidden w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded">Mute User</button>
            <button id="mod-btn-kick" class="hidden w-full py-2 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded">Kick User</button>
            <button id="mod-btn-ban" class="hidden w-full py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded">Ban User</button>
            <button id="mod-btn-rank" onclick="app.openRankMenu()" class="hidden w-full py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded">Set Rank</button>

            <button onclick="document.getElementById('mod-actions-modal').classList.add('hidden')" class="mt-2 text-gray-400 hover:text-white text-sm">Cancel</button>
        </div>
    </div>

    <!-- Rank Selection Modal -->
    <div id="mod-rank-modal" class="absolute inset-0 z-[60] hidden bg-black/90 backdrop-blur-md flex items-center justify-center p-4 room-modal">
        <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-sm border border-[#1e1f22] p-6 relative">
            <h3 class="text-white font-bold text-lg mb-4 text-center">Select New Rank</h3>
            <select id="rank-select-dropdown" class="w-full bg-[#1e1f22] text-white p-2 rounded border border-gray-700 mb-4 outline-none">
                <!-- Populated by JS -->
            </select>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('mod-rank-modal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="app.submitRankChange()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold">Save Rank</button>
            </div>
        </div>
    </div>

    <div class="w-60 bg-[#2b2d31] flex flex-col shrink-0 border-l border-[#1e1f22]">
        <div class="h-16 flex items-center justify-center border-b border-[#1e1f22]"></div>
        <div id="online-list" class="flex-1 overflow-y-auto p-3 space-y-0.5"></div>
    </div>
    <div id="wallet-modal" class="absolute inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-[#2b2d31] rounded-xl shadow-2xl p-6 w-80 transform transition-all scale-100 border border-[#1e1f22] relative">
            <button onclick="app.closeWallet()" class="absolute top-2 right-2 text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div class="text-center mb-6"><h3 class="text-xl font-bold text-white uppercase tracking-wider">My Wallet</h3></div>
            <div class="space-y-4">
                <div class="bg-[#1e1f22] p-4 rounded-lg flex justify-between items-center"><span class="text-yellow-500 font-bold uppercase text-sm">Coins</span><span id="wallet-coins" class="text-white text-lg font-mono">0</span></div>
                <div class="bg-[#1e1f22] p-4 rounded-lg flex justify-between items-center"><span class="text-purple-400 font-bold uppercase text-sm">Gems</span><span id="wallet-gems" class="text-white text-lg font-mono">0</span></div>
            </div>
        </div>
    </div>
    
    <div id="profile-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div id="profile-card-content" class="card-theme-default rounded-xl shadow-2xl w-full max-w-sm overflow-hidden relative transform transition-all scale-100 flex flex-col max-h-[85vh]">
            <!-- Banner Section -->
            <div class="h-40 bg-gray-700 relative shrink-0">
                <img id="profile-banner" src="" class="w-full h-full object-cover">
                <div id="profile-banner-placeholder" class="absolute inset-0 profile-header-gradient hidden"></div>
                
                <!-- Top Left: Like Button -->
                <div class="absolute top-3 left-3 z-10">
                    <button id="btn-toggle-like" class="bg-black/40 hover:bg-black/60 backdrop-blur-md border border-white/10 rounded-lg px-3 py-1.5 flex items-center gap-2 transition group">
                        <i id="profile-like-icon" class="far fa-heart text-white group-hover:text-red-500 transition"></i>
                        <span id="profile-likes-count" class="text-xs font-bold text-white">0</span>
                    </button>
                </div>

                <!-- Top Right: Actions & Close -->
                <div class="absolute top-3 right-3 z-10 flex items-center gap-2">
                    <!-- Lightning Button (Mod+) -->
                    <button id="profile-mod-btn" class="hidden w-8 h-8 flex items-center justify-center bg-black/40 hover:bg-yellow-500/80 backdrop-blur-md border border-white/10 rounded-lg text-yellow-400 hover:text-white transition shadow-[0_0_10px_rgba(234,179,8,0.5)]">
                        <i class="fas fa-bolt"></i>
                    </button>

                    <!-- User Actions -->
                    <div id="profile-actions-container" class="flex gap-2">
                        <button id="profile-edit-btn" onclick="app.openEditProfile()" class="hidden w-8 h-8 flex items-center justify-center bg-black/40 hover:bg-black/60 backdrop-blur-md border border-white/10 rounded-lg text-white transition">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                        <button id="profile-msg-btn" class="hidden w-8 h-8 flex items-center justify-center bg-black/40 hover:bg-black/60 backdrop-blur-md border border-white/10 rounded-lg text-white transition" title="Message">
                            <i class="fas fa-envelope text-xs"></i>
                        </button>
                        <button id="profile-friend-btn" class="hidden w-8 h-8 flex items-center justify-center bg-black/40 hover:bg-black/60 backdrop-blur-md border border-white/10 rounded-lg text-white transition" title="Add Friend">
                            <i class="fas fa-user-plus text-xs"></i>
                        </button>
                    </div>
                    <!-- Close Button -->
                    <button onclick="app.closeProfile()" class="w-8 h-8 flex items-center justify-center bg-black/40 hover:bg-red-500/80 backdrop-blur-md border border-white/10 rounded-lg text-white transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="px-6 pb-6 pt-14 relative flex-1 flex flex-col min-h-0 bg-transparent">
                <!-- PFP (Absolute positioned to overlap banner) -->
                <div class="absolute -top-12 left-1/2 transform -translate-x-1/2">
                    <div class="relative group">
                        <img id="profile-pfp" src="" class="w-24 h-24 rounded-2xl border-4 border-[#2b2d31] bg-[#2b2d31] object-cover shadow-lg">
                        <div id="profile-status-indicator" class="absolute -bottom-1 -right-1 w-5 h-5 bg-[#2b2d31] rounded-full flex items-center justify-center">
                            <div id="profile-status-dot" class="w-3 h-3 rounded-full status-online"></div>
                        </div>
                    </div>
                </div>

                <!-- Identity -->
                <div class="text-center mb-4">
                    <div id="profile-rank-container" class="flex justify-center mb-1"></div>
                    <h3 id="profile-username" class="text-xl font-black text-white leading-tight break-words tracking-wide"></h3>
                </div>

                <!-- Tabs -->
                <div class="flex p-1 bg-[#111214]/50 rounded-lg mb-4 shrink-0">
                    <button id="tab-profile-info" onclick="app.switchProfileTab('info')" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-[#5865F2] text-white shadow-sm transition">Info</button>
                    <button id="tab-profile-about" onclick="app.switchProfileTab('about')" class="flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition">About me</button>
                </div>

                <!-- Tab Content -->
                <div id="content-profile-info" class="flex-1 overflow-y-auto space-y-3">
                    <div class="bg-[#111214]/50 rounded-xl p-3 border border-white/5 grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider"><i class="fas fa-birthday-cake mr-1"></i> Age</span>
                            <span id="profile-age" class="text-sm font-bold text-white"></span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider"><i class="fas fa-venus-mars mr-1"></i> Gender</span>
                            <span id="profile-gender" class="text-sm font-bold text-white"></span>
                        </div>
                    </div>
                    <div class="bg-[#111214]/50 rounded-xl p-3 border border-white/5 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider flex items-center gap-2"><i class="fas fa-coins text-yellow-500"></i> Coins</span>
                            <span id="profile-coins" class="text-sm font-mono font-bold text-white"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider flex items-center gap-2"><i class="fas fa-gem text-purple-400"></i> Gems</span>
                            <span id="profile-gems" class="text-sm font-mono font-bold text-white"></span>
                        </div>
                    </div>
                    <div class="text-center pt-2">
                        <span id="profile-joined" class="text-[10px] font-bold text-gray-600 uppercase tracking-widest"></span>
                    </div>
                </div>

                <div id="content-profile-about" class="hidden flex-1 overflow-y-auto min-h-0">
                    <div class="bg-[#111214]/30 rounded-xl p-4 border border-white/5 min-h-full">
                        <p id="profile-bio" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-medium"></p>
                        <div id="profile-bio-empty" class="hidden text-center text-gray-500 text-xs italic py-4">No bio yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-md border border-[#1e1f22] relative flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-[#1e1f22] flex justify-between items-center"><h3 class="text-white font-bold text-lg">Edit Profile</h3><button onclick="app.closeEditProfile()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
            <div class="overflow-y-auto p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs uppercase font-bold text-gray-400 mb-2">Avatar</label><div class="relative group cursor-pointer" onclick="document.getElementById('edit-pfp-input').click()"><img id="edit-pfp-preview" src="" class="w-20 h-20 rounded-full bg-gray-700 object-cover border-2 border-gray-600 group-hover:border-white transition"><div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition text-xs text-white">Change</div></div><input type="file" id="edit-pfp-input" class="hidden" accept="image/*"></div>
                    <div><label class="block text-xs uppercase font-bold text-gray-400 mb-2">Banner</label><div class="relative group cursor-pointer h-20 w-full" onclick="document.getElementById('edit-banner-input').click()"><img id="edit-banner-preview" src="" class="w-full h-full bg-gray-700 object-cover rounded border-2 border-gray-600 group-hover:border-white transition"><div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded opacity-0 group-hover:opacity-100 transition text-xs text-white">Change</div></div><input type="file" id="edit-banner-input" class="hidden" accept="image/*"></div>
                </div>
                <div class="space-y-4">
                    <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Username</label><input type="text" id="edit-username" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white focus:border-[#5865F2] outline-none"></div>
                    <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Bio</label><textarea id="edit-bio" rows="2" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white focus:border-[#5865F2] outline-none resize-none" placeholder="Tell us about yourself..."></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Age</label><input type="number" id="edit-age" min="11" max="1000" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white outline-none"></div>
                        <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Gender</label><select id="edit-gender" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white outline-none"><option value="Alien">Alien</option><option value="Male">Male</option><option value="Female">Female</option><option value="Table">Table</option><option value="Chair">Chair</option><option value="Other">Other</option></select></div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-[#1e1f22] flex justify-end gap-3"><button onclick="app.closeEditProfile()" class="px-4 py-2 rounded text-gray-300 hover:text-white hover:bg-[#3f4147] transition">Cancel</button><button onclick="app.saveProfile()" class="px-4 py-2 rounded bg-[#5865F2] hover:bg-[#4752c4] text-white font-bold transition">Save Changes</button></div>
        </div>
    </div>
    <!-- Toast Notification -->
    <div id="toast-container" class="absolute bottom-20 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none"></div>
</div>

<!-- Modals for Rooms -->
<div id="create-room-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 room-modal">
    <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-md border border-[#1e1f22] p-6 relative">
        <h3 class="text-white font-bold text-lg mb-4">Create Room</h3>
        <div class="space-y-4">
            <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Room Name</label><input type="text" id="room-name-input" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white focus:border-[#5865F2] outline-none" placeholder="e.g. VIP Lounge"></div>
             <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Room Icon (Emoji or URL)</label><input type="text" id="room-icon-input" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white focus:border-[#5865F2] outline-none" placeholder="e.g.  or https://..."></div>
            <div><label class="block text-xs uppercase font-bold text-gray-400 mb-1">Password (Optional)</label><input type="password" id="room-password-input" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white focus:border-[#5865F2] outline-none" placeholder="Leave empty for public"></div>
        </div>
        <div class="flex justify-end gap-3 mt-6"><button onclick="document.getElementById('create-room-modal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button><button onclick="window.app.createRoomSubmit()" class="px-6 py-2 bg-[#5865F2] hover:bg-[#4752c4] text-white rounded font-bold">Create</button></div>
    </div>
</div>
<div id="password-room-modal" class="absolute inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 room-modal">
    <div class="bg-[#2b2d31] rounded-xl shadow-2xl w-full max-w-sm border border-[#1e1f22] p-6 relative">
        <h3 class="text-white font-bold text-lg mb-2">Locked Room </h3>
        <p class="text-gray-400 text-sm mb-4">Enter the password to join this room.</p>
        <input type="password" id="join-room-password" class="w-full px-3 py-2 bg-[#1e1f22] border border-gray-700 rounded text-white focus:border-[#5865F2] outline-none mb-4" placeholder="Password">
        <div class="flex justify-end gap-3"><button onclick="document.getElementById('password-room-modal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button><button onclick="window.app.submitRoomPassword()" class="px-6 py-2 bg-[#5865F2] hover:bg-[#4752c4] text-white rounded font-bold">Enter</button></div>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc, where, getDocs, limit, runTransaction, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBz9yOlQFZQZE-GtGcRbJ2sWUYQTb0kBi4", authDomain: "orbitly-online.firebaseapp.com", projectId: "orbitly-online", storageBucket: "orbitly-online.firebasestorage.app", messagingSenderId: "75415636853", appId: "1:75415636853:web:ccf4ac9c74a1769335a13c", measurementId: "G-9B5458S73M" };
const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);

// --- GLOBALS ---
const SUFFIXES = { 'k': 1e3, 'm': 1e6, 'b': 1e9, 't': 1e12, 'qa': 1e15, 'qi': 1e18, 'sx': 1e21, 'sp': 1e24, 'oc': 1e27, 'no': 1e30, 'dc': 1e33, 'ud': 1e36, 'dd': 1e39, 'td': 1e42, 'qad': 1e45, 'qid': 1e48, 'sxd': 1e51, 'spd': 1e54, 'ocd': 1e57, 'nod': 1e60, 'vg': 1e63, 'uvg': 1e66, 'dvg': 1e69, 'tvg': 1e72, 'qavg': 1e75, 'qivg': 1e78, 'sxvg': 1e81, 'spvg': 1e84, 'ocvg': 1e87, 'novg': 1e90, 'tg': 1e93, 'utg': 1e96, 'dtg': 1e99, 'ttg': 1e102, 'qatg': 1e105, 'qitg': 1e108, 'sxtg': 1e111, 'sptg': 1e114, 'octg': 1e117, 'notg': 1e120, 'qg': 1e123, 'uqg': 1e126, 'dqg': 1e129, 'tqg': 1e132, 'qaqg': 1e135, 'qiqg': 1e138, 'sxqg': 1e141, 'spqg': 1e144, 'ocqg': 1e147, 'noqg': 1e150 };
const SORTED_SUFFIXES = Object.entries(SUFFIXES).sort((a, b) => b[1] - a[1]);
const bannedWords = ["nemo", "levi"];
function checkProfanity(text) { return bannedWords.some(w => text.toLowerCase().includes(w)); }
function filterText(text) { return bannedWords.reduce((acc, w) => acc.replace(new RegExp(w, "gi"), "*".repeat(w.length)), text); }
function parseAbbreviatedNumber(input) { if (!input) return NaN; input = input.toLowerCase().replace(/,/g, ''); if (input === 'all') return 'all'; for (const [suffix, value] of SORTED_SUFFIXES) { if (input.endsWith(suffix)) { const numPart = input.slice(0, -suffix.length); const val = parseFloat(numPart); if (isNaN(val)) return NaN; return Math.floor(val * value); } } return Math.floor(parseFloat(input)); }
function formatNumber(num) { if (num === undefined || num === null || isNaN(num)) return "0"; if (num < 1000) return Math.floor(num).toLocaleString(); for (const [suffix, value] of SORTED_SUFFIXES) { if (num >= value) { const formatted = (num / value).toFixed(2).replace(/\.0+$/, '').replace(/(\.[0-9]*[1-9])0+$/, '$1'); return formatted + suffix; } } return Math.floor(num).toLocaleString(); }

let currentUser = null;
let currentUserProfile = null;
let unsubscribeMessages = null;
let unsubscribeUsers = null;
let unsubscribeRooms = null;
let unsubscribeNews = null;
let unsubscribeDMs = null;
let unsubscribeNotifs = null;
let currentNewsIdForComments = null;
let replyingTo = null;
let pendingRoomJoin = null;
let currentModTarget = null;
let lastRank = null;
window.currentRoomId = 'general';
window.sidebarMode = 'users';

const els = {
authView: document.getElementById('auth-view'),
chatView: document.getElementById('chat-view'),
forms: { login: document.getElementById('login-form'), signup: document.getElementById('signup-form') },
tabs: { login: document.getElementById('tab-login'), signup: document.getElementById('tab-signup') },
inputs: { signupPfp: document.getElementById('signup-pfp'), msg: document.getElementById('message-input'), newsText: document.getElementById('news-text-input'), newsImg: document.getElementById('news-image-input'), newsComment: document.getElementById('news-comment-input') },
displays: {
pfpPreview: document.getElementById('pfp-preview'), pfpPlaceholder: document.getElementById('pfp-placeholder'), error: document.getElementById('auth-error'), loader: document.getElementById('auth-loader'), feedback: document.getElementById('auth-feedback'), msgContainer: document.getElementById('messages-container'), onlineList: document.getElementById('online-list'),
headerPfp: document.getElementById('current-user-pfp'), headerName: document.getElementById('current-username'), headerStatusText: document.getElementById('current-status-text'), headerStatusDot: document.getElementById('current-user-status-dot'), statusDropdown: document.getElementById('status-dropdown'), invisibleBtn: document.getElementById('btn-invisible'), walletModal: document.getElementById('wallet-modal'), walletCoins: document.getElementById('wallet-coins'), walletGems: document.getElementById('wallet-gems'), profileModal: document.getElementById('profile-modal'), toastContainer: document.getElementById('toast-container'),
editModal: document.getElementById('edit-profile-modal'), editPfpInput: document.getElementById('edit-pfp-input'), editBannerInput: document.getElementById('edit-banner-input'), editPfpPreview: document.getElementById('edit-pfp-preview'), editBannerPreview: document.getElementById('edit-banner-preview'),
replyBar: document.getElementById('reply-bar'), replyBarUser: document.getElementById('reply-bar-username'), replyBarText: document.getElementById('reply-bar-text'),
newsDrawer: document.getElementById('news-drawer'), newsContainer: document.getElementById('news-container'), newsEmpty: document.getElementById('news-empty'), addNewsModal: document.getElementById('add-news-modal'), newsImgPreview: document.getElementById('news-image-preview'), newsImgPlaceholder: document.getElementById('news-image-placeholder'), commentsModal: document.getElementById('news-comments-modal'), commentsList: document.getElementById('news-comments-list'),
leaderboardDrawer: document.getElementById('leaderboard-drawer'), leaderboardList: document.getElementById('leaderboard-list'), friendMenu: document.getElementById('friend-menu'), friendMenuList: document.getElementById('friend-menu-list'),
notifMenu: document.getElementById('notif-menu'), notifList: document.getElementById('notif-list'), notifBadge: document.getElementById('notif-badge'),
modModal: document.getElementById('mod-actions-modal'), rankModal: document.getElementById('mod-rank-modal'), rankSelect: document.getElementById('rank-select-dropdown')
}
};

function processImage(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const MAX_SIZE = 300; let width = img.width; let height = img.height; if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.85)); }; img.onerror = (err) => reject(err); }; img.onerror = (err) => reject(err); }); }
async function processUpload(file) { const limit = 500 * 1024; if (file.type === 'image/gif' && file.size < limit) { const reader = new FileReader(); return new Promise((resolve) => { reader.onload = (ev) => resolve(ev.target.result); reader.readAsDataURL(file); }); } return await processImage(file); }

// --- RANK SYSTEM ---
const RANK_ORDER = {
    'developer': 100,
    'founder': 90, 'ceo': 90, 'head-owner': 90,
    'owner': 85, 'co-owner': 85,
    'super-admin': 80, 'admin': 80,
    'mod': 75, 'site-helper': 75,
    'trial mod': 74,
    'mega-elite': 70,
    'mega-vip': 65, 'super-vip': 65, 'ultra-vip': 65,
    'elite': 60,
    'premium': 50,
    'vip': 40,
    'knight': 30, 'queen': 30, 'princess': 30,
    'default': 0
};

const RANK_FILES = {
    'developer': 'ranks/developer.gif',
    'ceo': 'ranks/CEO.gif',
    'founder': 'ranks/CEO.gif',
    'head-owner': 'ranks/CEO.gif',
    'owner': 'ranks/owner.png',
    'co-owner': 'ranks/owner.png',
    'mod': 'ranks/mod.png',
    'trial mod': 'ranks/mod.png',
    'site-helper': 'ranks/mod.png',
    'mega-elite': 'ranks/mega-elite.gif',
    'mega-vip': 'ranks/mega-vip.gif',
    'elite': 'ranks/elite.png',
    'premium': 'ranks/premium.gif',
    'vip': 'ranks/vip.gif'
};

function getRankValue(rank) {
    if (!rank) return 0;
    return RANK_ORDER[rank.toLowerCase()] || 0;
}

function getRankHtml(rank, showText = false) {
    if (!rank) return '';
    const r = rank.toLowerCase();
    const iconUrl = RANK_FILES[r];
    
    let classes = 'bg-gray-600 text-gray-200';
    if (r === 'developer') classes = 'bg-gradient-to-r from-red-600 to-black border border-red-500 text-red-100 shadow-[0_0_10px_rgba(220,38,38,0.5)]';
    else if (['founder', 'ceo', 'head-owner', 'owner', 'co-owner'].includes(r)) classes = 'bg-gradient-to-r from-yellow-500 to-yellow-800 border border-yellow-400 text-yellow-100 shadow-[0_0_8px_rgba(234,179,8,0.4)]';
    else if (['super-admin', 'admin'].includes(r)) classes = 'bg-red-600 text-white';
    else if (['mod', 'trial mod', 'site-helper'].includes(r)) classes = 'bg-green-600 text-white';
    else if (['super-vip', 'mega-vip', 'ultra-vip'].includes(r)) classes = 'bg-gradient-to-r from-purple-500 to-pink-500 text-white';
    else if (['vip', 'elite', 'mega-elite', 'premium'].includes(r)) classes = 'bg-purple-600 text-purple-100';
    else if (['knight', 'queen', 'princess'].includes(r)) classes = 'bg-pink-500 text-white';

    const badgeHtml = `<span class="rank-badge ${classes}">${escapeHtml(rank)}</span>`;
    
    if (iconUrl) {
        const imgHtml = `<img src="${iconUrl}" class="h-4 w-auto inline-block mr-1 align-middle" title="${escapeHtml(rank)}">`;
        if (showText) return `<div class="inline-flex items-center justify-center gap-1">${imgHtml} ${badgeHtml}</div>`;
        else return imgHtml;
    }
    return badgeHtml;
}

// --- PERMISSIONS HELPERS ---
function getPermissions(rank) {
    const r = rank ? rank.toLowerCase() : 'default';
    const val = RANK_ORDER[r] || 0;
    // Permissions logic based on prompt
    const isTrialMod = r === 'trial mod';
    const isModOrAdmin = ['mod', 'site-helper', 'admin'].includes(r);
    const isSuperAdmin = ['super-admin'].includes(r);
    const isHighRank = val >= 85; // Co-Owner+
    const isDev = r === 'developer';

    // Everyone Trial Mod (74) and up can Mute
    const canMute = val >= 74; 
    
    // Super-Admin (80) and up can Kick and Rank
    const canKick = val >= 80;
    const canRank = val >= 80;

    // Co-Owner (85) and up can Ban
    const canBan = val >= 85;

    return { canMute, canKick, canBan, canRank, val };
}

// --- RENDER HELPERS ---
function applyUsernameStyle(el, style) {
if (!style) { el.className = "font-bold text-white text-lg font-default"; el.style.color = ""; el.style.textShadow = ""; el.style.webkitTextStroke = ""; return; }
el.className = `font-bold text-lg ${style.font || 'font-default'}`; el.style.color = ""; el.style.textShadow = ""; el.style.webkitTextStroke = ""; el.removeAttribute('data-text');
const fx = style.effect || 'effect-none';
el.classList.add(fx);
if (['effect-outline', 'effect-outline-thick', 'effect-glow', 'effect-glow-strong', 'effect-emboss', 'effect-inset'].includes(fx)) { el.style.color = style.color; }
else if (fx.startsWith('effect-gradient') || fx.startsWith('effect-anim') || fx === 'effect-rainbow' || fx === 'effect-fire' || fx === 'effect-hazard' || fx === 'effect-candy') { }
else if (fx === 'effect-glitch') { el.setAttribute('data-text', el.textContent); el.style.color = style.color; }
else if (fx.startsWith('effect-neon') || fx === 'effect-ice' || fx === 'effect-water' || fx === 'effect-lightning' || fx === 'effect-earth') { }
else { el.style.color = style.color; }
}

// --- APP METHODS ---
window.app = {
switchTab: (tab) => { els.displays.feedback.classList.add('hidden'); if (tab === 'login') { els.forms.login.classList.remove('hidden'); els.forms.signup.classList.add('hidden'); els.tabs.login.className = "flex-1 py-1 text-sm font-medium rounded text-white bg-[#5865F2] transition"; els.tabs.signup.className = "flex-1 py-1 text-sm font-medium rounded text-gray-400 hover:text-gray-200 transition"; } else { els.forms.login.classList.add('hidden'); els.forms.signup.classList.remove('hidden'); els.tabs.signup.className = "flex-1 py-1 text-sm font-medium rounded text-white bg-[#5865F2] transition"; els.tabs.login.className = "flex-1 py-1 text-sm font-medium rounded text-gray-400 hover:text-gray-200 transition"; } },
logout: () => { if (currentUser && currentUserProfile && currentUserProfile.status !== 'invisible') { updateDoc(doc(db, "users", currentUser.uid), { status: 'offline' }).then(() => signOut(auth)); } else { signOut(auth); } },
setStatus: async (status) => { if (!currentUser) return; try { await updateDoc(doc(db, "users", currentUser.uid), { status: status }); els.displays.statusDropdown.classList.add('hidden'); } catch (e) { console.error("Status update failed", e); } },
openWallet: () => { if (currentUserProfile) { els.displays.walletCoins.textContent = formatNumber(currentUserProfile.coins || 0); els.displays.walletGems.textContent = formatNumber(currentUserProfile.gems || 0); } els.displays.walletModal.classList.remove('hidden'); },
closeWallet: () => { els.displays.walletModal.classList.add('hidden'); },
openProfile: async (uid) => {
    try {
        const snap = await getDoc(doc(db, "users", uid));
        if(snap.exists()) {
            const data = snap.data();
            
            // Send Notification for Profile View (Debounced simply by not sending if it's me)
            if (currentUser && currentUser.uid !== uid) {
                app.sendNotification(uid, 'view', `${currentUserProfile.username} viewed your profile.`, currentUserProfile.pfpUrl);
            }

            // Populate Images
            document.getElementById('profile-pfp').src = data.pfpUrl || 'https://ui-avatars.com/api/?name=?';
            const bannerEl = document.getElementById('profile-banner');
            const bannerPlace = document.getElementById('profile-banner-placeholder');
            if (data.bannerUrl) {
                bannerEl.src = data.bannerUrl;
                bannerEl.classList.remove('hidden');
                bannerPlace.classList.add('hidden');
            } else {
                bannerEl.classList.add('hidden');
                bannerPlace.classList.remove('hidden');
            }

            // Identity
            const nameEl = document.getElementById('profile-username');
            nameEl.textContent = data.username;
            applyUsernameStyle(nameEl, data.usernameStyle); 
            
            document.getElementById('profile-rank-container').innerHTML = getRankHtml(data.rank || 'VIP', true);

            // Theme
            const cardEl = document.getElementById('profile-card-content');
            cardEl.className = "rounded-xl shadow-2xl w-full max-w-sm overflow-hidden relative transform transition-all scale-100 flex flex-col max-h-[85vh]";
            cardEl.classList.add(data.usercardStyle || 'card-theme-default');

            // Stats
            document.getElementById('profile-age').textContent = data.age || 'N/A';
            document.getElementById('profile-gender').textContent = data.gender || 'N/A';
            document.getElementById('profile-coins').textContent = formatNumber(data.coins || 0);
            document.getElementById('profile-gems').textContent = formatNumber(data.gems || 0);
            const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            document.getElementById('profile-joined').textContent = `MEMBER SINCE ${date}`;

            // Status Dot
            const status = (data.status || 'offline');
            const dot = document.getElementById('profile-status-dot');
            dot.className = "w-3 h-3 rounded-full";
            if (status === 'online') dot.classList.add('status-online');
            else if (status === 'busy') dot.classList.add('status-busy');
            else if (status === 'dnd') dot.classList.add('status-dnd');
            else dot.classList.add('status-offline');

            // Bio
            const bioEl = document.getElementById('profile-bio');
            const bioEmpty = document.getElementById('profile-bio-empty');
            if (data.bio) {
                bioEl.textContent = data.bio;
                bioEl.classList.remove('hidden');
                bioEmpty.classList.add('hidden');
            } else {
                bioEl.classList.add('hidden');
                bioEmpty.classList.remove('hidden');
            }

            // Controls
            const editBtn = document.getElementById('profile-edit-btn');
            const msgBtn = document.getElementById('profile-msg-btn');
            const friendBtn = document.getElementById('profile-friend-btn');
            const modBtn = document.getElementById('profile-mod-btn');

            // Mod Button Logic
            modBtn.classList.add('hidden');
            if (currentUser && currentUser.uid !== uid) {
                const myPerms = getPermissions(currentUserProfile.rank);
                if (myPerms.canMute) {
                    modBtn.classList.remove('hidden');
                    modBtn.onclick = () => app.openModMenu(uid, data.username, data.rank);
                }
            }

            if (currentUser && currentUser.uid === uid) {
                editBtn.classList.remove('hidden');
                msgBtn.classList.add('hidden');
                friendBtn.classList.add('hidden');
            } else {
                editBtn.classList.add('hidden');
                msgBtn.classList.remove('hidden');
                friendBtn.classList.remove('hidden');
                msgBtn.onclick = () => app.openDM(uid, data.username);
                
                const myFriends = (currentUserProfile && currentUserProfile.friends) ? currentUserProfile.friends : [];
                const mySent = (currentUserProfile && currentUserProfile.sentFriendRequests) ? currentUserProfile.sentFriendRequests : [];
                const myIncoming = (currentUserProfile && currentUserProfile.friendRequests) ? currentUserProfile.friendRequests : [];

                friendBtn.className = "w-8 h-8 flex items-center justify-center bg-black/40 hover:bg-black/60 backdrop-blur-md border border-white/10 rounded-lg text-white transition";
                friendBtn.onclick = null;

                if (myFriends.includes(uid)) {
                    friendBtn.innerHTML = '<i class="fas fa-user-minus text-red-400 text-xs"></i>';
                    friendBtn.title = "Unfriend";
                    friendBtn.onclick = () => app.removeFriend(uid);
                } else if (mySent.includes(uid)) {
                    friendBtn.innerHTML = '<i class="fas fa-clock text-gray-400 text-xs"></i>';
                    friendBtn.className += " cursor-default opacity-50";
                    friendBtn.title = "Request Sent";
                } else if (myIncoming.includes(uid)) {
                    friendBtn.innerHTML = '<i class="fas fa-check text-green-400 text-xs"></i>';
                    friendBtn.title = "Accept Request";
                    friendBtn.onclick = () => app.acceptFriend(uid);
                } else {
                    friendBtn.innerHTML = '<i class="fas fa-user-plus text-xs"></i>';
                    friendBtn.title = "Add Friend";
                    friendBtn.onclick = () => app.sendFriendRequest(uid);
                }
            }

            const likes = (data.likes && Array.isArray(data.likes)) ? data.likes : [];
            const isLiked = likes.includes(currentUser.uid);
            document.getElementById('profile-likes-count').textContent = formatNumber(likes.length);
            const likeIcon = document.getElementById('profile-like-icon');
            if (isLiked) {
                likeIcon.className = "fas fa-heart text-red-500 transition";
            } else {
                likeIcon.className = "far fa-heart text-white group-hover:text-red-500 transition";
            }
            document.getElementById('btn-toggle-like').onclick = () => app.toggleLike(uid);

            app.switchProfileTab('info');
            els.displays.profileModal.classList.remove('hidden');
        }
    } catch(e) { console.error(e); }
},

// --- MODERATION ---
openModMenu: (targetUid, targetName, targetRank) => {
    currentModTarget = { uid: targetUid, name: targetName, rank: targetRank };
    document.getElementById('mod-target-name').textContent = `Actions for ${targetName}`;
    els.displays.modModal.classList.remove('hidden');
    
    // Check perms
    const myPerms = getPermissions(currentUserProfile.rank);
    const muteBtn = document.getElementById('mod-btn-mute');
    const kickBtn = document.getElementById('mod-btn-kick');
    const banBtn = document.getElementById('mod-btn-ban');
    const rankBtn = document.getElementById('mod-btn-rank');

    muteBtn.classList.add('hidden');
    kickBtn.classList.add('hidden');
    banBtn.classList.add('hidden');
    rankBtn.classList.add('hidden');

    if (myPerms.canMute) muteBtn.classList.remove('hidden');
    if (myPerms.canKick) kickBtn.classList.remove('hidden');
    if (myPerms.canBan) banBtn.classList.remove('hidden');
    if (myPerms.canRank) rankBtn.classList.remove('hidden');
},

openRankMenu: () => {
    if (!currentModTarget) return;
    els.displays.modModal.classList.add('hidden');
    els.displays.rankModal.classList.remove('hidden');
    
    const myVal = getRankValue(currentUserProfile.rank);
    const select = els.displays.rankSelect;
    select.innerHTML = '';

    // Populate ranks STRICTLY lower than mine
    for (const [rankName, rankVal] of Object.entries(RANK_ORDER)) {
        if (rankVal < myVal && rankName !== 'default') {
            const opt = document.createElement('option');
            opt.value = rankName;
            // Capitalize
            opt.textContent = rankName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            if (rankName.toLowerCase() === (currentModTarget.rank || '').toLowerCase()) opt.selected = true;
            select.appendChild(opt);
        }
    }
},

submitRankChange: async () => {
    if (!currentModTarget) return;
    const newRank = els.displays.rankSelect.value;
    try {
        await updateDoc(doc(db, "users", currentModTarget.uid), { rank: newRank });
        // Send Notification
        app.sendNotification(currentModTarget.uid, 'rank', `You have been promoted to ${newRank}!`, currentUserProfile.pfpUrl);
        showToast(`Rank updated to ${newRank}`, 'success');
        els.displays.rankModal.classList.add('hidden');
        app.openProfile(currentModTarget.uid);
    } catch(e) { console.error(e); showToast("Failed to update rank", 'error'); }
},

// --- NOTIFICATIONS ---
sendNotification: async (targetUid, type, text, image) => {
    if (!targetUid) return;
    try {
        await addDoc(collection(db, "users", targetUid, "notifications"), {
            type, text, image,
            fromUid: currentUser.uid,
            createdAt: serverTimestamp(),
            read: false
        });
    } catch(e) { console.error("Notif Error", e); }
},

startNotificationListener: () => {
    if (unsubscribeNotifs) unsubscribeNotifs();
    const q = query(collection(db, "users", currentUser.uid, "notifications"), orderBy("createdAt", "desc"), limit(20));
    unsubscribeNotifs = onSnapshot(q, (snapshot) => {
        const list = els.displays.notifList;
        list.innerHTML = '';
        let unreadCount = 0;
        
        if (snapshot.empty) {
            list.innerHTML = '<div class="text-center text-gray-500 text-xs p-2">No notifications</div>';
        } else {
            snapshot.forEach(doc => {
                const n = doc.data();
                if (!n.read) unreadCount++;
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-2 rounded hover:bg-[#2b2d31] border-b border-[#1e1f22] ${n.read ? 'opacity-50' : 'bg-[#2b2d31]/50'}`;
                
                let icon = '';
                if(n.type==='rank') icon='<i class="fas fa-arrow-up text-green-400"></i>';
                else if(n.type==='like') icon='<i class="fas fa-heart text-red-400"></i>';
                else if(n.type==='friend') icon='<i class="fas fa-user-plus text-blue-400"></i>';
                else if(n.type==='view') icon='<i class="fas fa-eye text-purple-400"></i>';
                else icon='<i class="fas fa-bell text-gray-400"></i>';

                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full overflow-hidden shrink-0 border border-gray-600">
                        <img src="${n.image || 'https://ui-avatars.com/api/?name=?'}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-200">${escapeHtml(n.text)}</div>
                        <div class="text-[9px] text-gray-500 flex items-center gap-1">${icon} ${n.createdAt ? new Date(n.createdAt.seconds*1000).toLocaleTimeString() : 'Now'}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        if (unreadCount > 0) {
            els.displays.notifBadge.textContent = unreadCount;
            els.displays.notifBadge.classList.remove('hidden');
        } else {
            els.displays.notifBadge.classList.add('hidden');
        }
    });
},

toggleNotifications: async () => {
    const menu = els.displays.notifMenu;
    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        // Mark as read visually? Or wait for explicit clear? 
        // Let's just keep them unread until 'Clear' is clicked or logic changes.
    } else {
        menu.classList.add('hidden');
    }
},

clearNotifications: async () => {
    // In a real app, batch update. Here, for simplicity, we assume visual clear or just mark all.
    const q = query(collection(db, "users", currentUser.uid, "notifications"), where("read", "==", false));
    const snap = await getDocs(q);
    const batch = writeBatch(db);
    snap.forEach(doc => batch.update(doc.ref, { read: true }));
    await batch.commit();
},

switchProfileTab: (tabName) => {
    const btnInfo = document.getElementById('tab-profile-info');
    const btnAbout = document.getElementById('tab-profile-about');
    const contentInfo = document.getElementById('content-profile-info');
    const contentAbout = document.getElementById('content-profile-about');

    if (tabName === 'info') {
        btnInfo.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-[#5865F2] text-white shadow-sm transition";
        btnAbout.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition";
        contentInfo.classList.remove('hidden');
        contentAbout.classList.add('hidden');
    } else {
        btnInfo.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition";
        btnAbout.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-[#5865F2] text-white shadow-sm transition";
        contentInfo.classList.add('hidden');
        contentAbout.classList.remove('hidden');
    }
},
openMyProfile: () => { if(currentUser) app.openProfile(currentUser.uid); },
closeProfile: () => { els.displays.profileModal.classList.add('hidden'); },
openEditProfile: () => { if (!currentUserProfile) return; document.getElementById('edit-username').value = currentUserProfile.username; document.getElementById('edit-bio').value = currentUserProfile.bio || ""; document.getElementById('edit-age').value = currentUserProfile.age; document.getElementById('edit-gender').value = currentUserProfile.gender; els.displays.editPfpPreview.src = currentUserProfile.pfpUrl || 'https://ui-avatars.com/api/?name=?'; els.displays.editBannerPreview.src = currentUserProfile.bannerUrl || ''; els.displays.profileModal.classList.add('hidden'); els.displays.editModal.classList.remove('hidden'); },
closeEditProfile: () => { els.displays.editModal.classList.add('hidden'); },
saveProfile: async () => { if(!currentUser) return; const newUsername = document.getElementById('edit-username').value.trim(); const newBio = document.getElementById('edit-bio').value.trim(); const newAge = parseInt(document.getElementById('edit-age').value); const newGender = document.getElementById('edit-gender').value; const pfpFile = els.displays.editPfpInput.files[0]; const bannerFile = els.displays.editBannerInput.files[0]; let pfpUrl = currentUserProfile.pfpUrl; let bannerUrl = currentUserProfile.bannerUrl; if (!newUsername) return showToast("Username required", 'error'); if (newUsername.length > 20) return showToast("Username too long", 'error'); try { if (pfpFile) pfpUrl = await processUpload(pfpFile); if (bannerFile) bannerUrl = await processUpload(bannerFile); await updateDoc(doc(db, "users", currentUser.uid), { username: newUsername, bio: newBio, age: newAge, gender: newGender, pfpUrl: pfpUrl, bannerUrl: bannerUrl || null }); showToast("Profile Saved!", 'success'); app.closeEditProfile(); app.openProfile(currentUser.uid); } catch (e) { console.error(e); showToast("Error saving profile", 'error'); } },
toggleLike: async (targetUid) => { if (!currentUser) return; if (targetUid === currentUser.uid) return showToast("Cannot like yourself", 'error'); try { const ref = doc(db, "users", targetUid); const snap = await getDoc(ref); if (!snap.exists()) return; const data = snap.data(); const likes = (data.likes && Array.isArray(data.likes)) ? data.likes : []; const isLiked = likes.includes(currentUser.uid); if (isLiked) { await updateDoc(ref, { likes: arrayRemove(currentUser.uid) }); showToast("Unliked", 'success'); } else { await updateDoc(ref, { likes: arrayUnion(currentUser.uid) }); app.sendNotification(targetUid, 'like', `${currentUserProfile.username} liked your profile.`, currentUserProfile.pfpUrl); showToast("Liked!", 'success'); } app.openProfile(targetUid); } catch (e) { console.error(e); showToast("Failed to update like", 'error'); } },

sendFriendRequest: async (targetUid) => {
if (!currentUser) return;
try {
await updateDoc(doc(db, "users", currentUser.uid), { sentFriendRequests: arrayUnion(targetUid) });
await updateDoc(doc(db, "users", targetUid), { friendRequests: arrayUnion(currentUser.uid) });
showToast("Request Sent!", "success");
app.openProfile(targetUid);
} catch(e) { console.error(e); showToast("Failed to send", "error"); }
},
acceptFriend: async (targetUid) => {
if (!currentUser) return;
try {
const batch = writeBatch(db);
const myRef = doc(db, "users", currentUser.uid);
const theirRef = doc(db, "users", targetUid);
batch.update(myRef, { friends: arrayUnion(targetUid), friendRequests: arrayRemove(targetUid) });
batch.update(theirRef, { friends: arrayUnion(currentUser.uid), sentFriendRequests: arrayRemove(currentUser.uid) });
await batch.commit();
app.sendNotification(targetUid, 'friend', `${currentUserProfile.username} accepted your friend request.`, currentUserProfile.pfpUrl);
showToast("Friend Added!", "success");
app.openProfile(targetUid);
if(!els.displays.friendMenu.classList.contains('hidden')) app.toggleFriendMenu(); 
} catch(e) { console.error(e); showToast("Failed to accept", "error"); }
},
declineFriend: async (targetUid) => {
if (!currentUser) return;
try {
    const ref = doc(db, "users", currentUser.uid);
    await updateDoc(ref, { friendRequests: arrayRemove(targetUid) });
    showToast("Declined", "success");
    if(!els.displays.friendMenu.classList.contains('hidden')) app.toggleFriendMenu(); // Refresh
} catch(e) { console.error(e); }
},
removeFriend: async (targetUid) => {
if (!currentUser) return;
try {
const batch = writeBatch(db);
const myRef = doc(db, "users", currentUser.uid);
const theirRef = doc(db, "users", targetUid);
batch.update(myRef, { friends: arrayRemove(targetUid) });
batch.update(theirRef, { friends: arrayRemove(currentUser.uid) });
await batch.commit();
showToast("Unfriended", "success");
app.openProfile(targetUid);
} catch(e) { console.error(e); }
},
openDM: async (targetUid, targetUsername) => {
    if(!currentUser) return;
    const uids = [currentUser.uid, targetUid].sort();
    const dmId = `dm_${uids[0]}_${uids[1]}`;
    
    // Ensure DM document exists so subcollection listeners don't fail security rules
    try {
        await setDoc(doc(db, "dms", dmId), { 
            participants: uids,
            updatedAt: serverTimestamp() 
        }, { merge: true });
    } catch (e) { console.error("DM Init Error", e); }

    app.enterRoom(dmId, targetUsername);
    app.closeProfile();
},

toggleHamburger: () => { document.getElementById('hamburger-menu').classList.toggle('hidden'); },
openNews: () => { els.displays.newsDrawer.classList.remove('-translate-x-full'); els.displays.leaderboardDrawer.classList.add('-translate-x-full'); document.getElementById('hamburger-menu').classList.add('hidden'); if (currentUser && currentUser.email === 'dev@gmail.com') document.getElementById('admin-news-controls').classList.remove('hidden'); else document.getElementById('admin-news-controls').classList.add('hidden'); startNewsListener(); },
closeNews: () => { els.displays.newsDrawer.classList.add('-translate-x-full'); if (unsubscribeNews) unsubscribeNews(); },
openAddNews: () => { els.displays.addNewsModal.classList.remove('hidden'); els.inputs.newsText.value = ''; els.inputs.newsImg.value = ''; els.displays.newsImgPreview.classList.add('hidden'); els.displays.newsImgPlaceholder.classList.remove('hidden'); },
postNews: async () => { if (!currentUser || currentUser.email !== 'dev@gmail.com') return; const text = els.inputs.newsText.value.trim(); const file = els.inputs.newsImg.files[0]; if (!text && !file) return showToast("Add text or image", 'error'); let imageUrl = null; if (file) { try { imageUrl = await processUpload(file); } catch(e) { return showToast("Image upload failed", 'error'); } } try { await addDoc(collection(db, "news"), { text, imageUrl, author: currentUserProfile.username, authorPfp: currentUserProfile.pfpUrl, likes: [], comments: [], createdAt: serverTimestamp() }); els.displays.addNewsModal.classList.add('hidden'); showToast("News posted!", 'success'); } catch(e) { console.error(e); showToast("Failed to post news", 'error'); } },
handleNewsLike: async (newsId) => { if (!currentUser) return; try { const ref = doc(db, "news", newsId); const snap = await getDoc(ref); if (!snap.exists()) return; const data = snap.data(); const likes = data.likes || []; const isLiked = likes.includes(currentUser.uid); if (isLiked) { await updateDoc(ref, { likes: arrayRemove(currentUser.uid) }); } else { await updateDoc(ref, { likes: arrayUnion(currentUser.uid) }); } } catch(e) { console.error(e); } },
openNewsComments: async (newsId) => { currentNewsIdForComments = newsId; els.displays.commentsModal.classList.remove('hidden'); getDoc(doc(db, "news", newsId)).then(snap => { if (snap.exists()) { renderCommentsList(snap.data().comments || []); } }); },
postNewsComment: async () => { if (!currentUser || !currentNewsIdForComments) return; const text = els.inputs.newsComment.value.trim(); if (!text) return; els.inputs.newsComment.value = ''; const newComment = { uid: currentUser.uid, username: currentUserProfile.username, pfpUrl: currentUserProfile.pfpUrl, text, createdAt: Date.now() }; try { const ref = doc(db, "news", currentNewsIdForComments); await updateDoc(ref, { comments: arrayUnion(newComment) }); } catch(e) { console.error(e); showToast("Comment failed", 'error'); } },

toggleFriendMenu: async () => {
    const menu = els.displays.friendMenu;
    const list = els.displays.friendMenuList;
    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        list.innerHTML = '<div class="text-center p-2"><div class="loader mx-auto"></div></div>';
        if (!currentUserProfile || !currentUserProfile.friendRequests || currentUserProfile.friendRequests.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-500 text-xs p-2">No pending requests</div>';
            return;
        }
        // Fetch profiles
        const reqs = currentUserProfile.friendRequests;
        const q = query(collection(db, "users"), where("uid", "in", reqs.slice(0, 10))); // Limit to 10 for now
        const snap = await getDocs(q);
        list.innerHTML = '';
        snap.forEach(doc => {
            const u = doc.data();
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 p-2 hover:bg-[#1e1f22] rounded transition";
            div.innerHTML = `
                <img src="${u.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full object-cover cursor-pointer" onclick="app.openProfile('${u.uid}')">
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-bold text-white truncate cursor-pointer" onclick="app.openProfile('${u.uid}')">${escapeHtml(u.username)}</div>
                </div>
                <button onclick="app.acceptFriend('${u.uid}')" class="text-green-400 hover:text-green-300 p-1"><i class="fas fa-check"></i></button>
                <button onclick="app.declineFriend('${u.uid}')" class="text-red-400 hover:text-red-300 p-1"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(div);
        });
    } else {
        menu.classList.add('hidden');
    }
},

openLeaderboard: () => { 
    els.displays.newsDrawer.classList.add('-translate-x-full');
    els.displays.leaderboardDrawer.classList.remove('-translate-x-full'); 
    document.getElementById('hamburger-menu').classList.add('hidden'); 
    app.loadLeaderboard('coins');
},
closeLeaderboard: () => { els.displays.leaderboardDrawer.classList.add('-translate-x-full'); },
loadLeaderboard: async (type) => {
    // Style tabs
    ['coins','gems','likes'].forEach(t => {
        const btn = document.getElementById(`lb-tab-${t}`);
        if(t === type) {
            btn.className = "flex-1 py-2 rounded border text-xs font-bold transition bg-yellow-600/20 text-yellow-400 border-yellow-600/50";
            if(t==='gems') btn.className = "flex-1 py-2 rounded border text-xs font-bold transition bg-purple-600/20 text-purple-400 border-purple-600/50";
            if(t==='likes') btn.className = "flex-1 py-2 rounded border text-xs font-bold transition bg-red-600/20 text-red-400 border-red-600/50";
        } else {
            btn.className = "flex-1 py-2 bg-[#2b2d31] text-gray-400 rounded border border-[#1e1f22] text-xs font-bold hover:text-white transition";
        }
    });

    const list = els.displays.leaderboardList;
    list.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><div class="loader"></div></div>';
    
    try {
        let q;
        if (type === 'likes') {
             q = query(collection(db, "users"), orderBy("coins", "desc"), limit(50));
        } else {
             q = query(collection(db, "users"), orderBy(type, "desc"), limit(50));
        }
        
        const snap = await getDocs(q);
        let users = [];
        snap.forEach(d => users.push(d.data()));

        if (type === 'likes') {
            users.sort((a,b) => (b.likes ? b.likes.length : 0) - (a.likes ? a.likes.length : 0));
        }

        list.innerHTML = '';
        users.forEach((u, i) => {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-3 border-b border-[#2b2d31] hover:bg-[#2b2d31] rounded transition mb-1 cursor-pointer";
            div.onclick = () => app.openProfile(u.uid);
            
            let val = 0;
            let icon = '';
            let valClass = '';
            if(type === 'coins') { val = u.coins; icon = ''; valClass = 'text-yellow-500'; }
            else if(type === 'gems') { val = u.gems; icon = ''; valClass = 'text-purple-400'; }
            else { val = u.likes ? u.likes.length : 0; icon = ''; valClass = 'text-red-500'; }

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="font-black text-gray-600 text-xl w-6 text-center">${i+1}</span>
                    <img src="${u.pfpUrl}" class="w-10 h-10 rounded-full object-cover border border-[#2b2d31]">
                    <div class="flex flex-col">
                        <span class="text-white font-bold text-sm leading-tight">${escapeHtml(u.username)}</span>
                        ${u.usernameStyle ? `<span class="text-[10px] opacity-50">Custom</span>` : ''}
                    </div>
                </div>
                <span class="${valClass} font-mono font-bold">${formatNumber(val)} ${icon}</span>
            `;
            list.appendChild(div);
        });
    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="text-center text-red-400 text-sm mt-4">Failed to load</div>';
    }
},

initiateReply: (msgId, username, text, pfpUrl) => { replyingTo = { id: msgId, username, text, pfpUrl: pfpUrl || 'https://ui-avatars.com/api/?name=?' }; els.displays.replyBarUser.textContent = username; els.displays.replyBarText.textContent = text; els.displays.replyBar.classList.remove('hidden'); els.inputs.msg.focus(); },
deleteMessage: async (msgId) => { if(!confirm("Delete this message?")) return; try { await deleteDoc(doc(db, "messages", msgId)); showToast("Message deleted", "success"); } catch(e) { console.error(e); showToast("Failed to delete", "error"); } },
toggleMsgMenu: (msgId) => { document.querySelectorAll('.msg-actions div[class*="block"]').forEach(el => { if(!el.parentElement.innerHTML.includes(msgId)) el.classList.add('hidden'); }); const menu = document.getElementById(`msg-menu-${msgId}`); if (menu) menu.classList.toggle('hidden'); },
openCreateRoom: () => { document.getElementById('room-name-input').value = ''; document.getElementById('room-password-input').value = ''; document.getElementById('create-room-modal').classList.remove('hidden'); },
createRoomSubmit: async () => { const name = document.getElementById('room-name-input').value.trim(); const pass = document.getElementById('room-password-input').value.trim(); const icon = document.getElementById('room-icon-input').value.trim(); if (!name) return showToast("Room name required", 'error'); if (name.length > 20) return showToast("Name too long", 'error'); try { const q = query(collection(db, "rooms"), where("createdBy", "==", currentUser.uid)); const snap = await getDocs(q); if (!snap.empty) return showToast("You can only create 1 room", 'error'); const roomData = { name, icon: icon || 'hashtag', createdBy: currentUser.uid, createdAt: serverTimestamp(), isPrivate: !!pass, password: pass }; const docRef = await addDoc(collection(db, "rooms"), roomData); document.getElementById('create-room-modal').classList.add('hidden'); showToast("Room created!", 'success'); window.app.enterRoom(docRef.id, name); } catch (e) { console.error(e); showToast("Error creating room", 'error'); } },
attemptEnterRoom: (roomId, roomName, isPrivate, password) => { if (roomId === window.currentRoomId) return; if (isPrivate && password) { pendingRoomJoin = { id: roomId, name: roomName, correctPass: password }; document.getElementById('join-room-password').value = ''; document.getElementById('password-room-modal').classList.remove('hidden'); } else { window.app.enterRoom(roomId, roomName); } },
submitRoomPassword: () => { const input = document.getElementById('join-room-password').value; if (!pendingRoomJoin) return; if (input === pendingRoomJoin.correctPass) { window.app.enterRoom(pendingRoomJoin.id, pendingRoomJoin.name); document.getElementById('password-room-modal').classList.add('hidden'); pendingRoomJoin = null; } else { showToast("Incorrect Password", 'error'); } },
enterRoom: async (roomId, roomName) => { 
    if (window.currentRoomId === roomId) return; 
    if (unsubscribeMessages) unsubscribeMessages(); 
    els.displays.msgContainer.innerHTML = ''; 
    window.currentRoomId = roomId; 
    
    // Set placeholder
    if (roomId.startsWith('dm_')) {
         document.getElementById('message-input').placeholder = `Message @${roomName}`;
         showToast(`Private chat with ${roomName}`, 'success');
         const collPath = `dms/${roomId}/messages`;
         startChatListener(collPath);
    } else {
         document.getElementById('message-input').placeholder = `Message #${roomName}`;
         showToast(`Joined ${roomName}`, 'success');
         const collPath = roomId === 'general' ? "messages" : `rooms/${roomId}/messages`; 
         startChatListener(collPath);
         try {
            await updateDoc(doc(db, "users", currentUser.uid), { currentRoom: roomId });
        } catch(e) { console.error("Failed to update user location", e); }
    }
},
runLeaderboard: () => { executeTop().then(() => { showToast("Leaderboard generated in chat!", 'success'); }).catch(() => { showToast("Failed to gen leaderboard", 'error'); }); },
setSidebarMode: (mode) => {
    window.sidebarMode = mode;
    ['users','friends','rooms','dms'].forEach(m => {
        const el = document.getElementById(`tab-${m}`);
        if(el) el.className = `flex-1 py-1 text-[10px] font-bold rounded ${mode===m ? 'bg-[#5865F2] text-white' : 'bg-[#1e1f22] text-gray-400'}`;
    });
    
    if (window.unsubscribeRooms) { window.unsubscribeRooms(); window.unsubscribeRooms = null; }
    if (window.unsubscribeUsersInternal) { window.unsubscribeUsersInternal(); window.unsubscribeUsersInternal = null; }
    if (window.unsubscribeDMs) { window.unsubscribeDMs(); window.unsubscribeDMs = null; }

    if (mode === 'rooms') startRoomsListener(); 
    else if (mode === 'dms') startDMsListener();
    else startUsersListenerInternal();
}
};

window.cancelReply = () => { replyingTo = null; els.displays.replyBar.classList.add('hidden'); };
window.initiateReply = app.initiateReply; window.deleteMessage = app.deleteMessage; window.toggleMsgMenu = app.toggleMsgMenu;

// --- LOGIC ---
document.addEventListener('click', (e) => { 
    if (!e.target.closest('.msg-actions')) document.querySelectorAll('[id^="msg-menu-"]').forEach(el => el.classList.add('hidden')); 
    if (!e.target.closest('#hamburger-menu') && !e.target.closest('button[onclick="app.toggleHamburger()"]')) document.getElementById('hamburger-menu').classList.add('hidden'); 
    const dropdown = els.displays.statusDropdown; const trigger = document.getElementById('user-menu-trigger'); if (!dropdown.contains(e.target) && trigger && !trigger.contains(e.target)) dropdown.classList.add('hidden'); 
    
    const fMenu = els.displays.friendMenu;
    const fTrigger = e.target.closest('button[title="Friend Requests"]');
    if (!fMenu.contains(e.target) && !fTrigger) fMenu.classList.add('hidden');
    
    const nMenu = els.displays.notifMenu;
    const nTrigger = e.target.closest('button[title="Notifications"]');
    if (!nMenu.contains(e.target) && !nTrigger) nMenu.classList.add('hidden');

    if (e.target === els.displays.walletModal) app.closeWallet(); 
    if (e.target === els.displays.profileModal) app.closeProfile(); 
    if (e.target === els.displays.modModal) els.displays.modModal.classList.add('hidden');
});
els.inputs.signupPfp.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { els.displays.pfpPreview.src = ev.target.result; els.displays.pfpPreview.classList.remove('hidden'); els.displays.pfpPlaceholder.classList.add('hidden'); }; reader.readAsDataURL(file); } });
els.displays.editPfpInput.addEventListener('change', (e) => { if(e.target.files[0]) els.displays.editPfpPreview.src = URL.createObjectURL(e.target.files[0]); });
els.displays.editBannerInput.addEventListener('change', (e) => { if(e.target.files[0]) els.displays.editBannerPreview.src = URL.createObjectURL(e.target.files[0]); });
els.inputs.newsImg.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { els.displays.newsImgPreview.src = ev.target.result; els.displays.newsImgPreview.classList.remove('hidden'); els.displays.newsImgPlaceholder.classList.add('hidden'); }; reader.readAsDataURL(file); } });
document.getElementById('btn-post-comment').onclick = app.postNewsComment;

function showToast(message, type = 'success') { const toast = document.createElement('div'); const bgClass = type === 'success' ? 'bg-green-500/90' : 'bg-red-500/90'; toast.className = `px-6 py-2 rounded-full text-white font-bold shadow-lg mb-2 text-sm text-center toast-enter backdrop-blur-md ${bgClass}`; toast.textContent = message; els.displays.toastContainer.appendChild(toast); setTimeout(() => { toast.classList.remove('toast-enter'); toast.classList.add('toast-exit'); setTimeout(() => toast.remove(), 300); }, 2500); }
function toggleLoading(active) { if (active) { els.displays.loader.classList.remove('hidden'); els.displays.feedback.classList.add('hidden'); } else { els.displays.loader.classList.add('hidden'); } }
function showError(msg) { els.displays.error.textContent = msg; els.displays.feedback.classList.remove('hidden'); }
function escapeHtml(text) { if (!text) return ''; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

els.forms.signup.addEventListener('submit', async (e) => { e.preventDefault(); const username = document.getElementById('signup-username').value; const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; const age = parseInt(document.getElementById('signup-age').value); const gender = document.getElementById('signup-gender').value; const pfpFile = els.inputs.signupPfp.files[0]; if (age < 11 || age > 1000) return showError("Age must be between 11 and 1000."); toggleLoading(true); try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; let pfpUrl = `https://ui-avatars.com/api/?name=${username}&background=random`; if (pfpFile) { try { pfpUrl = await processImage(pfpFile); } catch (e) {} } 
let initialRank = 'VIP';
if (email === 'dev@gmail.com') initialRank = 'Developer';
await setDoc(doc(db, "users", user.uid), { uid: user.uid, username, email, age, gender, pfpUrl, status: 'online', coins: 1000, gems: 10, lastDaily: 0, currentRoom: 'general', rank: initialRank, createdAt: serverTimestamp(), lastSeen: serverTimestamp(), likes: [] }); try { await updateProfile(user, { displayName: username }); } catch(e){} } catch (err) { showError(err.message); } finally { toggleLoading(false); } });
els.forms.login.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; toggleLoading(true); try { await signInWithEmailAndPassword(auth, email, password); } catch (err) { showError(err.message); } finally { toggleLoading(false); } });

onAuthStateChanged(auth, async (user) => {
if (user) {
currentUser = user;
try { await updateDoc(doc(db, "users", user.uid), { status: 'online', lastSeen: serverTimestamp(), currentRoom: 'general' }); } catch (e) {}
if (window.presenceInterval) clearInterval(window.presenceInterval);
window.presenceInterval = setInterval(() => { if (auth.currentUser) updateDoc(doc(db, "users", auth.currentUser.uid), { lastSeen: serverTimestamp() }).catch(err => console.error(err)); }, 60000);
window.addEventListener('beforeunload', () => { if (currentUser) updateDoc(doc(db, "users", currentUser.uid), { status: 'offline' }); });
try { onSnapshot(doc(db, "users", user.uid), (docSnap) => { if (docSnap.exists()) { 
    currentUserProfile = docSnap.data(); 
    
    // Rank Change Check
    if (lastRank !== null && currentUserProfile.rank !== lastRank) {
        alert("Your rank has been updated! Reloading...");
        window.location.reload();
    }
    lastRank = currentUserProfile.rank || 'VIP';

    if (currentUserProfile.coins === undefined) updateDoc(doc(db, "users", user.uid), {coins: 1000}); 
    if (currentUserProfile.gems === undefined) updateDoc(doc(db, "users", user.uid), {gems: 10}); 
    if (!currentUserProfile.rank) { let r = 'VIP'; if(currentUserProfile.email === 'dev@gmail.com') r = 'Developer'; updateDoc(doc(db, "users", user.uid), {rank: r}); } 
    const s = currentUserProfile.status || 'online'; els.displays.headerName.textContent = currentUserProfile.username; if(currentUserProfile.pfpUrl) els.displays.headerPfp.src = currentUserProfile.pfpUrl; els.displays.headerStatusText.textContent = s.charAt(0).toUpperCase() + s.slice(1); els.displays.headerStatusDot.className = "absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-[3px] border-[#2b2d31]"; if (s === 'online') els.displays.headerStatusDot.classList.add('status-online'); else if (s === 'busy') els.displays.headerStatusDot.classList.add('status-busy'); else if (s === 'dnd') els.displays.headerStatusDot.classList.add('status-dnd'); else els.displays.headerStatusDot.classList.add('status-offline'); if (!els.displays.walletModal.classList.contains('hidden')) { els.displays.walletCoins.textContent = formatNumber(currentUserProfile.coins || 0); els.displays.walletGems.textContent = formatNumber(currentUserProfile.gems || 0); } 
    
    // Notifications listener init if not started
    if (!unsubscribeNotifs) app.startNotificationListener();
} }); } catch (e) {}
if (user.email === 'dev@gmail.com') els.displays.invisibleBtn.classList.remove('hidden'); else els.displays.invisibleBtn.classList.add('hidden');
els.authView.classList.add('hidden'); els.chatView.classList.remove('hidden'); els.chatView.classList.add('flex');
startChatListener("messages"); startUsersListener();
} else {
if (window.presenceInterval) clearInterval(window.presenceInterval); if (unsubscribeMessages) unsubscribeMessages(); if (unsubscribeUsers) unsubscribeUsers(); if (unsubscribeRooms) unsubscribeRooms(); if (unsubscribeDMs) unsubscribeDMs(); if (unsubscribeNotifs) unsubscribeNotifs();
currentUser = null; currentUserProfile = null; lastRank = null; els.chatView.classList.add('hidden'); els.chatView.classList.remove('flex'); els.authView.classList.remove('hidden');
}
});

function startChatListener(collectionPath = "messages") {
if (unsubscribeMessages) unsubscribeMessages();
els.displays.msgContainer.innerHTML = '';
let q;
if (collectionPath.includes('/')) { 
    // Handle nested collections like rooms/id/messages or dms/id/messages
    const parts = collectionPath.split('/'); 
    q = query(collection(db, parts[0], parts[1], parts[2]), orderBy("createdAt", "asc")); 
} else { 
    q = query(collection(db, collectionPath), orderBy("createdAt", "asc")); 
}
unsubscribeMessages = onSnapshot(q, (snapshot) => { snapshot.docChanges().forEach((change) => { if (change.type === "added") { const data = change.doc.data(); data.id = change.doc.id; renderMessage(data); } if (change.type === "removed") { const el = document.getElementById(`msg-${change.doc.id}`); if (el) el.remove(); } }); requestAnimationFrame(() => els.displays.msgContainer.scrollTop = els.displays.msgContainer.scrollHeight); });
}

function startNewsListener() {
    if (unsubscribeNews) unsubscribeNews();
    const q = query(collection(db, "news"), orderBy("createdAt", "desc"));
    unsubscribeNews = onSnapshot(q, (snapshot) => {
        const container = els.displays.newsContainer;
        container.innerHTML = '';
        if (snapshot.empty) { els.displays.newsEmpty.classList.remove('hidden'); return; }
        els.displays.newsEmpty.classList.add('hidden');
        
        let first = true;
        snapshot.forEach(doc => {
            const news = doc.data();
            
            // Simple toast if new news detected roughly (in real app tracking last read time is better)
            const now = Date.now()/1000;
            if (first && news.createdAt && (now - news.createdAt.seconds < 30) && document.getElementById('news-drawer').classList.contains('-translate-x-full')) {
               // Only show if drawer closed and news is fresh
               // showToast("New News Posted!", 'success'); // Optional, removed to reduce noise on reload
            }
            first = false;

            const div = document.createElement('div');
            div.className = "bg-[#1e1f22] rounded-lg p-4 border border-[#111214] shadow-sm mb-4";
            const date = news.createdAt ? new Date(news.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
            const liked = (news.likes || []).includes(currentUser.uid);
            
            // Delete button for dev
            let delBtn = '';
            if (currentUser && currentUser.email === 'dev@gmail.com') {
                delBtn = `<button class="text-red-400 hover:text-white ml-auto" onclick="deleteNews('${doc.id}')"><i class="fas fa-trash"></i></button>`;
            }

            // Image handling
            let imgHtml = '';
            if (news.imageUrl) {
                imgHtml = `<div class="mb-3 rounded overflow-hidden border border-[#2b2d31]"><img src="${news.imageUrl}" class="w-full object-cover max-h-48"></div>`;
            }

            div.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <img src="${news.authorPfp}" class="w-8 h-8 rounded-full border border-[#2b2d31]">
                    <div><div class="text-sm font-bold text-white">${escapeHtml(news.author)}</div><div class="text-[10px] text-gray-400">${date}</div></div>
                    ${delBtn}
                </div>
                <div class="text-gray-200 text-sm mb-3 whitespace-pre-wrap">${escapeHtml(news.text)}</div>
                ${imgHtml}
                <div class="flex items-center gap-4 pt-2 border-t border-[#2b2d31]">
                    <button onclick="app.handleNewsLike('${doc.id}')" class="flex items-center gap-1 text-xs font-bold ${liked ? 'text-red-500' : 'text-gray-400 hover:text-red-400'} transition">
                        <i class="${liked ? 'fas' : 'far'} fa-heart"></i> ${news.likes ? news.likes.length : 0}
                    </button>
                    <button onclick="app.openNewsComments('${doc.id}')" class="flex items-center gap-1 text-xs font-bold text-gray-400 hover:text-white transition">
                        <i class="far fa-comment"></i> ${news.comments ? news.comments.length : 0}
                    </button>
                </div>
            `;
            container.appendChild(div);
        });
    });
}

// ... (Rest of existing functions from previous file: renderCommentsList, deleteNews, formatTextWithMentions, renderMessage, etc. Kept same logic, just wrapped in module) ...
function renderCommentsList(comments) {
    const list = els.displays.commentsList;
    list.innerHTML = '';
    if (comments.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 text-xs mt-4">No comments yet.</div>'; return; }
    comments.forEach(c => {
        const d = document.createElement('div'); d.className = "flex gap-3 mb-2";
        const time = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : 'Now';
        d.innerHTML = `
            <img src="${c.pfpUrl}" class="w-8 h-8 rounded-full shrink-0">
            <div>
                <div class="flex items-baseline gap-2"><span class="text-sm font-bold text-white">${escapeHtml(c.username)}</span><span class="text-[10px] text-gray-500">${time}</span></div>
                <div class="text-xs text-gray-300">${escapeHtml(c.text)}</div>
            </div>
        `;
        list.appendChild(d);
    });
}

window.deleteNews = async (id) => { if(confirm("Delete news?")) await deleteDoc(doc(db, "news", id)); }

function formatTextWithMentions(text) { return escapeHtml(text).replace(/@(\w+)/g, '<span class="mention-badge" onclick="event.stopPropagation(); app.openProfileByName(\'$1\')">@$1</span>'); }
window.app.openProfileByName = async (username) => { const q = query(collection(db, "users"), where("username", "==", username)); const snap = await getDocs(q); if(!snap.empty) { app.openProfile(snap.docs[0].id); } else { showToast("User not found", "error"); } };

function renderMessage(msg) {
if (checkProfanity(msg.text || '')) msg.text = filterText(msg.text);
const div = document.createElement('div'); div.id = `msg-${msg.id}`;
if (['allin', 'flip', 'roll', 'slots', 'rps', 'guess', 'bank', 'leaderboard'].includes(msg.type)) {
if (msg.type === 'leaderboard') { let rows = ''; msg.topUsers.forEach((u, i) => { rows += ` <div class="flex items-center justify-between py-1 border-b border-white/10 last:border-0"> <div class="flex items-center gap-2"> <span class="font-bold text-gray-400 text-lg">#${i+1}</span> <img src="${u.pfpUrl}" onclick="app.openProfile('${u.uid}')" class="w-6 h-6 rounded-full cursor-pointer hover:opacity-80"> <span class="text-white font-medium cursor-pointer hover:underline" onclick="app.openProfile('${u.uid}')">${escapeHtml(u.username)}</span> </div> <span class="text-yellow-500 font-mono">${formatNumber(u.coins)} </span> </div> `; }); div.className = "flex justify-center my-4 animate-fade-in"; div.innerHTML = ` <div class="w-full max-w-md p-4 bg-gradient-to-r from-yellow-900/40 to-[#2b2d31] rounded-lg border border-yellow-500/30"> <h3 class="text-yellow-400 font-bold uppercase tracking-widest mb-3 text-center"> Richest Players </h3> <div class="leaderboard-scroll">${rows}</div> </div> `; }
else if (msg.type === 'bank') { div.className = "flex justify-center my-4 animate-fade-in"; div.innerHTML = ` <div class="relative flex flex-col items-center p-6 rounded-xl border border-blue-500/30 bg-gradient-to-br from-blue-900/20 to-transparent max-w-sm w-full backdrop-blur-sm"> <img src="${msg.pfpUrl}" onclick="app.openProfile('${msg.uid}')" class="w-16 h-16 rounded-full border-2 border-[#2b2d31] shadow-lg mb-2 object-cover cursor-pointer hover:opacity-80 transition"> <div onclick="app.openProfile('${msg.uid}')" class="text-white font-bold text-lg mb-1 cursor-pointer hover:underline">${escapeHtml(msg.username)}</div> <div class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-4">Bank Statement</div> <div class="w-full space-y-2"> <div class="flex justify-between items-center bg-[#1e1f22]/50 p-3 rounded"> <span class="text-yellow-500 font-bold uppercase text-xs">Coins</span> <span class="text-white font-mono font-bold">${formatNumber(msg.coins)}</span> </div> <div class="flex justify-between items-center bg-[#1e1f22]/50 p-3 rounded"> <span class="text-purple-400 font-bold uppercase text-xs">Gems</span> <span class="text-white font-mono font-bold">${formatNumber(msg.gems)}</span> </div> </div> </div> `; }
else { const isWin = msg.result === 'WON'; const colorClass = isWin ? 'text-green-400' : 'text-red-400'; const borderColor = isWin ? 'border-green-500/30' : 'border-red-500/30'; const bgGradient = isWin ? 'bg-gradient-to-br from-green-900/20 to-transparent' : 'bg-gradient-to-br from-red-900/20 to-transparent'; let actionText = ""; let detailsText = ""; if (msg.type === 'allin') actionText = "went ALL IN"; if (msg.type === 'flip') actionText = `flipped a coin`; if (msg.type === 'roll') actionText = `rolled the dice`; if (msg.type === 'slots') actionText = `pulled the slots`; if (msg.type === 'rps') actionText = `played Rock Paper Scissors`; if (msg.type === 'guess') actionText = `guessed a number`; if (msg.details) detailsText = `<div class="text-sm font-mono text-gray-300 mt-2 bg-[#1e1f22]/50 px-2 py-1 rounded">${msg.details}</div>`; div.className = "flex justify-center my-4 animate-fade-in"; div.innerHTML = ` <div class="relative flex flex-col items-center p-6 rounded-xl border ${borderColor} ${bgGradient} max-w-sm w-full backdrop-blur-sm"> <img src="${msg.pfpUrl}" onclick="app.openProfile('${msg.uid}')" class="w-16 h-16 rounded-full border-2 border-[#2b2d31] shadow-lg mb-2 object-cover cursor-pointer hover:opacity-80 transition"> <div onclick="app.openProfile('${msg.uid}')" class="text-white font-bold text-lg mb-1 cursor-pointer hover:underline">${escapeHtml(msg.username)}</div> <div class="text-gray-400 text-xs uppercase tracking-widest mb-2">${actionText} with ${msg.currency === 'coins' ? 'Coins' : 'Gems'}</div> ${detailsText} <div class="text-3xl font-black ${colorClass} my-2 tracking-tighter">${msg.result}</div> <div class="flex items-center gap-2 text-sm text-gray-300"> ${isWin ? `<span>Won</span>` : `<span>Lost</span>`} <span class="font-mono font-bold text-white">${formatNumber(msg.amount)}</span> </div> </div> `; }
} else {
div.className = "group animate-fade-in relative mb-1"; const time = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now'; const nameSpan = document.createElement('span'); nameSpan.className = "font-medium text-white hover:underline cursor-pointer text-sm"; nameSpan.textContent = msg.username; nameSpan.onclick = () => app.openProfile(msg.uid); if (msg.usernameStyle) applyUsernameStyle(nameSpan, msg.usernameStyle); let msgStyle = ""; if (msg.messageStyle && msg.messageStyle.color) { msgStyle = `style="color: ${msg.messageStyle.color}"`; } let replyHtml = ''; if (msg.replyTo) { replyHtml = ` <div class="flex items-center gap-2 opacity-75 hover:opacity-100 transition cursor-pointer mb-1" onclick="document.getElementById('msg-${msg.replyTo.id}')?.scrollIntoView({behavior: 'smooth', block: 'center'})"> <div class="reply-spine"></div> <div class="flex items-center gap-1.5 overflow-hidden"> <img src="${msg.replyTo.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-4 h-4 rounded-full object-cover shrink-0"> <span class="text-xs font-bold text-gray-400 whitespace-nowrap hover:underline">@${msg.replyTo.username}</span> <span class="text-xs text-gray-500 truncate text-ellipsis overflow-hidden whitespace-nowrap cursor-pointer hover:text-gray-300 transition">${escapeHtml(msg.replyTo.text)}</span> </div> </div> `; } const isMe = currentUser && currentUser.uid === msg.uid; let deleteAction = isMe ? `<button onclick="deleteMessage('${msg.id}')" class="text-red-400 hover:bg-red-500/10 w-full text-left px-2 py-1 rounded text-xs flex items-center gap-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Delete Message</button>` : ''; const safeText = escapeHtml(msg.text).replace(/'/g, "\\'"); const safeUser = escapeHtml(msg.username).replace(/'/g, "\\'"); const safePfp = (msg.pfpUrl || '').replace(/'/g, "\\'"); div.setAttribute("ondblclick", `initiateReply('${msg.id}', '${safeUser}', '${safeText}', '${safePfp}')`); div.innerHTML = ` ${replyHtml} <div class="flex gap-4 w-full pl-2 pr-4 py-1 hover:bg-[#2e3035] -mx-2 rounded relative"> <div class="flex-shrink-0 cursor-pointer mt-0.5" onclick="app.openProfile('${msg.uid}')"> <img src="${msg.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-10 h-10 rounded-full hover:opacity-80 transition object-cover"> </div> <div class="flex-1 min-w-0 relative"> <div class="absolute right-0 -top-4 msg-actions z-10"> <div class="relative"> <button onclick="toggleMsgMenu('${msg.id}')" class="bg-[#313338] text-gray-400 hover:text-white p-1 rounded border border-[#26272d] shadow-sm"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg> </button> <div id="msg-menu-${msg.id}" class="hidden absolute right-0 top-full mt-1 w-32 bg-[#111214] border border-[#1e1f22] rounded shadow-xl p-1 z-20"> <button onclick="initiateReply('${msg.id}', '${safeUser}', '${safeText}', '${safePfp}')" class="text-gray-300 hover:bg-[#5865F2] hover:text-white w-full text-left px-2 py-1 rounded text-xs flex items-center gap-2 mb-1"> <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg> Reply </button> ${deleteAction} </div> </div> </div> <div class="flex items-baseline gap-2" id="msg-header-${msg.id}"> <span class="text-[10px] text-gray-400">${time}</span> </div> <p class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap break-words" ${msgStyle}>${formatTextWithMentions(msg.text)}</p> </div> </div> `; 
const header = div.querySelector(`div[id^="msg-header-"]`);
header.prepend(nameSpan);
if (msg.rank) header.insertAdjacentHTML('afterbegin', getRankHtml(msg.rank, false));
}
els.displays.msgContainer.appendChild(div);
}

document.getElementById('message-form').addEventListener('submit', async (e) => { e.preventDefault(); const text = els.inputs.msg.value.trim(); if (!text) return; els.inputs.msg.value = ''; if (text.startsWith('/')) { handleCommand(text); return; }
const urlRegex = /(https?:\/\/[^\s]+)/g; if (urlRegex.test(text)) { showToast("Links are not allowed!", "error"); return; }
const payload = { text, uid: currentUser.uid, username: currentUserProfile.username, pfpUrl: currentUserProfile.pfpUrl, usernameStyle: currentUserProfile.usernameStyle || null, messageStyle: currentUserProfile.messageStyle || { color: '#dbdee1' }, rank: currentUserProfile.rank || 'VIP', createdAt: serverTimestamp() }; if (replyingTo) { payload.replyTo = { id: replyingTo.id, username: replyingTo.username, text: replyingTo.text, pfpUrl: replyingTo.pfpUrl }; window.cancelReply(); }

let collRef;
if (window.currentRoomId === 'general') {
    collRef = collection(db, "messages");
} else if (window.currentRoomId.startsWith('dm_')) {
    collRef = collection(db, "dms", window.currentRoomId, "messages");
} else {
    collRef = collection(db, "rooms", window.currentRoomId, "messages");
}

try { 
    await addDoc(collRef, payload); 
    if (window.currentRoomId.startsWith('dm_')) {
        const participants = window.currentRoomId.replace('dm_','').split('_');
        const dmRef = doc(db, "dms", window.currentRoomId);
        await setDoc(dmRef, {
            participants: participants,
            updatedAt: serverTimestamp(),
            lastMessage: {
                text: payload.text,
                sender: currentUserProfile.username,
                createdAt: serverTimestamp()
            }
        }, { merge: true });
    }
} catch (err) { console.error(err); }
});

async function handleCommand(cmdString) { const parts = cmdString.split(' '); const command = parts[0].toLowerCase(); const args = parts.slice(1); if (command === '/cmds') { showHelp(); return; } if (command === '/prefixs' || command === '/prefixes') { showPrefixes(); return; } if (command === '/top') { await executeTop(); return; } if (command === '/daily') { await executeDaily(); return; } if (command === '/convert') { if (args.length < 2) return showToast("Usage: /convert {c/g} {amount}", 'error'); await executeConvert(args[0], args[1]); return; } if (command === '/pfp' && args[0] === 'change') { app.openEditProfile(); return; } if (command === '/pay') { if (args.length < 3) return showToast("Usage: /pay {username} {amount} {c/g}", 'error'); await executePay(args[0], args[1], args[2]); return; } if (command === '/clear') { if (currentUser.email === 'dev@gmail.com') { await executeClear(); } else { showToast("You do not have permission", "error"); } return; } if (['/allin', '/flip', '/roll', '/slots', '/rps', '/guess', '/bank'].includes(command)) { if (command === '/bank') { await executeBank(); showToast("Action complete", 'success'); return; } let amountIdx = 0; let currIdx = 1; let extraArg = null; if (command === '/rps' || command === '/guess') { amountIdx = 1; currIdx = 2; extraArg = args[0]; } let amountStr = args[amountIdx]; let currencyStr = args[currIdx]; if (command === '/allin') { amountStr = 'all'; currencyStr = args[0]; } await executeGamble(command, amountStr, currencyStr, extraArg); } else { showToast("Invalid Command", 'error'); } }
async function executeClear() { if (!confirm("Are you sure you want to clear ALL messages? This cannot be undone.")) return; try { const q = query(collection(db, "messages")); const snap = await getDocs(q); const batch = writeBatch(db); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); showToast("Chat cleared successfully", "success"); } catch(e) { console.error(e); showToast("Failed to clear chat", "error"); } }
function showHelp() { const div = document.createElement('div'); div.className = "my-4 mx-4 p-4 bg-[#2b2d31] rounded-lg border border-[#1e1f22] text-sm shadow-xl"; div.innerHTML = ` <h3 class="font-bold text-white mb-3 text-lg border-b border-gray-700 pb-2">Orbitly Commands</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div> <h4 class="text-blue-400 font-bold mb-1 uppercase text-xs">Essentials</h4> <ul class="space-y-1 text-gray-300"> <li><span class="text-white font-mono">/daily</span> - Claim free reward (24h)</li> <li><span class="text-white font-mono">/bank</span> - View your balance</li> <li><span class="text-white font-mono">/pay [user] [amt] [c/g]</span> - Pay someone</li> <li><span class="text-white font-mono">/top</span> - Leaderboard (Public)</li> <li><span class="text-white font-mono">/convert [c/g] [amt]</span> - Swap currency</li> </ul> </div> <div> <h4 class="text-green-400 font-bold mb-1 uppercase text-xs">Gambling</h4> <ul class="space-y-1 text-gray-300"> <li><span class="text-white font-mono">/allin [c/g]</span> - Bet everything</li> <li><span class="text-white font-mono">/flip [amt] [c/g]</span> - Coin flip (2x)</li> <li><span class="text-white font-mono">/roll [amt] [c/g]</span> - Dice roll (>3 wins)</li> <li><span class="text-white font-mono">/slots [amt] [c/g]</span> - Slot machine</li> <li><span class="text-white font-mono">/rps [r/p/s] [amt] [c/g]</span> - Rock Paper Scissors</li> <li><span class="text-white font-mono">/guess [1-10] [amt] [c/g]</span> - Guess number (5x)</li> </ul> </div> </div> <div class="mt-3 text-xs text-gray-500 italic">Rate: 10 Coins = 1 Gem</div> `; els.displays.msgContainer.appendChild(div); requestAnimationFrame(() => els.displays.msgContainer.scrollTop = els.displays.msgContainer.scrollHeight); }
function showPrefixes() { const keys = Object.keys(SUFFIXES).sort((a,b) => SUFFIXES[a] - SUFFIXES[b]); const list = keys.map(k => `<span class="bg-[#1e1f22] px-1 rounded text-yellow-400 font-mono">${k}</span>`).join(' '); const div = document.createElement('div'); div.className = "my-4 mx-4 p-4 bg-[#2b2d31] rounded-lg border border-[#1e1f22] text-sm shadow-xl"; div.innerHTML = `<h3 class="font-bold text-white mb-2 text-lg">Number Abbreviations</h3><div class="flex flex-wrap gap-2 leading-relaxed">${list}</div>`; els.displays.msgContainer.appendChild(div); requestAnimationFrame(() => els.displays.msgContainer.scrollTop = els.displays.msgContainer.scrollHeight); }
async function executeDaily() { if (!currentUserProfile) return; const now = Date.now(); const last = currentUserProfile.lastDaily || 0; const oneDay = 24 * 60 * 60 * 1000; if (now - last < oneDay) { const timeLeft = Math.ceil((oneDay - (now - last)) / (1000 * 60 * 60)); showToast(`Daily reward available in ${timeLeft} hours`, 'error'); return; } await updateDoc(doc(db, "users", currentUser.uid), { coins: (currentUserProfile.coins || 0) + 500, gems: (currentUserProfile.gems || 0) + 5, lastDaily: now }); showToast("Claimed 500 Coins & 5 Gems!", 'success'); }
async function executeConvert(currencyArg, amountStr) { const isCoins = ['c', 'coin', 'coins'].includes(currencyArg.toLowerCase()); const isGems = ['g', 'gem', 'gems'].includes(currencyArg.toLowerCase()); if (!isCoins && !isGems) return showToast("Usage: /convert {c/g} {amount}", 'error'); const amount = parseAbbreviatedNumber(amountStr); if (isNaN(amount) || amount <= 0) return showToast("Invalid amount", 'error'); const fromCurrency = isCoins ? 'coins' : 'gems'; const toCurrency = isCoins ? 'gems' : 'coins'; let resultingAmount = 0; if (fromCurrency === 'coins') { if (amount < 10) return showToast("Minimum 10 Coins", 'error'); resultingAmount = Math.floor(amount / 10); } else { resultingAmount = amount * 10; } try { await runTransaction(db, async (transaction) => { const userRef = doc(db, "users", currentUser.uid); const sfDoc = await transaction.get(userRef); if (!sfDoc.exists()) throw "User does not exist!"; const userData = sfDoc.data(); const currentBal = userData[fromCurrency] || 0; if (currentBal < amount) throw `Not enough ${fromCurrency}!`; transaction.update(userRef, { [fromCurrency]: currentBal - amount, [toCurrency]: (userData[toCurrency] || 0) + resultingAmount }); }); showToast(`Converted`, 'success'); } catch (e) { showToast(typeof e === 'string' ? e : "Failed", 'error'); } }
async function executeTop() { const q = query(collection(db, "users"), orderBy("coins", "desc"), limit(10)); const snap = await getDocs(q); const topUsers = []; snap.forEach(d => { const u = d.data(); topUsers.push({ uid: u.uid, username: u.username, pfpUrl: u.pfpUrl, coins: u.coins || 0 }); }); const collRef = window.currentRoomId === 'general' ? collection(db, "messages") : collection(db, "rooms", window.currentRoomId, "messages"); await addDoc(collRef, { type: 'leaderboard', topUsers: topUsers, createdAt: serverTimestamp() }); }
async function executePay(targetName, amountStr, currStr) { const amount = parseAbbreviatedNumber(amountStr); if (isNaN(amount) || amount <= 0) return showToast("Invalid Amount", 'error'); const isCoins = ['c', 'coin', 'coins'].includes(currStr?.toLowerCase()); const currency = isCoins ? 'coins' : 'gems'; if ((currentUserProfile[currency] || 0) < amount) return showToast("Insufficient funds", 'error'); if (currentUserProfile.username === targetName) return showToast("Cannot pay yourself", 'error'); const q = query(collection(db, "users"), where("username", "==", targetName)); const snap = await getDocs(q); if (snap.empty) return showToast("User not found", 'error'); const targetUid = snap.docs[0].id; try { await runTransaction(db, async (transaction) => { const senderRef = doc(db, "users", currentUser.uid); const receiverRef = doc(db, "users", targetUid); const sSnap = await transaction.get(senderRef); const rSnap = await transaction.get(receiverRef); if (!sSnap.exists() || !rSnap.exists()) throw "Error"; if ((sSnap.data()[currency] || 0) < amount) throw "Funds"; transaction.update(senderRef, { [currency]: sSnap.data()[currency] - amount }); transaction.update(receiverRef, { [currency]: (rSnap.data()[currency] || 0) + amount }); }); showToast(`Sent`, 'success'); } catch (e) { showToast("Transaction failed", 'error'); } }
async function executeBank() { if (!currentUserProfile) return; const collRef = window.currentRoomId === 'general' ? collection(db, "messages") : collection(db, "rooms", window.currentRoomId, "messages"); await addDoc(collRef, { type: 'bank', uid: currentUser.uid, username: currentUserProfile.username, pfpUrl: currentUserProfile.pfpUrl, coins: currentUserProfile.coins || 0, gems: currentUserProfile.gems || 0, createdAt: serverTimestamp() }); }
async function executeGamble(game, amountStr, currStr, extra) { if (!currentUserProfile) return; const isCoins = ['c', 'coin', 'coins'].includes(currStr?.toLowerCase()); const currencyKey = isCoins ? 'coins' : 'gems'; let balance = currentUserProfile[currencyKey] || 0; let bet = amountStr === 'all' ? balance : parseAbbreviatedNumber(amountStr); if (isNaN(bet) || bet <= 0) { showToast("Invalid Amount", 'error'); return; } if (balance < bet) { showToast(`Not enough ${currencyKey}`, 'error'); return; } const isDev = currentUser.email === 'dev@gmail.com'; let win = false; let multiplier = 0; let details = ""; if (game === '/allin') { if (isDev) { win = true; multiplier = 10; } else { win = Math.random() < 0.55; if (win) { const r = Math.random(); multiplier = r<0.5?1:r<0.75?2:r<0.875?3:r<0.975?5:10; } } } else if (game === '/flip') { const isHeads = Math.random() < 0.5; details = `Coin: ${isHeads?'Heads':'Tails'}`; if(isDev){win=true; multiplier=2;}else{win=Math.random()<0.55; multiplier=2;} } else if (game === '/roll') { let roll = Math.floor(Math.random() * 6) + 1; if(isDev){roll=6;win=true;multiplier=3;}else{if(roll>=3)win=true; multiplier=roll===6?3:1.5;} details=`Rolled ${roll}`; } else if (game === '/slots') { const s=['','','','','7']; let s1=s[Math.floor(Math.random()*5)], s2=s[Math.floor(Math.random()*5)], s3=s[Math.floor(Math.random()*5)]; if(isDev){s1=s2=s3='7';win=true;multiplier=10;}else{ if(Math.random() < 0.2) { s2=s1; s3=s1; } if(s1===s2&&s2===s3){win=true;multiplier=s1==='7'?10:5;}else if(s1===s2||s2===s3||s1===s3){win=true;multiplier=1.5;}} details=`${s1}|${s2}|${s3}`; } else if (game === '/rps') { const m=['r','p','s']; const u=extra?extra[0]:null; if(!m.includes(u)){showToast("Use r,p,s",'error');return;} let b=m[Math.floor(Math.random()*3)]; if(isDev){b=u==='r'?'s':u==='p'?'r':'p';} details=`You:${u} Bot:${b}`; if(u===b){win=true;multiplier=1;}else if((u==='r'&&b==='s')||(u==='p'&&b==='r')||(u==='s'&&b==='p')){win=true;multiplier=2;} } else if (game === '/guess') { const g=parseInt(extra); if(isNaN(g)){showToast("1-10",'error');return;} let s=Math.floor(Math.random()*10)+1; if(isDev)s=g; else if(Math.random() < 0.35) s=g; details=`Num:${s}`; if(g===s){win=true;multiplier=5;} } const winnings = win ? Math.floor(bet * multiplier) : 0; await updateDoc(doc(db, "users", currentUser.uid), { [currencyKey]: (balance - bet) + winnings }); const collRef = window.currentRoomId === 'general' ? collection(db, "messages") : collection(db, "rooms", window.currentRoomId, "messages"); await addDoc(collRef, { type: game.replace('/',''), uid: currentUser.uid, username: currentUserProfile.username, pfpUrl: currentUserProfile.pfpUrl, currency: currencyKey, result: win ? (multiplier === 1 ? 'DRAW' : 'WON') : 'LOST', amount: win ? winnings : bet, multiplier: multiplier, details: details, createdAt: serverTimestamp() }); showToast("Done", 'success'); }

// --- Users, Friends & Rooms List System ---
function startUsersListener() {
const container = els.displays.onlineList.parentElement.querySelector('.h-16');
// Updated Sidebar HTML with DMs
container.innerHTML = `<div class="flex gap-1 p-2 w-full h-full items-center">
    <button onclick="app.setSidebarMode('users')" id="tab-users" class="flex-1 py-1 text-[10px] font-bold rounded bg-[#5865F2] text-white" title="Online Players">PLAYERS</button>
    <button onclick="app.setSidebarMode('friends')" id="tab-friends" class="flex-1 py-1 text-[10px] font-bold rounded bg-[#1e1f22] text-gray-400" title="Friends">FRIENDS</button>
    <button onclick="app.setSidebarMode('rooms')" id="tab-rooms" class="flex-1 py-1 text-[10px] font-bold rounded bg-[#1e1f22] text-gray-400" title="Public Rooms">ROOMS</button>
    <button onclick="app.setSidebarMode('dms')" id="tab-dms" class="flex-1 py-1 text-[10px] font-bold rounded bg-[#1e1f22] text-gray-400" title="Direct Messages">DMs</button>
</div>`;

startUsersListenerInternal();
}

function startUsersListenerInternal() {
const q = query(collection(db, "users"), orderBy("username", "asc"));
window.unsubscribeUsersInternal = onSnapshot(q, (snapshot) => {
els.displays.onlineList.innerHTML = '';
const onlineUsers = [], offlineUsers = [], typers = [], requests = [];
const myFriends = (currentUserProfile && currentUserProfile.friends) ? currentUserProfile.friends : [];
const myRequests = (currentUserProfile && currentUserProfile.friendRequests) ? currentUserProfile.friendRequests : [];

let allUsers = [];
snapshot.forEach((doc) => {
    allUsers.push(doc.data());
});

allUsers.sort((a, b) => {
    const rA = getRankValue(a.rank);
    const rB = getRankValue(b.rank);
    if (rA !== rB) return rB - rA; 
    return a.username.localeCompare(b.username); 
});

allUsers.forEach((user) => {
    if (window.sidebarMode === 'friends') {
        if (myRequests.includes(user.uid)) {
            requests.push(user);
            return;
        }
        if (!myFriends.includes(user.uid)) return;
    } else if (window.sidebarMode === 'users') {
        const userRoom = user.currentRoom || 'general';
        if (userRoom !== window.currentRoomId) return;
    }

    let status = user.status || 'offline';
    if (status !== 'offline' && status !== 'invisible') { const now = Date.now()/1000; const lastSeen = user.lastSeen ? user.lastSeen.seconds : 0; if (now - lastSeen > 120) status = 'offline'; }
    if (user.typing) { const now = Date.now(); const typeTime = user.typing.seconds*1000; if (now - typeTime < 5000 && user.uid !== currentUser.uid) typers.push(user.username); }
    if (status === 'invisible' && user.uid !== (currentUser?currentUser.uid:null)) return;

    let displayStatus = status === 'invisible' ? 'offline' : status;
    if (displayStatus === 'offline') offlineUsers.push({ ...user, displayStatus: 'offline' }); else onlineUsers.push({ ...user, displayStatus });
});

const existingTyping = document.getElementById('typing-indicator-bar'); if (existingTyping) existingTyping.remove();
if (typers.length > 0) { const typeDiv = document.createElement('div'); typeDiv.id = 'typing-indicator-bar'; typeDiv.className = "absolute bottom-20 right-4 z-30 text-xs font-bold text-gray-400 animate-pulse bg-[#2b2d31]/80 px-2 py-1 rounded-full border border-gray-700 pointer-events-none"; if (typers.length === 1) typeDiv.textContent = `${typers[0]} is typing...`; else if (typers.length === 2) typeDiv.textContent = `${typers[0]} and ${typers[1]} are typing...`; else typeDiv.textContent = "Multiple people are typing..."; document.querySelector('#chat-view .px-4.pb-4.bg-\\[\\#313338\\]').appendChild(typeDiv); }

if (window.sidebarMode === 'friends' && requests.length > 0) {
const h = document.createElement('div'); h.className = "px-2 py-3 text-xs font-bold text-gray-500 uppercase mt-2"; h.textContent = `Requests  ${requests.length}`; els.displays.onlineList.appendChild(h);
requests.forEach(u => renderRequestInList(u));
}

if (onlineUsers.length > 0) { const h = document.createElement('div'); h.className = "px-2 py-3 text-xs font-bold text-gray-500 uppercase mt-2"; h.textContent = `Online  ${onlineUsers.length}`; els.displays.onlineList.appendChild(h); onlineUsers.forEach(u => renderUserInList(u, u.displayStatus)); }
if (offlineUsers.length > 0) { const h = document.createElement('div'); h.className = "px-2 py-3 text-xs font-bold text-gray-500 uppercase mt-2"; h.textContent = `Offline  ${offlineUsers.length}`; els.displays.onlineList.appendChild(h); offlineUsers.forEach(u => renderUserInList(u, u.displayStatus)); }

if (onlineUsers.length===0 && offlineUsers.length===0 && requests.length===0) { const e = document.createElement('div'); e.className = "text-center text-gray-500 text-xs mt-4"; e.textContent = window.sidebarMode==='friends'?"No friends yet.":"No active users in this room."; els.displays.onlineList.appendChild(e); }
});
}

function renderRequestInList(user) {
const div = document.createElement('div'); div.className = `flex items-center gap-2 p-2 rounded hover:bg-[#35373c] cursor-pointer group mb-1`;
div.innerHTML = `
<img src="${user.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full object-cover">
<div class="flex-1 min-w-0">
<div class="text-sm font-bold text-white truncate">${user.username}</div>
<div class="flex gap-1 mt-1">
<button onclick="event.stopPropagation(); app.acceptFriend('${user.uid}')" class="bg-green-600 hover:bg-green-700 text-white text-[10px] px-2 py-0.5 rounded">Accept</button>
</div>
</div>
`;
div.onclick = () => window.app.openProfile(user.uid);
els.displays.onlineList.appendChild(div);
}

function renderUserInList(user, status) {
const div = document.createElement('div'); div.className = `flex items-center gap-3 p-2 rounded hover:brightness-110 cursor-pointer group opacity-90 hover:opacity-100 transition`;
if (user.listStyle === 'custom' && user.customListStyle) { div.style.backgroundColor = user.customListStyle.bg; div.style.border = `1px solid ${user.customListStyle.border}`; } else { div.classList.add(user.listStyle || 'list-style-default'); div.classList.add('hover:bg-[#35373c]'); }
div.onclick = () => window.app.openProfile(user.uid); if (status === 'offline') div.classList.add('opacity-50');
let statusColor = status==='online'?'bg-green-500':status==='busy'?'bg-yellow-500':status==='dnd'?'bg-red-500':'bg-gray-500';
let nameClass = "text-sm font-medium truncate"; if (!user.listStyle || user.listStyle !== 'custom') nameClass += " text-gray-200 group-hover:text-white";
const nameSpan = document.createElement('div'); nameSpan.textContent = user.username; nameSpan.className = nameClass;
if (user.listStyle === 'custom' && user.customListStyle) nameSpan.style.color = user.customListStyle.text;
if (user.usernameStyle) applyUsernameStyle(nameSpan, user.usernameStyle);
div.ondblclick = (e) => { e.stopPropagation(); window.app.sendFriendRequest(user.uid); }; div.title = "Double click to friend request";
div.innerHTML = ` <div class="relative"> <img src="${user.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full object-cover"> ${status !== 'offline' ? `<div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 border-[3px] border-[#2b2d31] rounded-full ${statusColor}"></div>` : ''} </div> <div class="flex-1 min-w-0"> <div id="u-list-name-${user.uid}" class="w-full flex items-center gap-1.5"></div> <div class="text-[10px] text-gray-400 uppercase font-bold">${status}</div> </div> `; 
const nameContainer = div.querySelector(`#u-list-name-${user.uid}`);
if (user.rank) {
    nameContainer.insertAdjacentHTML('afterbegin', getRankHtml(user.rank, false));
}
nameContainer.appendChild(nameSpan);
els.displays.onlineList.appendChild(div);
}

function startRoomsListener() {
const q = query(collection(db, "rooms"), orderBy("createdAt", "desc"));
window.unsubscribeRooms = onSnapshot(q, (snapshot) => {
els.displays.onlineList.innerHTML = '';
const createBtn = document.createElement('button'); createBtn.className = "w-full py-2 mb-3 bg-[#5865F2] hover:bg-[#4752c4] text-white font-bold rounded text-xs flex items-center justify-center gap-2 transition"; createBtn.innerHTML = `<i class="fas fa-plus"></i> Create Room`; createBtn.onclick = window.app.openCreateRoom; els.displays.onlineList.appendChild(createBtn);
const generalDiv = document.createElement('div'); generalDiv.className = `flex items-center gap-3 p-2 rounded hover:bg-[#35373c] cursor-pointer group mb-1 ${window.currentRoomId === 'general' ? 'bg-[#35373c] border-l-2 border-[#5865F2]' : ''}`; generalDiv.onclick = () => window.app.enterRoom('general', 'Orbitly Chat'); generalDiv.innerHTML = ` <div class="w-8 h-8 rounded bg-[#5865F2] flex items-center justify-center text-white"><i class="fas fa-hashtag"></i></div> <div class="flex-1"><div class="text-sm font-bold text-gray-200">Orbitly Chat</div><div class="text-[10px] text-gray-400">Public</div></div> `; els.displays.onlineList.appendChild(generalDiv);
if (snapshot.empty) { const empty = document.createElement('div'); empty.className = "text-center text-gray-500 text-xs mt-4"; empty.textContent = "No user rooms."; els.displays.onlineList.appendChild(empty); }
snapshot.forEach(doc => { const r = doc.data(); r.id = doc.id; renderRoomInList(r); });
});
}

function renderRoomInList(room) {
const div = document.createElement('div'); const isActive = window.currentRoomId === room.id; div.className = `flex items-center gap-3 p-2 rounded hover:bg-[#35373c] cursor-pointer group mb-1 transition ${isActive ? 'bg-[#35373c] border-l-2 border-[#5865F2]' : ''}`; div.onclick = () => window.app.attemptEnterRoom(room.id, room.name, room.isPrivate, room.password);
// Handle emoji icon or image url
let iconHtml = '';
if (room.icon && room.icon.startsWith('http')) {
    iconHtml = `<img src="${room.icon}" class="w-full h-full object-cover rounded">`;
} else {
    iconHtml = `<span class="text-lg">${room.icon || '#'}</span>`;
}

div.innerHTML = ` <div class="w-8 h-8 rounded bg-[#2b2d31] border border-gray-600 flex items-center justify-center text-gray-400 group-hover:text-white group-hover:border-white transition overflow-hidden"> ${iconHtml} </div> <div class="flex-1 min-w-0"> <div class="text-sm font-bold text-gray-200 truncate group-hover:text-white">${escapeHtml(room.name)}</div> <div class="text-[10px] text-gray-500 uppercase flex items-center gap-1">${room.isPrivate ? '<i class="fas fa-lock text-[8px]"></i> Private' : 'Public'}</div> </div> `; els.displays.onlineList.appendChild(div);
}

function startDMsListener() {
    const q = query(collection(db, "dms"), where("participants", "array-contains", currentUser.uid));
    window.unsubscribeDMs = onSnapshot(q, async (snapshot) => {
        els.displays.onlineList.innerHTML = '';
        if (snapshot.empty) { 
            const empty = document.createElement('div'); 
            empty.className = "text-center text-gray-500 text-xs mt-4"; 
            empty.textContent = "No active DMs."; 
            els.displays.onlineList.appendChild(empty); 
            return;
        }

        const sortedDocs = snapshot.docs.sort((a, b) => {
            const timeA = a.data().updatedAt ? a.data().updatedAt.seconds : 0;
            const timeB = b.data().updatedAt ? b.data().updatedAt.seconds : 0;
            return timeB - timeA;
        });

        for (const docSnap of sortedDocs) {
            const data = docSnap.data();
            const otherUid = data.participants.find(uid => uid !== currentUser.uid);
            
            if(!otherUid) continue; 

            try {
                const userSnap = await getDoc(doc(db, "users", otherUid));
                let otherUser = { username: 'Unknown User', pfpUrl: 'https://ui-avatars.com/api/?name=?' };
                if (userSnap.exists()) otherUser = userSnap.data();

                const div = document.createElement('div'); 
                const isActive = window.currentRoomId === docSnap.id;
                div.className = `flex items-center gap-3 p-2 rounded hover:bg-[#35373c] cursor-pointer group mb-1 transition ${isActive ? 'bg-[#35373c] border-l-2 border-[#5865F2]' : ''}`; 
                div.onclick = () => window.app.enterRoom(docSnap.id, otherUser.username);
                
                const lastMsg = data.lastMessage ? `${data.lastMessage.sender === currentUserProfile.username ? 'You: ' : ''}${escapeHtml(data.lastMessage.text)}` : 'No messages yet';

                div.innerHTML = ` 
                    <div class="relative">
                        <img src="${otherUser.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full object-cover bg-gray-600"> 
                    </div> 
                    <div class="flex-1 min-w-0"> 
                        <div class="text-sm font-bold text-gray-200 truncate group-hover:text-white">${escapeHtml(otherUser.username)}</div> 
                        <div class="text-[10px] text-gray-500 truncate">${lastMsg}</div> 
                    </div> 
                `; 
                els.displays.onlineList.appendChild(div);
            } catch(e) { console.error(e); }
        }
    });
}

let typingTimeout;
els.inputs.msg.addEventListener('input', () => { if (!currentUser) return; if (typingTimeout) clearTimeout(typingTimeout); updateDoc(doc(db, "users", currentUser.uid), { typing: serverTimestamp() }).catch(()=>{}); typingTimeout = setTimeout(() => {}, 1000); });
</script>
</body>
</html>
