<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orbitly Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Nunito', sans-serif; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e1f22; }
    ::-webkit-scrollbar-thumb { background: #111214; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #35373c; }
    .glass-panel { background: rgba(43, 45, 49, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    .stat-card { transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #5865F2; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .table-row-anim { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body class="bg-[#1e1f22] text-gray-100 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-[#111214] flex flex-col border-r border-[#2b2d31]">
        <div class="p-6 flex items-center gap-3 border-b border-[#2b2d31]">
            <img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExMXBhNjNycTQweDFkY214NjMxYWtiZWs1ZjZ3dTJxb254d21ldHIyOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/HPbuRgMPF2vL2/giphy.gif" class="w-8 h-8 object-contain">
            <h1 class="text-xl font-black tracking-wider text-white">ORBITLY <span class="text-[#5865F2]">ADMIN</span></h1>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="admin.switchTab('dashboard')" id="nav-dashboard" class="w-full text-left px-4 py-3 rounded-lg bg-[#5865F2] text-white font-bold flex items-center gap-3 transition">
                <i class="fas fa-chart-line w-5"></i> Dashboard
            </button>
            <button onclick="admin.switchTab('users')" id="nav-users" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-[#2b2d31] hover:text-white font-bold flex items-center gap-3 transition">
                <i class="fas fa-users w-5"></i> User Manager
            </button>
            <button onclick="admin.switchTab('rooms')" id="nav-rooms" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-[#2b2d31] hover:text-white font-bold flex items-center gap-3 transition">
                <i class="fas fa-door-open w-5"></i> Rooms
            </button>
            <button onclick="admin.switchTab('logs')" id="nav-logs" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-[#2b2d31] hover:text-white font-bold flex items-center gap-3 transition">
                <i class="fas fa-list-alt w-5"></i> Chat Logs
            </button>
            <button onclick="admin.switchTab('tools')" id="nav-tools" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-[#2b2d31] hover:text-white font-bold flex items-center gap-3 transition">
                <i class="fas fa-tools w-5"></i> System Tools
            </button>
        </nav>

        <div class="p-4 border-t border-[#2b2d31]">
            <button onclick="window.location.href='index.html'" class="w-full py-2 border border-red-500/30 text-red-400 hover:bg-red-500/10 rounded font-bold transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Exit Panel
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Top Bar -->
        <header class="h-16 bg-[#111214] border-b border-[#2b2d31] flex justify-between items-center px-6 shadow-md z-10">
            <h2 id="page-title" class="text-xl font-bold text-white">Dashboard Overview</h2>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div id="admin-name" class="text-sm font-bold text-white">Loading...</div>
                    <div id="admin-rank" class="text-xs text-[#5865F2] uppercase font-bold">Verifying...</div>
                </div>
                <img id="admin-pfp" src="" class="w-10 h-10 rounded-full bg-gray-700 object-cover border-2 border-[#5865F2]">
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-6 bg-[#1e1f22]">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6">
                <!-- Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="stat-card glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i class="fas fa-users text-6xl text-blue-500"></i></div>
                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Total Users</h3>
                        <div id="stat-total-users" class="text-3xl font-black text-white">0</div>
                    </div>
                    <div class="stat-card glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i class="fas fa-comment-dots text-6xl text-green-500"></i></div>
                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Total Messages</h3>
                        <div id="stat-total-msgs" class="text-3xl font-black text-white">0</div>
                    </div>
                    <div class="stat-card glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i class="fas fa-coins text-6xl text-yellow-500"></i></div>
                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Economy (Coins)</h3>
                        <div id="stat-economy" class="text-3xl font-black text-white">0</div>
                    </div>
                    <div class="stat-card glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i class="fas fa-door-open text-6xl text-purple-500"></i></div>
                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Active Rooms</h3>
                        <div id="stat-rooms" class="text-3xl font-black text-white">0</div>
                    </div>
                </div>

                <!-- Gender & Rank Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-venus-mars text-pink-400"></i> User Demographics</h3>
                        <div id="gender-bars" class="space-y-4">
                            <!-- Populated by JS -->
                            <div class="text-center text-gray-500 text-sm py-4"><div class="loader mx-auto"></div></div>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-crown text-yellow-400"></i> Rank Distribution</h3>
                        <div id="rank-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: USERS -->
            <div id="view-users" class="hidden h-full flex flex-col">
                <div class="flex gap-4 mb-4">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
                        <input type="text" id="user-search" placeholder="Search by username or email..." class="w-full bg-[#111214] border border-[#2b2d31] rounded-lg pl-10 pr-4 py-2.5 text-white focus:border-[#5865F2] outline-none transition">
                    </div>
                    <button onclick="admin.refreshUsers()" class="bg-[#2b2d31] hover:bg-[#35373c] text-white px-4 rounded-lg font-bold transition"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="bg-[#111214] border border-[#2b2d31] rounded-xl overflow-hidden flex-1 flex flex-col">
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-[#202225] border-b border-[#2b2d31] text-xs uppercase text-gray-400">
                                    <th class="p-4 font-bold">User</th>
                                    <th class="p-4 font-bold">Rank</th>
                                    <th class="p-4 font-bold">Details</th>
                                    <th class="p-4 font-bold">Status</th>
                                    <th class="p-4 font-bold text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="text-sm">
                                <tr><td colspan="5" class="p-8 text-center text-gray-500">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="users-pagination" class="p-3 border-t border-[#2b2d31] bg-[#202225] flex justify-between items-center text-xs text-gray-400">
                        <span id="user-count">0 Users</span>
                        <!-- Simple pagination could be added here -->
                    </div>
                </div>
            </div>

            <!-- VIEW: ROOMS -->
            <div id="view-rooms" class="hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="rooms-grid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- VIEW: LOGS -->
            <div id="view-logs" class="hidden h-full flex flex-col">
                <div class="bg-[#111214] border border-[#2b2d31] rounded-xl p-4 flex-1 overflow-y-auto font-mono text-xs space-y-1" id="logs-terminal">
                    <div class="text-gray-500">Connecting to live feed...</div>
                </div>
            </div>

            <!-- VIEW: TOOLS -->
            <div id="view-tools" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Broadcast -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-bullhorn text-red-400"></i> System Broadcast</h3>
                    <textarea id="broadcast-text" class="w-full bg-[#111214] border border-[#2b2d31] rounded p-3 text-white text-sm mb-3 focus:border-red-500 outline-none" rows="3" placeholder="Enter system announcement..."></textarea>
                    <button onclick="admin.sendBroadcast()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded transition">Send Announcement</button>
                </div>

                <!-- Economy -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-hand-holding-usd text-green-400"></i> Economy Stimulus</h3>
                    <div class="space-y-3">
                        <input type="text" id="stimulus-username" placeholder="Username (leave empty for ALL)" class="w-full bg-[#111214] border border-[#2b2d31] rounded p-2 text-white text-sm">
                        <div class="flex gap-2">
                            <input type="number" id="stimulus-amount" placeholder="Amount" class="flex-1 bg-[#111214] border border-[#2b2d31] rounded p-2 text-white text-sm">
                            <select id="stimulus-currency" class="bg-[#111214] border border-[#2b2d31] rounded p-2 text-white text-sm">
                                <option value="coins">Coins</option>
                                <option value="gems">Gems</option>
                            </select>
                        </div>
                        <button onclick="admin.giveCurrency()" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded transition">Grant Currency</button>
                    </div>
                </div>

                <!-- Banned Words -->
                <div class="glass-panel p-6 rounded-xl md:col-span-2">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-filter text-orange-400"></i> Chat Filter</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="filter-word" placeholder="Add word to blacklist..." class="flex-1 bg-[#111214] border border-[#2b2d31] rounded p-2 text-white text-sm">
                        <button onclick="admin.addFilterWord()" class="px-4 bg-orange-600 hover:bg-orange-700 text-white rounded font-bold">Add</button>
                    </div>
                    <div id="filter-list" class="flex flex-wrap gap-2 p-2 bg-[#111214] rounded min-h-[50px]">
                        <!-- Populated -->
                        <span class="px-2 py-1 bg-red-900/30 text-red-400 rounded border border-red-900 text-xs">nemo</span>
                        <span class="px-2 py-1 bg-red-900/30 text-red-400 rounded border border-red-900 text-xs">levi</span>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Admin Action Modal -->
    <div id="admin-user-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#2b2d31] w-full max-w-md rounded-xl border border-[#1e1f22] shadow-2xl p-6">
            <h3 id="modal-user-title" class="text-xl font-bold text-white mb-4">Manage User</h3>
            <input type="hidden" id="modal-uid">
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs uppercase font-bold text-gray-400">Set Rank</label>
                    <select id="modal-rank-select" class="w-full mt-1 bg-[#111214] border border-[#1e1f22] text-white rounded p-2 text-sm">
                        <option value="Developer">Developer</option>
                        <option value="Founder">Founder</option>
                        <option value="CEO">CEO</option>
                        <option value="Head-Owner">Head-Owner</option>
                        <option value="Owner">Owner</option>
                        <option value="Manager">Manager</option>
                        <option value="Super-Admin">Super-Admin</option>
                        <option value="Admin">Admin</option>
                        <option value="Mod">Mod</option>
                        <option value="Trial-Mod">Trial-Mod</option>
                        <option value="Site-Helper">Site-Helper</option>
                        <option value="VIP">VIP</option>
                        <option value="Member">Member</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="admin.modalAction('ban')" id="btn-modal-ban" class="py-2 bg-red-600/20 text-red-400 border border-red-600/50 rounded hover:bg-red-600/40 font-bold text-sm">Ban User</button>
                    <button onclick="admin.modalAction('kick')" class="py-2 bg-orange-600/20 text-orange-400 border border-orange-600/50 rounded hover:bg-orange-600/40 font-bold text-sm">Kick User</button>
                    <button onclick="admin.modalAction('mute')" id="btn-modal-mute" class="py-2 bg-yellow-600/20 text-yellow-400 border border-yellow-600/50 rounded hover:bg-yellow-600/40 font-bold text-sm">Mute User</button>
                    <button onclick="admin.modalAction('reset')" class="py-2 bg-blue-600/20 text-blue-400 border border-blue-600/50 rounded hover:bg-blue-600/40 font-bold text-sm">Reset Info</button>
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="admin.saveModalRank()" class="flex-1 bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 rounded font-bold">Save Rank</button>
                    <button onclick="document.getElementById('admin-user-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Close</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, getDoc, deleteDoc, getDocs, limit, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBz9yOlQFZQZE-GtGcRbJ2sWUYQTb0kBi4", authDomain: "orbitly-online.firebaseapp.com", projectId: "orbitly-online", storageBucket: "orbitly-online.firebasestorage.app", messagingSenderId: "75415636853", appId: "1:75415636853:web:ccf4ac9c74a1769335a13c", measurementId: "G-9B5458S73M" };
const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);

let currentUser = null;
let allUsersCache = [];
let unsubscribeUsers = null;
let unsubscribeLogs = null;

const RANK_VALUES = {
    'developer': 100, 'founder': 95, 'ceo': 95, 'head-owner': 90, 'owner': 90,
    'manager': 85, 'super-admin': 80, 'admin': 75, 'mod': 70, 'trial-mod': 60,
    'site-helper': 60, 'vip': 50, 'member': 0
};

function getRankVal(r) { return RANK_VALUES[(r||'').toLowerCase()] || 0; }

// Auth Check
onAuthStateChanged(auth, async (user) => {
    if(user) {
        const snap = await getDoc(doc(db, "users", user.uid));
        if(snap.exists()) {
            const data = snap.data();
            // Security Check: Must be >= Super-Admin (80) or Dev email
            if (getRankVal(data.rank) < 80 && user.email !== 'dev@gmail.com') {
                alert("Unauthorized Access");
                window.location.href = 'index.html';
                return;
            }
            currentUser = data;
            document.getElementById('admin-name').textContent = data.username;
            document.getElementById('admin-rank').textContent = data.rank;
            document.getElementById('admin-pfp').src = data.pfpUrl;
            
            initAdmin();
        } else {
            window.location.href = 'index.html';
        }
    } else {
        window.location.href = 'index.html';
    }
});

function initAdmin() {
    startUserListener();
    admin.switchTab('dashboard');
}

function startUserListener() {
    const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
    unsubscribeUsers = onSnapshot(q, (snapshot) => {
        allUsersCache = [];
        let totalMsgs = 0; // Estimation if we tracked it per user, for now 0
        let activeRooms = 0;
        
        snapshot.forEach(doc => {
            const u = doc.data();
            u.uid = doc.id;
            allUsersCache.push(u);
        });

        updateDashboard();
        if(!document.getElementById('view-users').classList.contains('hidden')) {
            renderUsersTable(allUsersCache);
        }
    });
    
    // Watch Rooms for Stats
    onSnapshot(collection(db, "rooms"), (snap) => {
        document.getElementById('stat-rooms').textContent = snap.size;
        if (!document.getElementById('view-rooms').classList.contains('hidden')) {
            renderRoomsGrid(snap.docs);
        }
    });
    
    // Watch Messages for Total Count (Expensive? Limit to 1 for metadata if possible, but here we just list logs)
    // Actually, getting total count of a collection in Firestore is expensive/slow without counters. 
    // We will simulate it or just show "--".
}

function updateDashboard() {
    const users = allUsersCache;
    document.getElementById('stat-total-users').textContent = users.length;
    
    // Gender Stats
    const genders = { Male: 0, Female: 0, Alien: 0, Other: 0 };
    users.forEach(u => {
        const g = u.gender;
        if(g === 'Male') genders.Male++;
        else if(g === 'Female') genders.Female++;
        else if(g === 'Alien') genders.Alien++;
        else genders.Other++;
    });
    
    const max = Math.max(1, users.length);
    const getPct = (val) => (val / max * 100).toFixed(1);
    
    const barsHtml = `
        <div class="mb-2"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Male</span><span>${genders.Male}</span></div>
        <div class="h-2 bg-[#2b2d31] rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width: ${getPct(genders.Male)}%"></div></div></div>
        
        <div class="mb-2"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Female</span><span>${genders.Female}</span></div>
        <div class="h-2 bg-[#2b2d31] rounded-full overflow-hidden"><div class="h-full bg-pink-500" style="width: ${getPct(genders.Female)}%"></div></div></div>
        
        <div class="mb-2"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Alien</span><span>${genders.Alien}</span></div>
        <div class="h-2 bg-[#2b2d31] rounded-full overflow-hidden"><div class="h-full bg-green-500" style="width: ${getPct(genders.Alien)}%"></div></div></div>
        
        <div class="mb-2"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Other</span><span>${genders.Other}</span></div>
        <div class="h-2 bg-[#2b2d31] rounded-full overflow-hidden"><div class="h-full bg-gray-500" style="width: ${getPct(genders.Other)}%"></div></div></div>
    `;
    document.getElementById('gender-bars').innerHTML = barsHtml;

    // Rank Stats
    const ranks = {};
    let totalCoins = 0;
    users.forEach(u => {
        const r = u.rank || 'Member';
        ranks[r] = (ranks[r] || 0) + 1;
        totalCoins += (u.coins || 0);
    });
    
    document.getElementById('stat-economy').textContent = totalCoins.toLocaleString();

    let rankHtml = '';
    Object.entries(ranks).sort((a,b) => b[1] - a[1]).forEach(([r, count]) => {
        rankHtml += `<div class="flex justify-between items-center text-sm p-2 bg-[#111214] rounded border border-[#2b2d31] mb-1">
            <span class="font-bold text-gray-300">${r}</span>
            <span class="bg-[#2b2d31] px-2 rounded text-xs text-white">${count}</span>
        </div>`;
    });
    document.getElementById('rank-list').innerHTML = rankHtml;
}

function renderUsersTable(users) {
    const tbody = document.getElementById('users-table-body');
    const search = document.getElementById('user-search').value.toLowerCase();
    
    const filtered = users.filter(u => 
        (u.username && u.username.toLowerCase().includes(search)) || 
        (u.email && u.email.toLowerCase().includes(search))
    );
    
    document.getElementById('user-count').textContent = `${filtered.length} Users Found`;
    
    if(filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No users found.</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.slice(0, 50).map(u => `
        <tr class="hover:bg-[#2b2d31] border-b border-[#2b2d31] transition table-row-anim">
            <td class="p-3 flex items-center gap-3">
                <img src="${u.pfpUrl || 'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full bg-gray-700 object-cover">
                <div>
                    <div class="font-bold text-white text-sm">${u.username}</div>
                    <div class="text-[10px] text-gray-500">${u.email}</div>
                </div>
            </td>
            <td class="p-3 text-sm text-gray-300">${u.rank || 'Member'}</td>
            <td class="p-3 text-xs text-gray-400">
                <div>${(u.coins||0).toLocaleString()} <span class="text-yellow-500">C</span></div>
                <div>${(u.gems||0).toLocaleString()} <span class="text-purple-400">G</span></div>
            </td>
            <td class="p-3 text-xs">
                ${u.banned ? '<span class="text-red-500 font-bold">BANNED</span>' : (u.status === 'online' ? '<span class="text-green-400">Online</span>' : '<span class="text-gray-500">Offline</span>')}
            </td>
            <td class="p-3 text-right">
                <button onclick="admin.openUserModal('${u.uid}')" class="bg-[#5865F2] hover:bg-[#4752c4] text-white px-3 py-1 rounded text-xs font-bold transition">Manage</button>
            </td>
        </tr>
    `).join('');
}

function renderRoomsGrid(docs) {
    const grid = document.getElementById('rooms-grid');
    if (docs.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-gray-500">No active rooms.</div>';
        return;
    }
    grid.innerHTML = docs.map(d => {
        const r = d.data();
        return `
        <div class="glass-panel p-4 rounded-lg flex justify-between items-center group">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="w-10 h-10 bg-[#111214] rounded flex items-center justify-center text-xl shrink-0">${r.icon && !r.icon.startsWith('http') ? r.icon : '#'}</div>
                <div class="min-w-0">
                    <div class="font-bold text-white text-sm truncate">${r.name}</div>
                    <div class="text-[10px] text-gray-500">${r.isPrivate ? 'Private' : 'Public'} â€¢ ${new Date(r.createdAt?.seconds*1000).toLocaleDateString()}</div>
                </div>
            </div>
            <button onclick="admin.deleteRoom('${d.id}')" class="text-red-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
        </div>
        `;
    }).join('');
}

window.admin = {
    switchTab: (tab) => {
        ['dashboard','users','rooms','logs','tools'].forEach(t => {
            document.getElementById(`view-${t}`).classList.add('hidden');
            document.getElementById(`nav-${t}`).classList.remove('bg-[#5865F2]', 'text-white');
            document.getElementById(`nav-${t}`).classList.add('text-gray-400');
        });
        document.getElementById(`view-${tab}`).classList.remove('hidden');
        document.getElementById(`nav-${tab}`).classList.add('bg-[#5865F2]', 'text-white');
        document.getElementById(`nav-${tab}`).classList.remove('text-gray-400');
        document.getElementById('page-title').textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
        
        if (tab === 'logs') admin.startLogStream();
    },
    refreshUsers: () => {
        renderUsersTable(allUsersCache);
    },
    openUserModal: async (uid) => {
        const u = allUsersCache.find(x => x.uid === uid);
        if(!u) return;
        document.getElementById('modal-uid').value = uid;
        document.getElementById('modal-user-title').textContent = `Manage ${u.username}`;
        document.getElementById('modal-rank-select').value = u.rank || 'Member';
        
        const btnBan = document.getElementById('btn-modal-ban');
        btnBan.textContent = u.banned ? 'Unban User' : 'Ban User';
        btnBan.className = u.banned ? "py-2 bg-green-600/20 text-green-400 border border-green-600/50 rounded font-bold text-sm" : "py-2 bg-red-600/20 text-red-400 border border-red-600/50 rounded font-bold text-sm";
        
        const btnMute = document.getElementById('btn-modal-mute');
        btnMute.textContent = u.muted ? 'Unmute User' : 'Mute User';
        
        document.getElementById('admin-user-modal').classList.remove('hidden');
    },
    saveModalRank: async () => {
        const uid = document.getElementById('modal-uid').value;
        const rank = document.getElementById('modal-rank-select').value;
        await updateDoc(doc(db, "users", uid), { rank });
        alert("Rank Updated");
        document.getElementById('admin-user-modal').classList.add('hidden');
    },
    modalAction: async (type) => {
        const uid = document.getElementById('modal-uid').value;
        const ref = doc(db, "users", uid);
        const u = allUsersCache.find(x => x.uid === uid);
        
        if (type === 'ban') {
            await updateDoc(ref, { banned: !u.banned });
            alert(u.banned ? "User Unbanned" : "User Banned");
        } else if (type === 'kick') {
            await updateDoc(ref, { kickedAt: serverTimestamp() });
            alert("User Kicked");
        } else if (type === 'mute') {
            await updateDoc(ref, { muted: !u.muted });
            alert(u.muted ? "User Unmuted" : "User Muted");
        } else if (type === 'reset') {
            if(confirm("Reset nickname and bio?")) {
                await updateDoc(ref, { username: "Reset_User_" + Math.floor(Math.random()*1000), bio: "" });
                alert("Reset");
            }
        }
        document.getElementById('admin-user-modal').classList.add('hidden');
    },
    deleteRoom: async (id) => {
        if(confirm("Delete this room permanently?")) {
            await deleteDoc(doc(db, "rooms", id));
        }
    },
    startLogStream: () => {
        if (unsubscribeLogs) return;
        const term = document.getElementById('logs-terminal');
        const q = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(50));
        unsubscribeLogs = onSnapshot(q, (snap) => {
            term.innerHTML = '';
            const msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.reverse().forEach(m => {
                const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString() : '...';
                const div = document.createElement('div');
                div.className = "text-xs font-mono border-b border-white/5 py-1";
                div.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="text-blue-400 font-bold">${m.username}:</span> <span class="text-gray-300">${m.text ? m.text.substring(0, 100) : '[Media/Game]'}</span>`;
                term.appendChild(div);
            });
            term.scrollTop = term.scrollHeight;
        });
    },
    sendBroadcast: async () => {
        const text = document.getElementById('broadcast-text').value;
        if (!text) return;
        await addDoc(collection(db, "messages"), {
            text: text,
            uid: "SYSTEM",
            username: "SYSTEM",
            pfpUrl: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExMXBhNjNycTQweDFkY214NjMxYWtiZWs1ZjZ3dTJxb254d21ldHIyOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/HPbuRgMPF2vL2/giphy.gif",
            rank: "Developer",
            createdAt: serverTimestamp(),
            messageStyle: { color: "#ff5555" }
        });
        document.getElementById('broadcast-text').value = '';
        alert("Broadcast Sent");
    },
    giveCurrency: async () => {
        const name = document.getElementById('stimulus-username').value.trim();
        const amt = parseInt(document.getElementById('stimulus-amount').value);
        const curr = document.getElementById('stimulus-currency').value;
        
        if (!amt) return alert("Invalid amount");
        
        if (!name) {
            // ALL USERS (Limit to batch size or just warn)
            if(!confirm(`Give ${amt} ${curr} to ALL users? This might take a moment.`)) return;
            // For demo, just doing top 50 to avoid freeze
            const batch = writeBatch(db);
            allUsersCache.slice(0, 400).forEach(u => {
                const ref = doc(db, "users", u.uid);
                batch.update(ref, { [curr]: (u[curr]||0) + amt });
            });
            await batch.commit();
            alert("Stimulus Distributed");
        } else {
            const u = allUsersCache.find(x => x.username === name);
            if(!u) return alert("User not found");
            await updateDoc(doc(db, "users", u.uid), { [curr]: (u[curr]||0) + amt });
            alert("Sent");
        }
    },
    addFilterWord: () => {
        const w = document.getElementById('filter-word').value.trim();
        if(w) {
            // In a real app, save to DB. Visual demo here.
            const sp = document.createElement('span');
            sp.className = "px-2 py-1 bg-red-900/30 text-red-400 rounded border border-red-900 text-xs";
            sp.textContent = w;
            document.getElementById('filter-list').appendChild(sp);
            document.getElementById('filter-word').value = '';
        }
    }
};

// Search listener
document.getElementById('user-search').addEventListener('input', () => renderUsersTable(allUsersCache));

</script>
</body>
</html>
